

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TianQin Python SDK 3.4.10 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/baidu.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html#document-index" class="icon icon-home"> TianQin Python SDK
          

          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-intro">TqSdk 介绍</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">TqSdk是什么</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">系统架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">功能要点</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#linear-framework">编程风格</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#license">License</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-quickstart">十分钟快速入门</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#tqsdk-install">安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#quickstart-0">注册快期账户</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#quickstart-1">获取实时行情数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#k">使用K线数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#quickstart-2-web-gui">生成图形化界面</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#quickstart-3">交易账户, 下单/撤单</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#quickstart-4">构建一个自动交易程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#quickstart-5">按照目标持仓自动交易</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#quickstart-backtest">策略回测</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#real-trading">实盘交易</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#sim-trading">模拟交易和论坛</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id16">TqSdk 学习视频</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id18">更多内容</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-usage/index">使用TqSdk</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-usage/framework">策略程序结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-usage/shinny_account">快期账户</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-usage/mddatas">合约, 行情和历史数据</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-usage/ta">技术指标与序列计算函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-usage/trade">账户与交易</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-usage/option_trade">期权交易 &amp; 交易所官方组合</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-usage/targetpostask">交易辅助工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-usage/backtest">策略程序回测</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-usage/web_gui">策略程序图形化界面</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-demo/index">示例程序</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-demo/base">基本使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-demo/option_base">期权基本使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-demo/algorithm">算法模块示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-demo/strategy">交易策略示例</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-reference/index">TqSdk 模块参考</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.api">tqsdk.TqApi - 框架及核心业务</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.auth">tqsdk.TqAuth - 用户认证类</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.account">tqsdk.TqAccount - 实盘账户类</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.tqkq">tqsdk.TqKq - 快期模拟交易类</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tqsdk-tqkqstock">tqsdk.TqKqStock - 快期股票模拟交易类</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.sim">tqsdk.TqSim - 本地模拟交易</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tqsdk-tqsimstock">tqsdk.TqSimStock - 本地股票模拟交易</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.multiaccount">tqsdk.TqMultiAccount - 多账户</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.objs">tqsdk.objs - 业务对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.lib">tqsdk.lib - 业务工具库</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.ta">tqsdk.ta - 技术指标计算函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.tafunc">tqsdk.tafunc - 序列计算函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.backtest">tqsdk.TqBacktest - 策略回测</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.algorithm">tqsdk.algorithm - 算法模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.risk_rule">tqsdk.risk_rule - 风控类模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.tools.download">tqsdk.tools.DataDownloader - 数据下载工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-reference/tqsdk.exceptions">tqsdk.exceptions - 抛出例外</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-advanced/index">进阶主题</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/order">高级委托指令</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/backtest">批量回测, 参数搜索及其它</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/multi_strategy">交易策略的多实例运行</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/gui">与Gui库共同工作</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/dingding">将程序信息推送到手机端</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/for_vnpy_user">TqSdk 与 vn.py 有哪些差别</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/for_ctp_user">TqSdk与使用Ctp接口开发策略程序有哪些差别</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/unanttended">在无人监控环境下执行策略</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/targetpostask2">TargetPosTask 高级功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/scheduler">基于时间维度目标持仓策略</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-advanced/tqsdk2ctptest">在 TqSdk 中调用 TqSdk2 查询保证金</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-dev/index">参与TqSdk开发</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-dev/general">原则与规范</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-dev/framework">TqSdk整体结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-dev/async_tool">异步工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-dev/gui">Web Gui</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-dev/backtest">策略回测框架</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-dev/unittest">单元测试</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-profession">TqSdk 专业版</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">快期专业版产品使用权限</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">更稳定的行情服务器</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id7">更多的实盘交易账户数</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">策略回测功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id11">股票行情</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#profession-tqkqstock">股票模拟交易</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id13">下载数据功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id14">其他相关函数</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id15">期权交易 &amp; 交易所组合</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id16">工作时间内的天勤客服支持</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-enterprise">TqSdk2 企业版</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">TqSdk2 直连功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tqjees">TqSdk2 连接资管平台功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tqrohon">TqSdk2 连接资管平台功能</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-qa">天勤用户论坛</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-version">版本变更</a></li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html#document-index">TianQin Python SDK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html#document-index">Docs</a> &raquo;</li>
        
      <li>TianQin Python SDK 3.4.10 documentation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/shinnytech/tqsdk-python/blob/master/doc/index.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <a class="reference internal image-reference" href="_images/logo.png"><img alt="_images/logo.png" class="align-center" src="_images/logo.png" style="width: 600px;" /></a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<section id="tianqin-python-sdk-user-guide">
<span id="pysdk"></span><h1>TianQin Python Sdk User Guide<a class="headerlink" href="#tianqin-python-sdk-user-guide" title="Permalink to this headline">¶</a></h1>
<p>本文档是 TqSdk 的使用说明. 从 TqSdk 中的一些关键概念开始, 逐步介绍如何充分利用 TqSdk 全部功能。</p>
<div class="toctree-wrapper compound">
<span id="document-intro"></span><section id="tqsdk">
<span id="intro"></span><h2>TqSdk 介绍<a class="headerlink" href="#tqsdk" title="Permalink to this headline">¶</a></h2>
<section id="id1">
<h3>TqSdk是什么<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 是一个由 <a class="reference external" href="https://www.shinnytech.com">信易科技</a> 发起并贡献主要代码的开源 python 库.
依托 <a class="reference external" href="https://www.shinnytech.com/diff">快期多年积累成熟的交易及行情服务器体系</a> , TqSdk 支持用户使用很少的代码量构建各种类型的量化交易策略程序,
并提供包含 历史数据-实时数据-开发调试-策略回测-模拟交易-实盘交易-运行监控-风险管理 的全套解决方案:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqAccount</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqAccount</span><span class="p">(</span><span class="s2">&quot;H海通期货&quot;</span><span class="p">,</span> <span class="s2">&quot;4003242&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>      <span class="c1"># 创建 TqApi 实例, 指定交易账户</span>
<span class="n">q_1910</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.rb1910&quot;</span><span class="p">)</span>                         <span class="c1"># 订阅近月合约行情</span>
<span class="n">t_1910</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb1910&quot;</span><span class="p">)</span>                    <span class="c1"># 创建近月合约调仓工具</span>
<span class="n">q_2001</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2001&quot;</span><span class="p">)</span>                         <span class="c1"># 订阅远月合约行情</span>
<span class="n">t_2001</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb2001&quot;</span><span class="p">)</span>                    <span class="c1"># 创建远月合约调仓工具</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                                           <span class="c1"># 等待数据更新</span>
  <span class="n">spread</span> <span class="o">=</span> <span class="n">q_1910</span><span class="o">.</span><span class="n">last_price</span> <span class="o">-</span> <span class="n">q_2001</span><span class="o">.</span><span class="n">last_price</span>        <span class="c1"># 计算近月合约-远月合约价差</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前价差:&quot;</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;价差过高: 空近月，多远月&quot;</span><span class="p">)</span>
    <span class="n">t_1910</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>                              <span class="c1"># 要求把1910合约调整为空头1手</span>
    <span class="n">t_2001</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                               <span class="c1"># 要求把2001合约调整为多头1手</span>
  <span class="k">elif</span> <span class="n">spread</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;价差回复: 清空持仓&quot;</span><span class="p">)</span>                               <span class="c1"># 要求把 1910 和 2001合约都调整为不持仓</span>
    <span class="n">t_1910</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">t_2001</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>要快速了解如何使用TqSdk, 可以访问我们的 <a class="reference internal" href="index.html#quickstart"><span class="std std-ref">十分钟快速入门</span></a></p>
</section>
<section id="id4">
<h3>系统架构<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="761px" viewBox="-0.5 -0.5 761 221" style="max-width:100%;max-height:221px;"><defs/><g><path d="M 620 60 L 620 40" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><a xlink:href="https://github.com/shinnytech/open-md-gateway"><rect x="480" y="60" width="280" height="40" fill="none" stroke="#d6b656"/><g transform="translate(569.5,66.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="100" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 102px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div><a href="https://github.com/shinnytech/open-md-gateway">Open Md Gateway</a></div><div><a href="https://github.com/shinnytech/open-md-gateway">行情网关</a></div></div></div></foreignObject><text x="50" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><a xlink:href="https://github.com/shinnytech/open-trade-gateway"><rect x="0" y="60" width="280" height="40" fill="none" stroke="#d6b656"/><g transform="translate(82.5,66.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="114" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 116px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="https://github.com/shinnytech/open-trade-gateway">Open Trade Gateway<br />交易中继网关</a><br /></div></div></foreignObject><text x="57" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><rect x="0" y="0" width="280" height="40" fill="none" stroke="#36393d"/><g transform="translate(84.5,6.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="110" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 110px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">期货公司交易系统<br />CTP / FEMAS / UFX<br /></div></div></foreignObject><text x="55" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">期货公司交易系统&lt;br&gt;CTP / FEMAS / UFX&lt;br&gt;</text></switch></g><rect x="480" y="0" width="280" height="40" fill="none" stroke="#36393d"/><g transform="translate(577.5,13.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 85px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">交易所行情系统<br /></div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">交易所行情系统&lt;br&gt;</text></switch></g><path d="M 140 60 L 140 40" fill="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 380 120 L 140 100" fill="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 380 120 L 620 100" fill="none" stroke="#000000" stroke-miterlimit="10"/><a xlink:href="http://doc.shinnytech.com/diff/latest/"><rect x="0" y="120" width="760" height="40" rx="6" ry="6" fill="none" stroke="#b85450"/><g transform="translate(352.5,133.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="54" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 55px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="https://github.com/shinnytech/diff">DIFF 协议</a></div></div></foreignObject><text x="27" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><path d="M 380 180 L 380 160" fill="none" stroke="#000000" stroke-miterlimit="10"/><a xlink:href="https://github.com/shinnytech/tqsdk-python"><rect x="320" y="180" width="120" height="40" fill="#dae8fc" stroke="#6c8ebf"/><g transform="translate(362.5,193.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="34" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="https://github.com/shinnytech/tqsdk-python">TqSdk</a><br /></div></div></foreignObject><text x="17" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a></g></svg><ul class="simple">
<li><p><a class="reference external" href="https://github.com/shinnytech/open-md-gateway">行情网关 (Open Md Gateway)</a> 负责提供实时行情和历史数据</p></li>
<li><p><a class="reference external" href="https://github.com/shinnytech/open-trade-gateway">交易中继网关 (Open Trade Gateway)</a> 负责连接到期货公司交易系统</p></li>
<li><p>这两个网关统一以 <a class="reference external" href="https://doc.shinnytech.com/diff/latest">Diff协议</a> 对下方提供服务</p></li>
<li><p>TqSdk按照Diff协议连接到行情网关和交易中继网关, 实现行情和交易功能</p></li>
</ul>
</section>
<section id="id5">
<h3>功能要点<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 提供的功能可以支持从简单到复杂的各类策略程序.</p>
<ul class="simple">
<li><p>提供当前所有可交易合约从上市开始的 <strong>全部Tick数据和K线数据</strong></p></li>
<li><p>支持数十家期货公司的 <strong>实盘交易</strong></p></li>
<li><p>支持 <strong>模拟交易</strong></p></li>
<li><p>支持 <strong>Tick级和K线级回测</strong>, 支持 <strong>复杂策略回测</strong></p></li>
<li><p>提供近百个 <strong>技术指标函数及源码</strong></p></li>
<li><p>用户无须建立和维护数据库, 行情和交易数据全在 <strong>内存数据库</strong> , 无访问延迟</p></li>
<li><p>优化支持 <strong>pandas</strong> 和 <strong>numpy</strong> 库</p></li>
<li><p>无强制框架结构, 支持任意复杂度的策略, 在一个交易策略程序中使用多个品种的K线/实时行情并交易多个品种</p></li>
</ul>
</section>
<section id="linear-framework">
<span id="id6"></span><h3>编程风格<a class="headerlink" href="#linear-framework" title="Permalink to this headline">¶</a></h3>
<p>TqSdk使用单线程异步模型, 它支持构建各类复杂结构的策略程序, 同时保持高性能及高可读性. 要了解 TqSdk 的编程框架, 请参见 <a class="reference internal" href="index.html#framework"><span class="std std-ref">策略程序结构</span></a></p>
<p>如果您曾经使用并熟悉过其它量化交易开发工具, 这些文件可以帮助您尽快了解TqSdk与它们的差异:</p>
<ul class="simple">
<li><p><a class="reference internal" href="index.html#for-ctp-user"><span class="std std-ref">TqSdk与使用Ctp接口开发策略程序有哪些差别</span></a></p></li>
<li><p><a class="reference internal" href="index.html#for-vnpy-user"><span class="std std-ref">TqSdk 与 vn.py 有哪些差别</span></a></p></li>
</ul>
</section>
<section id="license">
<h3>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 在 Apache License 2.0 协议下提供, 使用者可在遵循此协议的前提下自由使用本软件.</p>
</section>
</section>
<span id="document-quickstart"></span><section id="quickstart">
<span id="id1"></span><h2>十分钟快速入门<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h2>
<p>希望快速开始使用天勤量化(TqSdk)？  本页面将介绍如何开始使用 TqSdk.</p>
<p>如果您以前曾经使用过其它框架编写过策略程序, 这些内容可以快速帮助您了解 TqSdk 与它们的区别:</p>
<ul class="simple">
<li><p><a class="reference internal" href="index.html#intro"><span class="std std-ref">TqSdk 介绍</span></a></p></li>
<li><p><a class="reference internal" href="index.html#for-ctp-user"><span class="std std-ref">TqSdk与使用Ctp接口开发策略程序有哪些差别</span></a></p></li>
<li><p><a class="reference internal" href="index.html#for-vnpy-user"><span class="std std-ref">TqSdk 与 vn.py 有哪些差别</span></a></p></li>
</ul>
<p>注意: TqSdk 使用了 python3 的原生协程和异步通讯库 asyncio，部分 Python IDE 不支持 asyncio，例如:</p>
<ul class="simple">
<li><p>spyder: 详见 <a class="reference external" href="https://github.com/spyder-ide/spyder/issues/7096">https://github.com/spyder-ide/spyder/issues/7096</a></p></li>
<li><p>jupyter: 详见 <a class="reference external" href="https://github.com/jupyter/notebook/issues/3397">https://github.com/jupyter/notebook/issues/3397</a></p></li>
</ul>
<p>可以直接运行示例代码，或使用支持 asyncio 的 IDE (例如: pycharm / vscode)</p>
<section id="tqsdk-install">
<span id="id2"></span><h3>安装<a class="headerlink" href="#tqsdk-install" title="Permalink to this headline">¶</a></h3>
<p>天勤量化的核心是TqSdk开发包, 在安装天勤量化 (TqSdk) 前, 你需要先准备适当的环境和Python包管理工具, 包括:</p>
<ul class="simple">
<li><p>Python &gt;=3.6.4,3.7,3.8,3.9 版本</p></li>
<li><p>Windows 7 以上版本, Mac Os, 或 Linux</p></li>
</ul>
<p>你可以选择使用 <cite>pip</cite> 命令安装 TqSdk, 或者下载源代码安装. 对于一般用户, 我们推荐采用 <cite>pip</cite> 命令安装/升级 TqSdk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">tqsdk</span> <span class="o">-</span><span class="n">U</span>
</pre></div>
</div>
<p>但是由于 <cite>pip</cite> 使用的是国外的服务器，普通用户往往下载速度过慢或不稳定，对于使用 <cite>pip</cite> 命令下载速度较慢的用户，我们推荐采用切换国内源的方式安装/升级 TqSdk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">tqsdk</span> <span class="o">-</span><span class="n">U</span> <span class="o">-</span><span class="n">i</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">pypi</span><span class="o">.</span><span class="n">tuna</span><span class="o">.</span><span class="n">tsinghua</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">simple</span> <span class="o">--</span><span class="n">trusted</span><span class="o">-</span><span class="n">host</span><span class="o">=</span><span class="n">pypi</span><span class="o">.</span><span class="n">tuna</span><span class="o">.</span><span class="n">tsinghua</span><span class="o">.</span><span class="n">edu</span><span class="o">.</span><span class="n">cn</span>
</pre></div>
</div>
</section>
<section id="quickstart-0">
<span id="id3"></span><h3>注册快期账户<a class="headerlink" href="#quickstart-0" title="Permalink to this headline">¶</a></h3>
<p>在使用 TqSdk 之前，用户需要先注册自己的 <strong>快期账户</strong> ，传入快期账户是使用任何 TqSdk 程序的前提,点击  <a class="reference external" href="https://account.shinnytech.com/">注册快期账户</a></p>
<p>快期账户可以使用注册时的手机号/用户名/邮箱号进行登录,详细介绍请点击 <a class="reference internal" href="index.html#shinny-account"><span class="std std-ref">快期账户</span></a></p>
<p>在注册完快期账户后，让我们从一个简单的例子开始</p>
</section>
<section id="quickstart-1">
<span id="id5"></span><h3>获取实时行情数据<a class="headerlink" href="#quickstart-1" title="Permalink to this headline">¶</a></h3>
<p>通过 TqSdk 获取实时行情数据是很容易的.</p>
<p>首先, 必须引入 tqsdk 模块:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
</pre></div>
</div>
<p>创建API实例，并填入自己的快期账户:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>获得上期所 ni2206 合约的行情引用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.ni2206&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>现在, 我们获得了一个对象 quote. 这个对象总是指向 SHFE.ni2206 合约的最新行情. 我们可以通过 quote 的各个字段访问行情数据:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
</pre></div>
</div>
<p>要等待行情数据更新, 我们还需要一些代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 是一个阻塞函数, 程序在这行上等待, 直到收到数据包才返回.</p>
<p>上面这个例子的完整程序请见 <a class="reference internal" href="index.html#tutorial-t10"><span class="std std-ref">t10 - 获取实时行情</span></a> . 你也可以在自己电脑python安装目录的 site_packages/tqsdk/demo 下找到它</p>
<p>很简单, 对吗? 到这里, 你已经了解用 TqSdk 开发程序的几个关键点:</p>
<ul class="simple">
<li><p>创建 TqApi 实例</p></li>
<li><p>用 api.get_quote() 或 其它函数获取数据引用对象</p></li>
<li><p>在循环中用 api.wait_update() 等待数据包.</p></li>
<li><p>收到数据包以后通过引用对象获得所需数据</p></li>
</ul>
<p>下面我们将继续介绍 TqSdk 更多的功能. 无论使用哪个功能函数, 都遵循上面的结构.</p>
</section>
<section id="k">
<span id="quickstart-2"></span><h3>使用K线数据<a class="headerlink" href="#k" title="Permalink to this headline">¶</a></h3>
<p>你很可能会需要合约的K线数据. 在TqSdk中, 你可以很方便的获得K线数据. 我们来请求 ni2206 合约的10秒线:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.ni2206&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>klines是一个pandas.DataFrame对象. 跟 api.get_quote() 一样, api.get_kline_serial() 也是返回K线序列的引用对象. K线序列数据也会跟实时行情一起同步自动更新. 你也同样需要用 api.wait_update() 等待数据刷新.</p>
<p>一旦k线数据收到, 你可以通过 klines 访问 k线数据:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最后一根K线收盘价&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>这部分的完整示例程序请见 <a class="reference internal" href="index.html#tutorial-t30"><span class="std std-ref">t30 - 使用K线/Tick数据</span></a> .</p>
<p>我们也可以通过传入一个合约列表作为参数，来获取包含多个合约数据的K线:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">([</span><span class="s2">&quot;SHFE.au1912&quot;</span><span class="p">,</span> <span class="s2">&quot;SHFE.au2006&quot;</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 获取SHFE.au2006向SHFE.au1912对齐的K线</span>
</pre></div>
</div>
<p>详细使用方法及说明请见 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code> 函数说明。</p>
<p>到这里为止, 你已经知道了如何获取实时行情和K线数据, 下面一段将介绍如何访问你的交易账户并发送交易指令</p>
</section>
<section id="quickstart-2-web-gui">
<span id="id6"></span><h3>生成图形化界面<a class="headerlink" href="#quickstart-2-web-gui" title="Permalink to this headline">¶</a></h3>
<p>如果想要将你订阅的K线或策略图形化显示, 只需在 <code class="xref py py-meth docutils literal notranslate"><span class="pre">TqApi()</span></code> 中传入参数 web_gui = True即可:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 引入TqSdk模块</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="c1"># 创建api实例，设置web_gui=True生成图形化界面</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 订阅 ni2010 合约的10秒线</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.ni2010&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># 通过wait_update刷新数据</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
<p>当你运行该程序后，预期会显示如下两条信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>2019-12-13 10:45:26,468 - INFO - 您可以访问 http://127.0.0.1:62964 查看策略绘制出的 K 线图形。
2019-12-13 10:45:27,422 - INFO - 通知: 与 wss://openmd.shinnytech.com/t/md/front/mobile 的网络连接已建立
</pre></div>
</div>
<p>点击生成的地址，即可访问订阅的K线图形</p>
<figure class="align-default">
<img alt="_images/web_gui_demo.png" src="_images/web_gui_demo.png" />
</figure>
<p>具体请见 <a class="reference internal" href="index.html#web-gui"><span class="std std-ref">策略程序图形化界面</span></a></p>
</section>
<section id="quickstart-3">
<span id="id7"></span><h3>交易账户, 下单/撤单<a class="headerlink" href="#quickstart-3" title="Permalink to this headline">¶</a></h3>
<p>要获得你的账户资金情况, 可以请求一个资金账户引用对象:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">account</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
</pre></div>
</div>
<p>要获得你交易账户中某个合约的持仓情况, 可以请求一个持仓引用对象:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="s2">&quot;DCE.m1901&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>与行情数据一样, 它们也通过 api.wait_update() 获得更新, 你也同样可以访问它们的成员变量:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;可用资金: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">available</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;今多头: </span><span class="si">%d</span><span class="s2"> 手&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">volume_long_today</span><span class="p">))</span>
</pre></div>
</div>
<p>要在交易账户中发出一个委托单, 使用 api.insert_order() 函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;DCE.m2105&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
</pre></div>
</div>
<p>这个函数调用后会立即返回, order 是一个指向此委托单的引用对象, 你总是可以通过它的成员变量来了解委托单的最新状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;委托单状态: </span><span class="si">%s</span><span class="s2">, 已成交: </span><span class="si">%d</span><span class="s2"> 手&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">volume_orign</span> <span class="o">-</span> <span class="n">order</span><span class="o">.</span><span class="n">volume_left</span><span class="p">))</span>
</pre></div>
</div>
<p>要撤销一个委托单, 使用 api.cancel_order() 函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</pre></div>
</div>
<p>这部分的完整示例程序请见 <a class="reference internal" href="index.html#tutorial-t40"><span class="std std-ref">t40 - 下单/撤单</span></a> .</p>
<p>到这里为止, 我们已经掌握了 TqSdk 中行情和交易相关功能的基本使用. 我们将在下一节中, 组合使用它们, 创建一个自动交易程序</p>
</section>
<section id="quickstart-4">
<span id="id8"></span><h3>构建一个自动交易程序<a class="headerlink" href="#quickstart-4" title="Permalink to this headline">¶</a></h3>
<p>在这一节中, 我们将创建一个简单的自动交易程序: 每当行情最新价高于最近15分钟均价时, 开仓买进. 这个程序是这样的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;DCE.m2105&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:])</span><span class="o">/</span><span class="mi">15</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;MA&quot;</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价大于MA: 市价开仓&quot;</span><span class="p">)</span>
            <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;DCE.m2105&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>上面的代码中出现了一个新函数 api.is_changing(). 这个函数用于判定指定对象是否在最近一次 wait_update 中被更新.</p>
<p>这部分的完整示例程序请见 <a class="reference internal" href="index.html#tutorial-t60"><span class="std std-ref">t60 - 单均线策略</span></a> .</p>
</section>
<section id="quickstart-5">
<span id="id9"></span><h3>按照目标持仓自动交易<a class="headerlink" href="#quickstart-5" title="Permalink to this headline">¶</a></h3>
<p>在某些场景中, 我们可能会发现, 自己写代码管理下单撤单是一件很麻烦的事情. 在这种情况下, 你可以使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">tqsdk.TargetPosTask</span></code>. 你只需要指定账户中预期应有的持仓手数, TqSdk 会自动通过一系列指令调整仓位直到达成目标. 请看例子:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建 ni2010 的目标持仓 task，该 task 负责调整 ni2010 的仓位到指定的目标仓位</span>
<span class="n">target_pos_near</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.ni2010&quot;</span><span class="p">)</span>
<span class="c1"># 创建 ni2011 的目标持仓 task，该 task 负责调整 ni2011 的仓位到指定的目标仓位</span>
<span class="n">target_pos_deferred</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.ni2011&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote_near</span><span class="p">)</span> <span class="ow">or</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote_deferred</span><span class="p">):</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">quote_near</span><span class="o">.</span><span class="n">last_price</span> <span class="o">-</span> <span class="n">quote_deferred</span><span class="o">.</span><span class="n">last_price</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前价差:&quot;</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标持仓: 空近月，多远月&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为正数表示多头，负数表示空头，0表示空仓</span>
            <span class="n">target_pos_near</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">target_pos_deferred</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">spread</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标持仓: 空仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos_near</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">target_pos_deferred</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>这部分的完整示例程序请见 <a class="reference internal" href="index.html#tutorial-t80"><span class="std std-ref">t80 - 价差回归策略</span></a> .</p>
</section>
<section id="quickstart-backtest">
<span id="id10"></span><h3>策略回测<a class="headerlink" href="#quickstart-backtest" title="Permalink to this headline">¶</a></h3>
<p>自己的交易程序写好以后, 我们总是希望在实盘运行前, 能先进行一下模拟测试. 要进行模拟测试, 只需要在创建TqApi实例时, 传入一个backtest参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>这样, 程序运行时就会按照 TqBacktest 指定的时间范围进行模拟交易测试, 并输出测试结果.</p>
<p>此外 TqSdk 同时还支持股票的回测交易，请见 <a class="reference internal" href="index.html#security-backtest"><span class="std std-ref">对股票合约进行回测</span></a></p>
<p>更多关于策略程序回测的详细信息, 请见 <a class="reference internal" href="index.html#backtest"><span class="std std-ref">策略程序回测</span></a></p>
</section>
<section id="real-trading">
<span id="id11"></span><h3>实盘交易<a class="headerlink" href="#real-trading" title="Permalink to this headline">¶</a></h3>
<p>要让策略程序在实盘账号运行, 请在创建TqApi时传入一个 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqAccount</span></code> , 填入 期货公司, 账号, 密码 和快期账户信息(使用前请先 import TqAccount):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqAccount</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqAccount</span><span class="p">(</span><span class="s2">&quot;H海通期货&quot;</span><span class="p">,</span> <span class="s2">&quot;412432343&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>更多关于实盘交易细节，请点击 <a class="reference internal" href="index.html#trade"><span class="std std-ref">账户与交易</span></a></p>
<p>目前支持的期货公司列表, 请点击查看: <a class="reference external" href="https://www.shinnytech.com/blog/tq-support-broker/">TqSdk支持的期货公司列表</a></p>
<p>注册快期账户，请点击 <a class="reference external" href="https://www.shinnytech.com/register-intro/">登录用户管理中心</a></p>
</section>
<section id="sim-trading">
<span id="id13"></span><h3>模拟交易和论坛<a class="headerlink" href="#sim-trading" title="Permalink to this headline">¶</a></h3>
<p>如果您需要使用能保存账户资金及持仓信息的模拟交易功能, 请点击 <a class="reference external" href="https://www.shinnytech.com/register-intro/">注册信易账号</a> ，填写完对应信息之后，并验证成功即可进入 <a class="reference external" href="https://forum.shinnytech.com/">用户论坛</a> .</p>
<figure class="align-default">
<img alt="_images/tq_register1.png" src="_images/tq_register1.png" />
</figure>
<p>刚刚注册完成的快期账户的【手机号】/【邮箱地址】/【用户名】和【密码】可以作为 快期模拟 账号，通过 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqKq</span></code> 对 auth 传入参数进行登录，这个 快期模拟 账户在快期APP、快期V3 pro 和天勤量化上是互通的</p>
<p>快期模拟的资金可以通过快期APP、快期专业版的模拟银行进行出入金:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqKq</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqKq</span><span class="p">(),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>特别的，如果创建TqApi实例时没有提供任何 TqAcccount 账户或 TqKq 模块，则每次会自动创建一个临时模拟账号，当程序运行结束时，临时账号内的记录将全部丢失:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="id16">
<h3>TqSdk 学习视频<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 提供简单易懂的十分钟上手视频 <a class="reference external" href="https://www.shinnytech.com/tqsdkquickstart/">供用户学习</a></p>
</section>
<section id="id18">
<h3>更多内容<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>要完整了解TqSdk的使用, 请阅读 <a class="reference internal" href="index.html#usage"><span class="std std-ref">使用TqSdk</span></a></p></li>
<li><p>更多TqSdk的示例, 请见 <a class="reference internal" href="index.html#demo-strategy"><span class="std std-ref">交易策略示例</span></a></p></li>
</ul>
</section>
</section>
<span id="document-usage/index"></span><section id="tqsdk">
<span id="usage"></span><h2>使用TqSdk<a class="headerlink" href="#tqsdk" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-usage/framework"></span><section id="framework">
<span id="id1"></span><h3>策略程序结构<a class="headerlink" href="#framework" title="Permalink to this headline">¶</a></h3>
<section id="tqapi">
<h4>TqApi<a class="headerlink" href="#tqapi" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">tqsdk.TqApi</span></code> 是 TqSdk 的核心类. 通常情况下, 每个使用了 TqSdk 的程序都应该包括 <strong>一个</strong> TqApi 实例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>TqApi 实例负责:</p>
<ul class="simple">
<li><p>建立websocket连接到服务器.</p></li>
<li><p>在内存中建立数据存储区, 接收行情和交易业务数据包, 并自动维护数据更新.</p></li>
<li><p>发出交易指令.</p></li>
<li><p>管理协程任务.</p></li>
<li><p>执行策略回测.</p></li>
</ul>
<p>TqApi 创建时, 需要提供一个account参数. 它可以是:</p>
<ul class="simple">
<li><p>一个 <code class="xref py py-class docutils literal notranslate"><span class="pre">tqsdk.TqAccount</span></code> 实例: 使用实盘帐号, 直连行情和交易服务器, 需提供期货公司/帐号/密码</p></li>
<li><p>一个 <code class="xref py py-class docutils literal notranslate"><span class="pre">tqsdk.TqSim</span></code> 实例: 使用 Api 自带的模拟功能, 直连行情服务器接收行情数据</p></li>
<li><p>如果未提供 account 参数, 或者 account == None, 则会自动创建并使用一个 <code class="xref py py-class docutils literal notranslate"><span class="pre">tqsdk.TqSim</span></code> 实例</p></li>
</ul>
<p>此外还需要传入用户的快期账户，参见 <a class="reference internal" href="index.html#shinny-account"><span class="std std-ref">快期账户</span></a></p>
<p>TqApi 的其它构建参数请见 <code class="xref py py-class docutils literal notranslate"><span class="pre">tqsdk.TqApi</span></code></p>
</section>
<section id="wait-update">
<h4>关键函数: wait_update<a class="headerlink" href="#wait-update" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 是 TqApi 中最重要的一个函数. 每次调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 函数时将发生这些事:</p>
<ul class="simple">
<li><p>实际发出网络数据包. 例如, 策略程序用 insert_order 函数下单, 实际的报单指令是在 insert_order 后调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 时发出的</p></li>
<li><p>让正在运行中的后台任务获得动作机会．例如, 策略程序中创建了一个后台调仓任务, 这个任务只会在 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 时发出交易指令</p></li>
<li><p>尝试从服务器接收一个数据包, 并用收到的数据包更新内存中的业务数据截面.</p></li>
<li><p>如果没有收到数据包，则挂起等待，如果要避免长时间挂起，可通过设置 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 中的deadline参数，设置等待截止时间</p></li>
</ul>
<figure class="align-default">
<img alt="_images/wait_update.png" src="_images/wait_update.png" />
</figure>
<p>因此, TqSdk 要求策略程序必须反复调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code>, 才能保证整个程序正常运行. 一般会将 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 放在一个循环中反复调用
（注: 若跳出循环，程序结束前需调用 api.close() 释放资源):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>             <span class="c1">#一个循环</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>   <span class="c1">#总是调用 wait_update, 当数据有更新时 wait_update 函数返回, 执行下一句</span>
    <span class="n">do_some_thing</span><span class="p">()</span>     <span class="c1">#每当数据有变更时, 执行自己的代码, 然后循环回去再做下一次 wait_update</span>

<span class="c1">#注：若跳出循环并运行到程序末尾，在结束运行前需调用 api.close() 函数以关闭天勤接口实例并释放相应资源，请见下文 “一个典型程序的结构”</span>
</pre></div>
</div>
</section>
<section id="id2">
<h4>内存数据及数据更新<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>TqApi 实例内存中保存了一份完整业务数据截面, 包括行情/K线和交易账户数据. 这些数据可以通过 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqApi</span></code> 提供的数据引用函数获取，以获取资金账户为例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">account</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>  <span class="c1"># 获取账户信息引用</span>
<span class="nb">print</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">balance</span><span class="p">)</span>    <span class="c1"># 显示账户信息</span>
</pre></div>
</div>
<p>值得注意的是, get_account 返回资金账户的一个动态引用, 而不是具体的数值.
因此只需调用一次 get_account 得到 account 引用，之后任何时刻都可以使用 account.balance 获得最新的账户权益.
当 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 函数返回时业务截面即完成了从上一个时间截面推进到下一个时间截面。</p>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 会在任何数据更新时返回. 如果想知道 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 到底更新了哪些业务数据可以调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_changing()</span></code> 函数判断感兴趣的业务对象是否有更新，例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">account</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;账户变化&quot;</span><span class="p">)</span>                    <span class="c1">#任何资金账户中任意信息变化的时候打出 &quot;账户变化&quot;</span>

<span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="s2">&quot;balance&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;账户权益变化&quot;</span><span class="p">)</span>                    <span class="c1">#只有资金账户中的权益值变化的时候打出 &quot;账户权益变化&quot;</span>
</pre></div>
</div>
<dl class="simple">
<dt><strong>建议跨交易日重启代码</strong> ,否则可能导致:</dt><dd><ol class="arabic simple">
<li><p>合约信息不能及时更新（如：有新上市的合约,保持登录的第二个交易日就没有这个合约信息)</p></li>
<li><p>前一交易日的未成交委托单没有删除更新</p></li>
<li><p>如果使用了交易辅助工具 TargetPosTask 并且收盘后有挂单，导致 TargetPosTask 在下一交易日无法继续执行</p></li>
<li><p>其他未知问题.</p></li>
</ol>
</dd>
</dl>
</section>
<section id="id3">
<h4>一个典型程序的结构<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>以一个通常的策略流程为例：判断开仓条件，开仓，判断平仓条件，平仓，使用 TqSdk 写出的代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqSim</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.rb1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="s2">&quot;SHFE.rb1901&quot;</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb1901&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                 <span class="c1">#判断开仓条件的主循环</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                                       <span class="c1">#等待业务数据更新</span>
    <span class="k">if</span> <span class="n">开仓条件</span><span class="p">:</span>
        <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                     <span class="c1">#如果触发了，则通过 target_pos 将 SHFE.rb1901 的目标持仓设置为多头 1 手，具体的调仓工作则由 target_pos 在后台完成</span>
        <span class="k">break</span>                                               <span class="c1">#跳出开仓循环，进入下面的平仓循环</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                 <span class="c1">#判断平仓条件的主循环</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">平仓条件</span><span class="p">:</span>
        <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                     <span class="c1">#如果触发了，则通过 target_pos 将 SHFE.rb1901 的目标持仓设置为0手(即空仓)</span>
    <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                   <span class="c1">#如果已经将仓位平掉则跳出循环</span>
        <span class="k">break</span>
<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                                                 <span class="c1">#注意：程序结束运行前需调用此函数以关闭天勤接口实例并释放相应资源，同时此函数会包含发送最后一次wait_update信息传输</span>
<span class="c1">#至此就完成一次完整的开平仓流程，如果平仓后还需再判断开仓条件可以把开仓循环和平仓循环再套到一个大循环中。</span>
</pre></div>
</div>
</section>
</section>
<span id="document-usage/shinny_account"></span><section id="shinny-account">
<span id="id1"></span><h3>快期账户<a class="headerlink" href="#shinny-account" title="Permalink to this headline">¶</a></h3>
<p>在使用 TqSdk 之前，用户需要先注册自己的 <strong>快期账户</strong> ，传入快期账户是使用任何 TqSdk 程序的前提</p>
<p>如需注册，请点击  <a class="reference external" href="https://account.shinnytech.com/">注册快期账户</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<section id="id3">
<h4>用快期账户来模拟交易<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>注册完成的快期账户的【手机号】/【邮箱地址】/【用户名】和【密码】可以作为 快期模拟 账号，通过 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqKq</span></code> 对 auth 传入参数进行登录，这个 快期模拟 账户在快期APP、快期专业版  和天勤量化上是互通的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqKq</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqKq</span><span class="p">(),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="id4">
<h4>用快期账户来实盘交易<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>对于 TqSdk 免费版，每个快期账户支持最多绑定一个实盘账户，而天勤量化专业版支持一个快期账户绑定任意多个实盘账户</p>
<p>快期账户会在用户使用实盘账户时自动进行绑定，直到该快期账户没有能绑定实盘账户的名额(自动绑定功能需要 TqSdk 版本&gt; 1.8.3):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAccount</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqKq</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqAccount</span><span class="p">(</span><span class="s2">&quot;H海通期货&quot;</span><span class="p">,</span> <span class="s2">&quot;320102&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>如果需要注册快期账户或者修改您的快期账户绑定的实盘账户请参见  <a class="reference internal" href="#user-center"><span class="std std-ref">登录用户管理中心</span></a></p>
</section>
<section id="user-center">
<span id="id5"></span><h4>登录用户管理中心<a class="headerlink" href="#user-center" title="Permalink to this headline">¶</a></h4>
<p>点击 <a class="reference external" href="https://www.shinnytech.com/register-intro/">登录用户管理中心</a> ，可以注册快期账户或者修改您的快期账户绑定的实盘账户</p>
<p>登录成功后显示如下，在下方红框处,用户可以自行解绑/绑定实盘账户，其中解绑操作每天限定一次</p>
<figure class="align-default">
<img alt="_images/user_web_management1.png" src="_images/user_web_management1.png" />
</figure>
<p>如需一个快期账户支持更多的实盘账户，请联系工作人员进行批量购买 <a class="reference external" href="https://www.shinnytech.com/tqsdk_professional/">天勤量化专业版</a></p>
</section>
</section>
<span id="document-usage/mddatas"></span><section id="mddatas">
<span id="id1"></span><h3>合约, 行情和历史数据<a class="headerlink" href="#mddatas" title="Permalink to this headline">¶</a></h3>
<section id="id2">
<h4>合约代码<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>TqSdk中的合约代码, 统一采用 交易所代码.交易所内品种代码 的格式. 交易所代码为全大写字母, 交易所内品种代码的大小写规范, 遵从交易所规定, 大小写敏感.</p>
<p>其中 TqSdk 免费版本提供全部的期货、商品/金融期权和上证50、沪深300、中证500和中证1000的实时行情</p>
<p>购买或申请 TqSdk 专业版试用后可提供A股股票的实时和历史行情，具体免费版和专业版的区别，请点击 <a class="reference external" href="https://www.shinnytech.com/tqsdk_professional/">天勤量化专业版</a></p>
<p>目前 TqSdk 支持的交易所包括:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>CODE</p></th>
<th class="head"><p>NAME</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SHFE</p></td>
<td><p>上海期货交易所</p></td>
</tr>
<tr class="row-odd"><td><p>DCE</p></td>
<td><p>大连商品交易所</p></td>
</tr>
<tr class="row-even"><td><p>CZCE</p></td>
<td><p>郑州商品交易所</p></td>
</tr>
<tr class="row-odd"><td><p>CFFEX</p></td>
<td><p>中国金融交易所</p></td>
</tr>
<tr class="row-even"><td><p>INE</p></td>
<td><p>上海能源中心(原油在这里)</p></td>
</tr>
<tr class="row-odd"><td><p>KQ</p></td>
<td><p>快期 (所有主连合约, 指数都归属在这里)</p></td>
</tr>
<tr class="row-even"><td><p>SSWE</p></td>
<td><p>上期所仓单</p></td>
</tr>
<tr class="row-odd"><td><p>SSE</p></td>
<td><p>上海证券交易所</p></td>
</tr>
<tr class="row-even"><td><p>SZSE</p></td>
<td><p>深圳证券交易所</p></td>
</tr>
<tr class="row-odd"><td><p>GFEX</p></td>
<td><p>广州期货交易所</p></td>
</tr>
</tbody>
</table>
<p>一些合约代码示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SHFE</span><span class="o">.</span><span class="n">cu1901</span>  <span class="o">-</span>  <span class="n">上期所</span> <span class="n">cu1901</span> <span class="n">期货合约</span>
<span class="n">DCE</span><span class="o">.</span><span class="n">m1901</span>    <span class="o">-</span>  <span class="n">大商所</span> <span class="n">m1901</span> <span class="n">期货合约</span>
<span class="n">CZCE</span><span class="o">.</span><span class="n">SR901</span>   <span class="o">-</span>  <span class="n">郑商所</span> <span class="n">SR901</span> <span class="n">期货合约</span>
<span class="n">CFFEX</span><span class="o">.</span><span class="n">IF1901</span> <span class="o">-</span>  <span class="n">中金所</span> <span class="n">IF1901</span> <span class="n">期货合约</span>
<span class="n">INE</span><span class="o">.</span><span class="n">sc2109</span>   <span class="o">-</span>  <span class="n">上期能源</span> <span class="n">sc2109</span> <span class="n">期货合约</span>
<span class="n">GFEX</span><span class="o">.</span><span class="n">si2301</span>  <span class="o">-</span>  <span class="n">广期所</span> <span class="n">si2301</span> <span class="n">期货合约</span>

<span class="n">CZCE</span><span class="o">.</span><span class="n">SPD</span> <span class="n">SR901</span><span class="o">&amp;</span><span class="n">SR903</span>  <span class="o">-</span> <span class="n">郑商所</span> <span class="n">SR901</span><span class="o">&amp;</span><span class="n">SR903</span> <span class="n">跨期合约</span>
<span class="n">DCE</span><span class="o">.</span><span class="n">SP</span> <span class="n">a1709</span><span class="o">&amp;</span><span class="n">a1801</span>    <span class="o">-</span> <span class="n">大商所</span> <span class="n">a1709</span><span class="o">&amp;</span><span class="n">a1801</span> <span class="n">跨期合约</span>
<span class="n">GFEX</span><span class="o">.</span><span class="n">SP</span> <span class="n">si2308</span><span class="o">&amp;</span><span class="n">si2309</span> <span class="o">-</span> <span class="n">广期所</span> <span class="n">si2308</span><span class="o">&amp;</span><span class="n">si2309</span> <span class="n">跨期组合</span>

<span class="n">DCE</span><span class="o">.</span><span class="n">m1807</span><span class="o">-</span><span class="n">C</span><span class="o">-</span><span class="mi">2450</span>    <span class="o">-</span> <span class="n">大商所豆粕期权</span>
<span class="n">CZCE</span><span class="o">.</span><span class="n">CF003C11000</span>    <span class="o">-</span> <span class="n">郑商所棉花期权</span>
<span class="n">SHFE</span><span class="o">.</span><span class="n">au2004C308</span>     <span class="o">-</span> <span class="n">上期所黄金期权</span>
<span class="n">CFFEX</span><span class="o">.</span><span class="n">IO2002</span><span class="o">-</span><span class="n">C</span><span class="o">-</span><span class="mi">3550</span> <span class="o">-</span> <span class="n">中金所沪深300股指期权</span>
<span class="n">INE</span><span class="o">.</span><span class="n">sc2109C450</span>      <span class="o">-</span> <span class="n">上期能源原油期权</span>
<span class="n">GFEX</span><span class="o">.</span><span class="n">si2308</span><span class="o">-</span><span class="n">C</span><span class="o">-</span><span class="mi">5800</span>  <span class="o">-</span> <span class="n">广期所硅期权</span>


<span class="n">KQ</span><span class="o">.</span><span class="n">m</span><span class="nd">@CFFEX</span><span class="o">.</span><span class="n">IF</span> <span class="o">-</span> <span class="n">中金所IF品种主连合约</span>
<span class="n">KQ</span><span class="o">.</span><span class="n">i</span><span class="nd">@SHFE</span><span class="o">.</span><span class="n">bu</span> <span class="o">-</span> <span class="n">上期所bu品种指数</span>

<span class="n">SSWE</span><span class="o">.</span><span class="n">CUH</span> <span class="o">-</span> <span class="n">上期所仓单铜现货数据</span>

<span class="n">SSE</span><span class="mf">.600000</span> <span class="o">-</span> <span class="n">上交所浦发银行股票编码</span>
<span class="n">SZSE</span><span class="mf">.000001</span> <span class="o">-</span> <span class="n">深交所平安银行股票编码</span>
<span class="n">SSE</span><span class="mf">.000016</span> <span class="o">-</span> <span class="n">上证50指数</span>
<span class="n">SSE</span><span class="mf">.000300</span> <span class="o">-</span> <span class="n">沪深300指数</span>
<span class="n">SSE</span><span class="mf">.000905</span> <span class="o">-</span> <span class="n">中证500指数</span>
<span class="n">SSE</span><span class="mf">.000852</span> <span class="o">-</span> <span class="n">中证1000指数</span>
<span class="n">SSE</span><span class="mf">.510050</span> <span class="o">-</span> <span class="n">上交所上证50ETF</span>
<span class="n">SSE</span><span class="mf">.510300</span> <span class="o">-</span> <span class="n">上交所沪深300ETF</span>
<span class="n">SZSE</span><span class="mf">.159919</span> <span class="o">-</span> <span class="n">深交所沪深300ETF</span>
<span class="n">SSE</span><span class="mf">.10002513</span> <span class="o">-</span> <span class="n">上交所上证50ETF期权</span>
<span class="n">SSE</span><span class="mf">.10002504</span> <span class="o">-</span> <span class="n">上交所沪深300ETF期权</span>
<span class="n">SZSE</span><span class="mf">.90000097</span> <span class="o">-</span> <span class="n">深交所沪深300ETF期权</span>
<span class="n">SZSE</span><span class="mf">.159915</span> <span class="o">-</span> <span class="n">易方达创业板ETF</span>
<span class="n">SZSE</span><span class="mf">.90001277</span> <span class="o">-</span> <span class="n">创业板ETF期权</span>
<span class="n">SZSE</span><span class="mf">.159922</span> <span class="o">-</span> <span class="n">深交所中证500ETF</span>
<span class="n">SZSE</span><span class="mf">.90001355</span> <span class="o">-</span> <span class="n">深交所中证500ETF期权</span>
<span class="n">SSE</span><span class="mf">.510500</span> <span class="o">-</span> <span class="n">上交所中证500ETF</span>
<span class="n">SSE</span><span class="mf">.10004497</span> <span class="o">-</span> <span class="n">上交所中证500ETF期权</span>
<span class="n">SZSE</span><span class="mf">.159901</span> <span class="o">-</span> <span class="n">深交所100ETF</span>
</pre></div>
</div>
<p><strong>注意：并非所有合约都是可交易合约.</strong></p>
<p>需要注意郑商所的期货合约格式为合约字母大写，并且只有三位数字位，同时不同家交易所的期权代码格式也各不相同</p>
<p>天勤指数的计算方式为根据在市期货合约的昨持仓量加权平均</p>
<p>天勤主力的选定标准为该合约持仓量和成交量均为最大后，在下一个交易日开盘后进行切换，且切换后不会再切换到之前的合约</p>
</section>
<section id="id4">
<h4>实时行情<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_quote()</span></code> 函数提供实时行情和合约信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2201&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>返回值为一个dict, 结构如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-08-17 14:59:59.000001&quot;</span><span class="p">,</span>  <span class="c1"># 行情从交易所发出的时间(北京时间)</span>
    <span class="s2">&quot;ask_price1&quot;</span><span class="p">:</span> <span class="mf">69750.0</span><span class="p">,</span>  <span class="c1"># 卖一价</span>
    <span class="s2">&quot;ask_volume1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 卖一量</span>
    <span class="s2">&quot;bid_price1&quot;</span><span class="p">:</span> <span class="mf">69600.0</span><span class="p">,</span>  <span class="c1"># 买一价</span>
    <span class="s2">&quot;bid_volume1&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 买一量</span>
    <span class="s2">&quot;ask_price2&quot;</span><span class="p">:</span> <span class="mf">69920.0</span><span class="p">,</span>  <span class="c1"># 卖二价</span>
    <span class="s2">&quot;ask_volume2&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># 卖二量</span>
    <span class="s2">&quot;bid_price2&quot;</span><span class="p">:</span> <span class="mf">69500.0</span><span class="p">,</span>  <span class="c1"># 买二价</span>
    <span class="s2">&quot;bid_volume2&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># 买二量</span>
    <span class="s2">&quot;ask_price3&quot;</span><span class="p">:</span> <span class="mf">69940.0</span><span class="p">,</span>  <span class="c1"># 卖三价</span>
    <span class="s2">&quot;ask_volume3&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 卖三量</span>
    <span class="s2">&quot;bid_price3&quot;</span><span class="p">:</span> <span class="mf">69450.0</span><span class="p">,</span>  <span class="c1"># 买三价</span>
    <span class="s2">&quot;bid_volume3&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 买三量</span>
    <span class="s2">&quot;ask_price4&quot;</span><span class="p">:</span> <span class="mf">70010.0</span><span class="p">,</span>  <span class="c1"># 卖四价</span>
    <span class="s2">&quot;ask_volume4&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 卖四量</span>
    <span class="s2">&quot;bid_price4&quot;</span><span class="p">:</span> <span class="mf">69400.0</span><span class="p">,</span>  <span class="c1"># 买四价</span>
    <span class="s2">&quot;bid_volume4&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 买四量</span>
    <span class="s2">&quot;ask_price5&quot;</span><span class="p">:</span> <span class="mf">70050.0</span><span class="p">,</span>  <span class="c1"># 卖五价</span>
    <span class="s2">&quot;ask_volume5&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 卖五量</span>
    <span class="s2">&quot;bid_price5&quot;</span><span class="p">:</span> <span class="mf">69380.0</span><span class="p">,</span>  <span class="c1"># 买五价</span>
    <span class="s2">&quot;bid_volume5&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 买五量</span>
    <span class="s2">&quot;last_price&quot;</span><span class="p">:</span> <span class="mf">69710.0</span><span class="p">,</span>  <span class="c1"># 最新价</span>
    <span class="s2">&quot;highest&quot;</span><span class="p">:</span> <span class="mf">70050.0</span><span class="p">,</span>  <span class="c1"># 当日最高价</span>
    <span class="s2">&quot;lowest&quot;</span><span class="p">:</span> <span class="mf">69520.0</span><span class="p">,</span>  <span class="c1"># 当日最低价</span>
    <span class="s2">&quot;open&quot;</span><span class="p">:</span> <span class="mf">69770.0</span><span class="p">,</span>  <span class="c1"># 开盘价</span>
    <span class="s2">&quot;close&quot;</span><span class="p">:</span> <span class="mf">69710.0</span><span class="p">,</span>  <span class="c1"># 收盘价</span>
    <span class="s2">&quot;average&quot;</span><span class="p">:</span> <span class="mf">69785.019711</span><span class="p">,</span>  <span class="c1"># 当日均价</span>
    <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="mi">761</span><span class="p">,</span>  <span class="c1"># 成交量</span>
    <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">265532000.0</span><span class="p">,</span>  <span class="c1"># 成交额</span>
    <span class="s2">&quot;open_interest&quot;</span><span class="p">:</span> <span class="mi">8850</span><span class="p">,</span>  <span class="c1"># 持仓量</span>
    <span class="s2">&quot;settlement&quot;</span><span class="p">:</span> <span class="mf">69780.0</span><span class="p">,</span>  <span class="c1"># 结算价</span>
    <span class="s2">&quot;upper_limit&quot;</span><span class="p">:</span> <span class="mf">75880.0</span><span class="p">,</span>  <span class="c1"># 涨停价</span>
    <span class="s2">&quot;lower_limit&quot;</span><span class="p">:</span> <span class="mf">64630.0</span><span class="p">,</span>  <span class="c1"># 跌停价</span>
    <span class="s2">&quot;pre_open_interest&quot;</span><span class="p">:</span> <span class="mi">8791</span><span class="p">,</span>  <span class="c1"># 昨持仓量</span>
    <span class="s2">&quot;pre_settlement&quot;</span><span class="p">:</span> <span class="mf">70260.0</span><span class="p">,</span>  <span class="c1"># 昨结算价</span>
    <span class="s2">&quot;pre_close&quot;</span><span class="p">:</span> <span class="mf">69680.0</span><span class="p">,</span>  <span class="c1"># 昨收盘价</span>
    <span class="s2">&quot;price_tick&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>  <span class="c1"># 合约价格变动单位</span>
    <span class="s2">&quot;price_decs&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 合约价格小数位数</span>
    <span class="s2">&quot;volume_multiple&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>  <span class="c1"># 合约乘数</span>
    <span class="s2">&quot;max_limit_order_volume&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>  <span class="c1"># 最大限价单手数</span>
    <span class="s2">&quot;max_market_order_volume&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 最大市价单手数</span>
    <span class="s2">&quot;min_limit_order_volume&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 最小限价单手数</span>
    <span class="s2">&quot;min_market_order_volume&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 最小市价单手数</span>
    <span class="s2">&quot;underlying_symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># 标的合约</span>
    <span class="s2">&quot;strike_price&quot;</span><span class="p">:</span> <span class="n">NaN</span><span class="p">,</span>  <span class="c1"># 行权价</span>
    <span class="s2">&quot;ins_class&quot;</span><span class="p">:</span> <span class="s2">&quot;FUTURE&quot;</span><span class="p">,</span>  <span class="c1"># 合约类型</span>
    <span class="s2">&quot;instrument_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SHFE.cu2201&quot;</span><span class="p">,</span>  <span class="c1"># 合约代码</span>
    <span class="s2">&quot;instrument_name&quot;</span><span class="p">:</span> <span class="s2">&quot;沪铜2201&quot;</span><span class="p">,</span>  <span class="c1"># 合约中文名</span>
    <span class="s2">&quot;exchange_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SHFE&quot;</span><span class="p">,</span>  <span class="c1"># 交易所代码</span>
    <span class="s2">&quot;expired&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>  <span class="c1"># 合约是否已下市</span>
    <span class="s2">&quot;trading_time&quot;</span><span class="p">:</span> <span class="s2">&quot;{&#39;day&#39;: [[&#39;09:00:00&#39;, &#39;10:15:00&#39;], [&#39;10:30:00&#39;, &#39;11:30:00&#39;], [&#39;13:30:00&#39;, &#39;15:00:00&#39;]], &#39;night&#39;: [[&#39;21:00:00&#39;, &#39;25:00:00&#39;]]}&quot;</span><span class="p">,</span>  <span class="c1"># 交易时间段</span>
    <span class="s2">&quot;expire_datetime&quot;</span><span class="p">:</span> <span class="mf">1642402800.0</span><span class="p">,</span>  <span class="c1"># 到期具体日，以秒为单位的 timestamp 值</span>
    <span class="s2">&quot;delivery_year&quot;</span><span class="p">:</span> <span class="mi">2022</span><span class="p">,</span>  <span class="c1"># 期货交割日年份，只对期货品种有效。期权推荐使用最后行权日年份</span>
    <span class="s2">&quot;delivery_month&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 期货交割日月份，只对期货品种有效。期权推荐使用最后行权日月份</span>
    <span class="s2">&quot;last_exercise_datetime&quot;</span><span class="p">:</span> <span class="n">NaN</span><span class="p">,</span>  <span class="c1"># 期权最后行权日，以秒为单位的 timestamp 值</span>
    <span class="s2">&quot;exercise_year&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 期权最后行权日年份，只对期权品种有效。</span>
    <span class="s2">&quot;exercise_month&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 期权最后行权日月份，只对期权品种有效。</span>
    <span class="s2">&quot;option_class&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># 期权行权方式，看涨:&#39;CALL&#39;，看跌:&#39;PUT&#39;</span>
    <span class="s2">&quot;exercise_type&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># 期权行权方式，美式:&#39;A&#39;，欧式:&#39;E&#39;</span>
    <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;cu&quot;</span><span class="p">,</span>  <span class="c1"># 品种代码</span>
    <span class="s2">&quot;iopv&quot;</span><span class="p">:</span> <span class="n">NaN</span><span class="p">,</span>  <span class="c1"># ETF实时单位基金净值</span>
    <span class="s2">&quot;public_float_share_quantity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 日流通股数，只对证券产品有效。</span>
    <span class="s2">&quot;stock_dividend_ratio&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># 除权表 [&quot;20190601,0.15&quot;,&quot;20200107,0.2&quot;…]</span>
    <span class="s2">&quot;cash_dividend_ratio&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># 除息表 [&quot;20190601,0.15&quot;,&quot;20200107,0.2&quot;…]</span>
    <span class="s2">&quot;expire_rest_days&quot;</span><span class="p">:</span> <span class="mi">153</span><span class="p">,</span>   <span class="c1"># 距离到期日的剩余天数（自然日天数），正数表示距离到期日的剩余天数，0表示到期日当天，负数表示距离到期日已经过去的天数</span>
    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="mf">17.565</span><span class="p">,</span>
    <span class="s2">&quot;margin&quot;</span><span class="p">:</span> <span class="mf">31617.0</span>
<span class="p">}</span>
</pre></div>
</div>
<p>对于每个合约, 只需要调用一次 get_quote 函数. 如果需要监控数据更新, 可以使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1812&quot;</span><span class="p">)</span>  <span class="c1"># 获取SHFE.cu1812合约的行情</span>

<span class="k">while</span> <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>    <span class="c1"># 收到新行情时都会执行这行</span>
</pre></div>
</div>
</section>
<section id="k">
<h4>K线数据<a class="headerlink" href="#k" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code> 函数获取指定合约和周期的K线序列数据:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1812&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 获取SHFE.cu1812合约的10秒K线</span>
</pre></div>
</div>
<p>获取按照时间对齐的多合约K线:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">([</span><span class="s2">&quot;SHFE.au1912&quot;</span><span class="p">,</span> <span class="s2">&quot;SHFE.au2006&quot;</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 获取SHFE.au2006向SHFE.au1912对齐的K线</span>
</pre></div>
</div>
<p>详细使用方法及说明请见 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code> 函数使用说明。</p>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code> 的返回值是一个 pandas.DataFrame, 包含以下列:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>id: 1234 (k线序列号)
datetime: 1501080715000000000 (K线起点时间(按北京时间)，自unix epoch(1970-01-01 00:00:00 GMT)以来的纳秒数)
open: 51450.0 (K线起始时刻的最新价)
high: 51450.0 (K线时间范围内的最高价)
low: 51450.0 (K线时间范围内的最低价)
close: 51450.0 (K线结束时刻的最新价)
volume: 11 (K线时间范围内的成交量)
open_oi: 27354 (K线起始时刻的持仓量)
close_oi: 27355 (K线结束时刻的持仓量)
</pre></div>
</div>
<p>要使用K线数据, 请使用 pandas.DataFrame 的相关函数. 常见用法示例如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">close</span>  <span class="c1"># 最后一根K线的收盘价</span>
<span class="n">klines</span><span class="o">.</span><span class="n">close</span>          <span class="c1"># 收盘价序列, 一个 pandas.Serial</span>
</pre></div>
</div>
<p>TqSdk中, K线周期以秒数表示，支持不超过1日的任意周期K线，例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span> <span class="c1"># 70秒线</span>
<span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span> <span class="c1"># 86400秒线, 即日线</span>
<span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">86500</span><span class="p">)</span> <span class="c1"># 86500秒线, 超过1日，无效</span>
</pre></div>
</div>
<p>TqSdk中最多可以获取每个K线序列的最后8000根K线，无论哪个周期。也就是说，你如果提取小时线，最多可以提取最后8000根小时线，如果提取分钟线，最多也是可以提取最后8000根分钟线。</p>
<p>对于每个K线序列, 只需要调用一次 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code> . 如果需要监控数据更新, 可以使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1812&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 获取SHFE.cu1812合约的10秒K线</span>

<span class="k">while</span> <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>    <span class="c1"># K线数据有任何变动时都会执行这行</span>
</pre></div>
</div>
<p>如果只想在新K线出现时收到信号, 可以配合使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_changing()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1812&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>        <span class="c1"># 获取SHFE.cu1812合约的10秒K线</span>

<span class="k">while</span> <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>    <span class="c1"># 判定最后一根K线的时间是否有变化</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>                          <span class="c1"># 当最后一根K线的时间有变(新K线生成)时才会执行到这里</span>
</pre></div>
</div>
</section>
<section id="tick">
<h4>Tick序列<a class="headerlink" href="#tick" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tick_serial()</span></code> 函数获取指定合约的Tick序列数据:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ticks</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_tick_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1812&quot;</span><span class="p">)</span>  <span class="c1"># 获取SHFE.cu1812合约的Tick序列</span>
</pre></div>
</div>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tick_serial()</span></code> 的返回值是一个 pandas.DataFrame, 常见用法示例如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ticks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bid_price1</span>       <span class="c1"># 最后一个Tick的买一价</span>
<span class="n">ticks</span><span class="o">.</span><span class="n">volume</span>                    <span class="c1"># 成交量序列, 一个 pandas.Serial</span>
</pre></div>
</div>
<p>tick序列的更新监控, 与K线序列采用同样的方式.</p>
</section>
<section id="id5">
<h4>关于合约及行情的一些常见问题<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p><strong>怎样同时监控多个合约的行情变化</strong></p>
<blockquote>
<div><p>TqSdk可以订阅任意多个行情和K线, 并在一个wait_update中等待更新. 像这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q1</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">)</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1902&quot;</span><span class="p">)</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1902&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

<span class="k">while</span> <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;收到数据了&quot;</span><span class="p">)</span>        <span class="c1"># 上面4项中的任意一项有变化, 都会到这一句. 具体是哪个或哪几个变了, 用 is_changing 判断</span>
  <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">q1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>               <span class="c1"># 如果q1变了, 就会执行这句</span>
  <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">q2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">k1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">k2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
</pre></div>
</div>
<p>关于 <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 和 <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_changing()</span></code> 的详细说明, 请见 <a class="reference internal" href="index.html#framework"><span class="std std-ref">策略程序结构</span></a></p>
</div></blockquote>
</section>
</section>
<span id="document-usage/ta"></span><section id="ta">
<span id="id1"></span><h3>技术指标与序列计算函数<a class="headerlink" href="#ta" title="Permalink to this headline">¶</a></h3>
<section id="id2">
<h4>技术指标<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>tqsdk.ta 模块中包含了大量技术指标. 每个技术指标是一个函数, 函数名为全大写, 第一参数总是K线序列, 以pandas.DataFrame格式返回计算结果. 以MACD为例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">MACD</span>

<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1812&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>   <span class="c1"># 提取SHFE.cu1812的分钟线</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>                        <span class="c1"># 计算MACD指标</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">])</span>                                   <span class="c1"># MACD指标中的diff序列</span>
</pre></div>
</div>
<p>tqsdk.ta 中目前提供的技术指标详表，请见 <a class="reference internal" href="index.html#tqsdk-ta"><span class="std std-ref">tqsdk.ta - 技术指标计算函数</span></a></p>
</section>
<section id="id3">
<h4>序列计算函数<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>tqsdk.tafunc 模块中包含了一批序列计算函数. 它们是构成技术指标的基础. 在某些情况下, 您也可以直接使用这些序列计算函数以获取更大的灵活性.</p>
<p>例如, 技术指标MA(均线)总是按K线的收盘价来计算, 如果你需要计算最高价的均线, 可以使用ma函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk.tafunc</span> <span class="kn">import</span> <span class="n">ma</span>

<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1812&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>   <span class="c1"># 提取SHFE.cu1812的分钟线</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>                        <span class="c1"># 按K线的最高价序列做9分钟的移动平均</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>                                      <span class="c1"># 移动平均结果</span>
</pre></div>
</div>
<p>tqsdk.tafunc 中目前提供的序列计算函数详表，请见 <a class="reference internal" href="index.html#tqsdk-tafunc"><span class="std std-ref">tqsdk.tafunc - 序列计算函数</span></a></p>
</section>
</section>
<span id="document-usage/trade"></span><section id="trade">
<span id="id1"></span><h3>账户与交易<a class="headerlink" href="#trade" title="Permalink to this headline">¶</a></h3>
<section id="id2">
<h4>快期账户和实盘账户<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>在使用 TqSdk 之前，用户需要先注册自己的 <strong>快期账户</strong> ，传入快期账户是使用任何 TqSdk 程序的前提</p>
<p>点击  <a class="reference external" href="https://account.shinnytech.com/">注册快期账户</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>对于 TqSdk 免费版，每个快期账户支持最多绑定一个实盘账户，并且快期账户会在用户第一次使用实盘账户时自动进行绑定(自动绑定功能需要 TqSdk 版本&gt; 1.8.3):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>如果需要注册快期账户或者修改您的快期账户绑定的实盘账户，请点击 <a class="reference external" href="https://www.shinnytech.com/register-intro/">登录用户管理中心</a> ，登录成功后显示如下</p>
<p>在下方红框处,用户可以自行解绑/绑定实盘账户，其中解绑操作每天限定一次</p>
<figure class="align-default">
<img alt="_images/user_web_management1.png" src="_images/user_web_management1.png" />
</figure>
<p>如果需要让您的快期账户支持更多的实盘账户，可以购买或申请试用我们的 <a class="reference external" href="https://www.shinnytech.com/tqsdk_professional/">天勤量化专业版</a></p>
</section>
<section id="id6">
<h4>设定实盘交易账户<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>TqSdk 要求在创建 TqApi 时指定交易账户。一旦TqApi创建成功，后续所有通过TqApi发出的交易指令均在此账户中进行.</p>
<p>要使用实盘交易账户, 请使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqAccount</span></code> (注：使用前请先 import TqAccount):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqAccount</span><span class="p">,</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqAccount</span><span class="p">(</span><span class="s2">&quot;H海通期货&quot;</span><span class="p">,</span> <span class="s2">&quot;320102&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TqAccount</span></code> 的三个参数分别为 &lt;期货公司名&gt;, &lt;用户名&gt; 和 &lt;密码&gt; (期货公司名前需加大写首字母). 目前TqSdk支持的期货公司列表请参见: <a class="reference external" href="https://www.shinnytech.com/blog/tq-support-broker/">TqSdk支持的期货公司列表</a></p>
<p>TqApi 创建成功即代表相应账户已登录成功. 如果在60秒内无法完成登录, 会抛出超时异常, 用户代码可以此判定登录失败:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqAccount</span><span class="p">(</span><span class="s2">&quot;H海通期货&quot;</span><span class="p">,</span> <span class="s2">&quot;320102&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;行情服务连不上, 或者期货公司服务器关了, 或者账号密码错了, 总之就是有问题&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id7">
<h4>设定快期模拟交易账户<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>如果您需要使用快期模拟账户进行测试，只需在创建TqApi时传入一个 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqKq</span></code> 的实例，同时需要传入快期账户 <a class="reference internal" href="index.html#sim-trading"><span class="std std-ref">模拟交易和论坛</span></a>。</p>
<p>此账户类型与快期 APP 、天勤官网论坛、快期专业版使用相同的模拟账户系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqKq</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqKq</span><span class="p">(),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="id8">
<h4>设定模拟交易账户<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>如果您需要使用模拟账户进行测试，只需在创建TqApi时传入一个 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqSim</span></code> 的实例（不填写参数则默认为 TqSim() 模拟账号）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>api = TqApi(TqSim()，auth=TqAuth(&quot;快期账户&quot;, &quot;账户密码&quot;))
</pre></div>
</div>
<p>如果需要使用能保存账户资金及持仓信息的模拟账户，请使用 &quot;快期模拟&quot; 账号, 账户申请及使用方法请参考 <a class="reference internal" href="index.html#sim-trading"><span class="std std-ref">模拟交易和论坛</span></a> 部分内容。</p>
</section>
<section id="id9">
<h4>获取账户情况<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>TqApi 提供以下函数来获取交易账户相关信息:</p>
<ul class="simple">
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_account()</span></code> - 获取账户资金情况</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_position()</span></code> - 获取持仓情况</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_order()</span></code> - 获取委托单</p></li>
</ul>
<p>以上函数返回的都是dict, 并会在 wait_update 时更新</p>
</section>
<section id="id10">
<h4>交易指令<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>要在交易账户中发出一个委托单, 使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">insert_order()</span></code> 函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;SHFE.rb1901&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">4310</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</pre></div>
</div>
<p>这个函数调用后会立即返回一个指向此委托单的对象引用, 使用方法与dict一致, 内容如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;order_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;123&quot; (委托单ID, 对于一个用户的所有委托单，这个ID都是不重复的)</span>
    <span class="s2">&quot;exchange_order_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;1928341&quot; (交易所单号)</span>
    <span class="s2">&quot;exchange_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;SHFE&quot; (交易所)</span>
    <span class="s2">&quot;instrument_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;rb1901&quot; (交易所内的合约代码)</span>
    <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;BUY&quot; (下单方向, BUY=买, SELL=卖)</span>
    <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;OPEN&quot; (开平标志, OPEN=开仓, CLOSE=平仓, CLOSETODAY=平今)</span>
    <span class="s2">&quot;volume_orign&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 10 (总报单手数)</span>
    <span class="s2">&quot;volume_left&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 5 (未成交手数)</span>
    <span class="s2">&quot;limit_price&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>  <span class="c1"># 4500.0 (委托价格, 仅当 price_type = LIMIT 时有效)</span>
    <span class="s2">&quot;price_type&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;LIMIT&quot; (价格类型, ANY=市价, LIMIT=限价)</span>
    <span class="s2">&quot;volume_condition&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;ANY&quot; (手数条件, ANY=任何数量, MIN=最小数量, ALL=全部数量)</span>
    <span class="s2">&quot;time_condition&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;GFD&quot; (时间条件, IOC=立即完成，否则撤销, GFS=本节有效, GFD=当日有效, GTC=撤销前有效, GFA=集合竞价有效)</span>
    <span class="s2">&quot;insert_date_time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 1501074872000000000 (下单时间(按北京时间)，自unix epoch(1970-01-01 00:00:00 GMT)以来的纳秒数)</span>
    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;ALIVE&quot; (委托单状态, ALIVE=有效, FINISHED=已完)</span>
    <span class="s2">&quot;last_msg&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># &quot;报单成功&quot; (委托单状态信息)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>与其它所有数据一样, 委托单的信息也会在 api.wait_update() 时被自动更新:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;SHFE.rb1901&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">4310</span><span class="p">,</span><span class="n">volume</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">while</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;委托单状态: </span><span class="si">%s</span><span class="s2">, 未成交手数: </span><span class="si">%d</span><span class="s2"> 手&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">volume_left</span><span class="p">))</span>
</pre></div>
</div>
<p>要撤销一个委托单, 使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">cancel_order()</span></code> 函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>除 insert_order 和 cancel_order 外, TqSdk 提供了一些更强的交易辅助工具比如</strong> <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code>. <strong>使用这些工具, 可以简化交易逻辑的编码工作.</strong></p></li>
</ul>
</section>
<section id="broker-list">
<span id="id11"></span><h4>TqSdk支持的期货公司列表<a class="headerlink" href="#broker-list" title="Permalink to this headline">¶</a></h4>
<p>请点击查看: <a class="reference external" href="https://www.shinnytech.com/blog/tq-support-broker/">TqSdk支持的期货公司列表</a></p>
</section>
</section>
<span id="document-usage/option_trade"></span><section id="option-trade">
<span id="id1"></span><h3>期权交易 &amp; 交易所官方组合<a class="headerlink" href="#option-trade" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 中期权交易(商品期权、金融期权和 ETF 期权)和交易所官方组合交易，均是 TqSdk 专业版中的功能</p>
<p>用户如果想在 TqSdk 中进行上述操作，可以点击 <a class="reference external" href="https://www.shinnytech.com/tqsdk_professional/">天勤量化专业版</a> 申请使用或购买</p>
<p>TqSdk 中期权合和交易所官方组合的约代码格式参考如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DCE</span><span class="o">.</span><span class="n">m1807</span><span class="o">-</span><span class="n">C</span><span class="o">-</span><span class="mi">2450</span> <span class="o">-</span> <span class="n">大商所豆粕期权</span>
<span class="n">CZCE</span><span class="o">.</span><span class="n">CF003C11000</span> <span class="o">-</span> <span class="n">郑商所棉花期权</span>
<span class="n">SHFE</span><span class="o">.</span><span class="n">au2004C308</span> <span class="o">-</span> <span class="n">上期所黄金期权</span>
<span class="n">CFFEX</span><span class="o">.</span><span class="n">IO2002</span><span class="o">-</span><span class="n">C</span><span class="o">-</span><span class="mi">3550</span> <span class="o">-</span> <span class="n">中金所沪深300股指期权</span>
<span class="n">SSE</span><span class="mf">.10002513</span> <span class="o">-</span> <span class="n">上交所上证50etf期权</span>
<span class="n">SSE</span><span class="mf">.10002504</span> <span class="o">-</span> <span class="n">上交所沪深300etf期权</span>
<span class="n">SZSE</span><span class="mf">.90000097</span> <span class="o">-</span> <span class="n">深交所沪深300etf期权</span>
<span class="n">CZCE</span><span class="o">.</span><span class="n">SPD</span> <span class="n">SR901</span><span class="o">&amp;</span><span class="n">SR903</span> <span class="o">-</span> <span class="n">郑商所</span> <span class="n">SR901</span><span class="o">&amp;</span><span class="n">SR903</span> <span class="n">跨期合约</span>
<span class="n">DCE</span><span class="o">.</span><span class="n">SP</span> <span class="n">a1709</span><span class="o">&amp;</span><span class="n">a1801</span> <span class="o">-</span> <span class="n">大商所</span> <span class="n">a1709</span><span class="o">&amp;</span><span class="n">a1801</span> <span class="n">跨期合约</span>
</pre></div>
</div>
<p>对于交易所官方组合，目前 TqSdk 中只支持交易所官方组合进行实盘交易</p>
<section id="id3">
<h4>期权指标计算&amp;序列计算函数<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>TqSdk 内提供了丰富的期权指标计算&amp;序列计算函数，参考如下：</p>
<ul class="simple">
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">OPTION_GREEKS()</span></code> - 计算期权希腊指标</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">OPTION_IMPV()</span></code> - 计算期权隐含波动率</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">BS_VALUE()</span></code> - 计算期权 BS 模型理论价格</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">OPTION_VALUE()</span></code> - 计算期权内在价值，期权时间价值</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_bs_price()</span></code> - 计算期权 BS 模型理论价格</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_delta()</span></code> - 计算期权希腊指标 delta 值</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_gamma()</span></code> - 计算期权希腊指标 gamma 值</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_rho()</span></code> - 计算期权希腊指标 rho 值</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_theta()</span></code> - 计算期权希腊指标 theta 值</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_vega()</span></code> - 计算期权希腊指标 vega 值</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_his_volatility()</span></code> - 计算某个合约的历史波动率</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_t()</span></code> - 计算 K 线序列对应的年化到期时间，主要用于计算期权相关希腊指标时，需要得到计算出序列对应的年化到期时间</p></li>
</ul>
</section>
<section id="id4">
<h4>期权查询函数<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>TqSdk 内提供了完善的期权查询函数 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_options()</span></code> 和对应平值虚值期权查询函数  <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_atm_options()</span></code> ，供用户搜索符合自己需求的期权:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 标的为 &quot;SHFE.au2012&quot; 的所有期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">option_class</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 标的为 &quot;SHFE.au2012&quot; 的看跌期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">option_class</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="n">expired</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 标的为 &quot;SHFE.au2012&quot; 的看跌期权, 未下市的</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">strike_price</span><span class="o">=</span><span class="mi">340</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 标的为 &quot;SHFE.au2012&quot; 、行权价为 340 的期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SSE.510300&quot;</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s2">&quot;CFFEX&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 中金所沪深300股指期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SSE.510300&quot;</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s2">&quot;SSE&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 上交所沪深300etf期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SSE.510300&quot;</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s2">&quot;SSE&quot;</span><span class="p">,</span> <span class="n">exercise_year</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span> <span class="n">exercise_month</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 上交所沪深300etf期权, 限制条件 2020 年 12 月份行权</span>
</pre></div>
</div>
</section>
</section>
<span id="document-usage/targetpostask"></span><section id="targetpostask">
<span id="id1"></span><h3>交易辅助工具<a class="headerlink" href="#targetpostask" title="Permalink to this headline">¶</a></h3>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 是按照目标持仓手数自动调整 账户持仓中某合约的净持仓 的工具, 使用示例如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb1901&quot;</span><span class="p">)</span>      <span class="c1">#创建一个自动调仓工具, 负责调整SHFE.rb1901的持仓</span>
<span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                     <span class="c1">#要求自动调仓工具将持仓调整到5手</span>
<span class="n">do_something_else</span><span class="p">()</span>                                 <span class="c1">#现在你可以做别的事了, 自动调仓工具将会在后台自动下单/撤单/跟单, 直到持仓手数达到5手为止</span>
</pre></div>
</div>
<p>下面是一个更实际的价差交易例子:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 创建 rb1810 的目标持仓 task，该 task 负责调整 rb1810 的仓位到指定的目标仓位</span>
<span class="n">target_pos_near</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb1810&quot;</span><span class="p">)</span>
<span class="c1"># 创建 rb1901 的目标持仓 task，该 task 负责调整 rb1901 的仓位到指定的目标仓位</span>
<span class="n">target_pos_deferred</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb1901&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote_near</span><span class="p">)</span> <span class="ow">or</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote_deferred</span><span class="p">):</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">quote_near</span><span class="o">.</span><span class="n">last_price</span> <span class="o">-</span> <span class="n">quote_deferred</span><span class="o">.</span><span class="n">last_price</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前价差:&quot;</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标持仓: 空近月，多远月&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为正数表示多头，负数表示空头，0表示空仓</span>
            <span class="n">target_pos_near</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">target_pos_deferred</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">spread</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标持仓: 空仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos_near</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">target_pos_deferred</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>使用 TargetPosTask 时, 需注意以下要点：</strong></p>
<ul>
<li><ol class="arabic simple">
<li><p>TargetPosTask 在 set_target_volume 时并不下单或撤单, 它的下单和撤单动作, 是在之后的每次 wait_update 时执行的. 因此, <strong>需保证 set_target_volume 后还会继续调用wait_update()</strong></p></li>
</ol>
</li>
<li><ol class="arabic" start="2">
<li><p>为每个合约只创建一个 TargetPosTask 实例. 一旦创建好后, 可以调用任意多次 set_target_volume 函数, <strong>它总是以最后一次 set_target_volume 设定的手数为工作目标。</strong> 如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb2001&quot;</span><span class="p">)</span>
<span class="c1"># 设定目标净持仓为空头1手</span>
<span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># 目标净持仓由空头1手改为多头1手</span>
<span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># 需在 set_target_volume 后调用 wait_update() 以发出指令</span>
    <span class="c1"># 当调整到目标净持仓后, 账户中此合约的净持仓为多头1手</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><ol class="arabic simple" start="3">
<li><p>TargetPosTask 在工作时, 会负责下单和追单, 直至持仓手数达到目标为止.</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="4">
<li><p>在将净持仓调整到目标值后, 可能只持有其中一个方向的手数, 也可能同时有多/空头两个方向的持仓(原因有两个: 初始就持有多/空两个方向, 调整持仓时未平完某一方向; 或在调整目标持仓时禁止&quot;平今&quot;或&quot;平昨&quot;,然后以开仓操作来调整净持仓).</p></li>
</ol>
<blockquote>
<div><dl class="simple">
<dt>以当前持仓为 多头方向 且目标净持仓为0 为例, 对净持仓的调整逻辑为:</dt><dd><ul class="simple">
<li><p>如果 offset_priority 为默认值&quot;今昨,开&quot;, 则: 先平多头今仓, (若平完今仓后未达到目标手数)再平多头昨仓, (若平完昨仓后未达到目标手数)再在空头方向开仓.</p></li>
<li><p>如果 offset_priority 为&quot;今开&quot;(即禁止平昨仓), 则: 先平多头今仓, (若平完今仓后未达到目标手数)再在空头方向开仓. (禁止平今仓的&quot;昨开&quot;与此类似)</p></li>
<li><p>如果 offset_priority 为&quot;开&quot;(即禁止平仓), 则: 直接在空头方向开仓以达到目标净持仓.</p></li>
</ul>
</dd>
</dl>
<p><strong>注意:</strong></p>
<p>对于上期所和上海能源交易中心合约, 平仓时则直接根据今/昨的手数进行下单. 对于非上期所和能源交易中心: &quot;今仓&quot;和&quot;昨仓&quot; 是服务器按照今/昨仓的定义(本交易日开始时的持仓手数为昨仓, 之后下单的都为今仓)来计算的, 在平仓时, 则根据计算的今昨仓手数进行下单.</p>
<p>如持有大商所某合约并且 offset_priority 为&quot;今开&quot;, 而本交易日未下单(在今昨仓的概念上这是&quot;昨仓&quot;, 则不进行平仓, 直接用开仓操作来调整净持仓以达到目标.</p>
</div></blockquote>
</li>
<li><ol class="arabic simple" start="5">
<li><p>如需要取消当前 TargetPosTask 任务，请参考  <a class="reference internal" href="index.html#targetpostask2"><span class="std std-ref">TargetPosTask 高级功能</span></a> 。</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="6">
<li><p>请勿在使用 TargetPosTask 的同时使用 insert_order() 函数, 否则将导致 TargetPosTask 报错或错误下单。</p></li>
</ol>
</li>
</ul>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">InsertOrderUntilAllTradedTask</span></code> 是追价下单task, 该task会在行情变化后自动撤单重下，直到全部成交.</p>
</section>
<span id="document-usage/backtest"></span><section id="backtest">
<span id="id1"></span><h3>策略程序回测<a class="headerlink" href="#backtest" title="Permalink to this headline">¶</a></h3>
<p>策略程序回测是 TqSdk 专业版中的功能，能让用户在不改变代码的情况下去回测自己的策略在历史行情的表现</p>
<p>如果想使用策略回测该功能，可以点击 <a class="reference external" href="https://www.shinnytech.com/tqsdk_professional/">天勤量化专业版</a> 申请使用或购买</p>
<p>对于 TqSdk 免费版本的用户，每天可以进行3次回测，同时也可以申请模拟账户后模拟运行来检验策略 <a class="reference internal" href="index.html#sim-trading"><span class="std std-ref">模拟交易和论坛</span></a></p>
<section id="id3">
<h4>执行策略回测<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>使用 TqSdk 编写的策略程序，不需要修改策略代码，只需要在创建 api 实例时给backtest参数传入 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqBacktest</span></code> , 策略就会进入历史回测模式:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqSim</span><span class="p">,</span> <span class="n">TqBacktest</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqSim</span><span class="p">(),</span> <span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>使用tqsdk在回测结束后会输出交易记录和每日收盘时的账户资金情况，以及最大回撤、夏普比率等指标，这些数据可以导入到 excel 中或使用其他分析工具进一步处理。</p>
<p>回测示例程序：<a class="reference internal" href="index.html#tutorial-backtest"><span class="std std-ref">backtest - 回测</span></a></p>
</section>
<section id="id4">
<h4>在回测结束时获取回测详细信息<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>要在回测结束时调用您自己写的代码, 可以使用 try/except 机制捕获回测结束信号 BacktestFinished, 像这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">BacktestFinished</span>

<span class="n">acc</span> <span class="o">=</span> <span class="n">TqSim</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
  <span class="c1">#策略代码在这里</span>
  <span class="c1">#...</span>

<span class="k">except</span> <span class="n">BacktestFinished</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="c1"># 回测结束时会执行这里的代码</span>
  <span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">acc</span><span class="o">.</span><span class="n">trade_log</span><span class="p">)</span>  <span class="c1"># 回测的详细信息</span>

  <span class="nb">print</span><span class="p">(</span><span class="n">acc</span><span class="o">.</span><span class="n">tqsdk_stat</span><span class="p">)</span>  <span class="c1"># 回测时间内账户交易信息统计结果，其中包含以下字段</span>
  <span class="c1"># init_balance 起始资金</span>
  <span class="c1"># balance 结束资金</span>
  <span class="c1"># max_drawdown 最大回撤</span>
  <span class="c1"># profit_loss_ratio 盈亏额比例</span>
  <span class="c1"># winning_rate 胜率</span>
  <span class="c1"># ror 收益率</span>
  <span class="c1"># annual_yield 年化收益率</span>
  <span class="c1"># sharpe_ratio 年化夏普率</span>
  <span class="c1"># tqsdk_punchline 天勤点评</span>
</pre></div>
</div>
<p>回测的详细信息保存在回测所用的模拟账户 TqSim 中, 可以直接访问它的成员变量 trade_log(格式为 日期-&gt;交易记录及收盘时的权益及持仓).</p>
<p>同时我们也提供简单的图形化的回测报告功能供大家使用 <a class="reference internal" href="index.html#web-gui"><span class="std std-ref">策略程序图形化界面</span></a> ，使用效果参考下图</p>
<figure class="align-default">
<img alt="_images/web_gui_backtest1.png" src="_images/web_gui_backtest1.png" />
</figure>
</section>
<section id="backtest-with-web-gui">
<span id="id5"></span><h4>回测结束在浏览器中查看绘图结果<a class="headerlink" href="#backtest-with-web-gui" title="Permalink to this headline">¶</a></h4>
<p>要在回测结束时，如果依然需要在浏览器中查看绘图结果，同时又需要打印回测信息，您应该这样做:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">BacktestFinished</span>

<span class="n">acc</span> <span class="o">=</span> <span class="n">TqSim</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
  <span class="c1">#策略代码在这里</span>
  <span class="c1">#...</span>
<span class="k">except</span> <span class="n">BacktestFinished</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">acc</span><span class="o">.</span><span class="n">tqsdk_stat</span><span class="p">)</span>  <span class="c1"># 回测时间内账户交易信息统计结果，其中包含以下字段</span>
  <span class="c1"># 由于需要在浏览器中查看绘图结果，因此程序不能退出</span>
  <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="backtest-underlying-symbol">
<span id="id6"></span><h4>回测时获取主连合约标的<a class="headerlink" href="#backtest-underlying-symbol" title="Permalink to this headline">¶</a></h4>
<p>在天勤中回测时，对于主连合约，我们支持用户使用 <strong>quote.underlying_symbol</strong> 获取回测当时的标的合约。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqBacktest</span><span class="p">,</span> <span class="n">BacktestFinished</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;KQ.m@CFFEX.T&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">underlying_symbol</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;underlying_symbol&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">underlying_symbol</span><span class="p">)</span>
<span class="k">except</span> <span class="n">BacktestFinished</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># 预期输出：</span>
<span class="c1"># 2019-12-31 15:14:59.999999 CFFEX.T2003</span>
<span class="c1"># 2020-02-19 09:15:00.000000 CFFEX.T2006</span>
<span class="c1"># 2020-05-14 09:15:00.000000 CFFEX.T2009</span>
<span class="c1"># 2020-08-19 09:30:00.000000 CFFEX.T2012</span>
</pre></div>
</div>
</section>
<section id="backtest-rule">
<span id="id7"></span><h4>回测时的成交规则和推进<a class="headerlink" href="#backtest-rule" title="Permalink to this headline">¶</a></h4>
<p>在天勤中回测时，除了期货、期权合约以外，我们还支持使用 <strong>指数</strong> 进行回测和在回测中交易，指数合约代码格式参见 <a class="reference internal" href="index.html#mddatas"><span class="std std-ref">合约, 行情和历史数据</span></a></p>
<p>策略回测时使用内置模拟账户 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqSim</span></code> , 默认回测资金为1000w , 如果需要修改初始回测资金，只需给 TqSim 传入需要设定的金额即可:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqSim</span><span class="p">,</span> <span class="n">TqBacktest</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqSim</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span> <span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>撮合成交规则为对价成交. 即限价单的价格达到对手盘价格时判定为成交. 不会出现委托单部分成交的情况.</p>
<p>回测时策略程序报单, 会立即做一次成交判定.</p>
<p>回测框架的规则是当没有新的事件需要用户处理时才推进到下一个行情, 也就是这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                     <span class="c1"># 这个 wait_update 更新了行情</span>
<span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>  <span class="c1"># 程序下单</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                     <span class="c1"># 这个 wait_update 只会更新委托单状态, 行情还是停在原处</span>
<span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>  <span class="c1"># 如果又下了一个单</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                     <span class="c1"># 这个 wait_update 还是只会更新委托单状态, 行情还是停在原处</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                     <span class="c1"># 这个 wait_update 更新了行情</span>
</pre></div>
</div>
</section>
<section id="security-backtest">
<span id="id8"></span><h4>对股票合约进行回测<a class="headerlink" href="#security-backtest" title="Permalink to this headline">¶</a></h4>
<p>TqSdk 在 3.2.0 版本后支持了对股票合约进行回测功能，在回测过程中用户需要初始化 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqSimStock</span></code> 类，且该类只能支持股票模拟交易</p>
<p>由于股票市场 T+1 的规则, <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code>  函数目前还不支持在股票交易中使用，股票合约交易时只支持使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">insert_order</span></code></p>
<p>如果您想要在回测中同时交易期货和股票合约，则可以使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqMultiAccount</span></code> 来实现该需求:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 同时使用 TqSim 交易期货，TqSimStock 交易股票</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqMultiAccount</span><span class="p">,</span> <span class="n">TqSim</span><span class="p">,</span> <span class="n">TqSimStock</span>

<span class="n">tqsim_future</span> <span class="o">=</span> <span class="n">TqSim</span><span class="p">()</span>
<span class="n">tqsim_stock</span> <span class="o">=</span> <span class="n">TqSimStock</span><span class="p">()</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">account</span><span class="o">=</span><span class="n">TqMultiAccount</span><span class="p">([</span><span class="n">tqsim_future</span><span class="p">,</span> <span class="n">tqsim_stock</span><span class="p">]),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="c1"># 多账户下单，需要指定下单账户</span>
<span class="n">order1</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;SHFE.cu2112&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mf">72250.0</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="n">tqsim_future</span><span class="p">)</span>
<span class="n">order2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;SSE.603666&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="n">tqsim_stock</span><span class="p">)</span>
<span class="k">while</span> <span class="n">order1</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;FINISHED&#39;</span> <span class="ow">or</span> <span class="n">order2</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;FINISHED&#39;</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>

<span class="c1"># 打印账户可用资金</span>
<span class="n">future_account</span> <span class="o">=</span> <span class="n">tqsim_future</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
<span class="n">stock_account</span> <span class="o">=</span> <span class="n">tqsim_stock</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">future_account</span><span class="o">.</span><span class="n">available</span><span class="p">,</span> <span class="n">stock_account</span><span class="o">.</span><span class="n">available</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id9">
<h4>回测使用多行情序列的策略程序<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>TqSdk 允许一个策略程序中使用多个行情序列, 比如这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#... 策略程序代码</span>
<span class="n">ka1</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">ka2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
<span class="n">kb</span>  <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;CFFEX.IF1901&quot;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
<span class="n">tsa</span>  <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_tick_serial</span><span class="p">(</span><span class="s2">&quot;CFFEX.IF1901&quot;</span><span class="p">)</span>
<span class="n">qa</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;DCE.a1901&quot;</span><span class="p">)</span>
<span class="c1">#... 策略程序代码</span>
</pre></div>
</div>
<p>TqSdk回测框架使用一套复杂的规则来推进行情：</p>
<p>规则1: tick 序列(例如上面例子中的tsa) 总是按逐 tick 推进:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tsa</span>  <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_tick_serial</span><span class="p">(</span><span class="s2">&quot;CFFEX.IF1901&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tsa</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>             <span class="c1"># 2018/01/01 09:30:00.000</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                           <span class="c1"># 推进一个tick</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tsa</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>             <span class="c1"># 2018/01/01 09:30:00.500</span>
</pre></div>
</div>
<p>规则2: K线序列 (例如上面例子中的ka1, ka2) 总是按周期推进. 每根K线在创建时和结束时各更新一次:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ka2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span> <span class="c1"># 请求小时线</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ka2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>                         <span class="c1"># 2018/01/01 09:00:00.000, O=35000, H=35000, L=35000, C=35000 小时线刚创建</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                           <span class="c1"># 推进1小时, 前面一个小时线结束, 新开一根小时线</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ka2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>                         <span class="c1"># 2018/01/01 09:00:00.000, O=35000, H=35400, L=34700, C=34900 9点这根小时线完成了</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ka2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>                         <span class="c1"># 2018/01/01 10:00:00.000, O=34900, H=34900, L=34900, C=34900 10点的小时线刚创建</span>
</pre></div>
</div>
<p>规则3: quote按照以下规则更新:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">策略程序中使用了这个合约的tick序列</span><span class="p">:</span>
  <span class="n">每次tick序列推进时会更新quote的这些字段</span> <span class="n">datetime</span><span class="o">/</span><span class="n">ask</span><span class="o">&amp;</span><span class="n">bid_price1</span><span class="o">/</span><span class="n">ask</span><span class="o">&amp;</span><span class="n">bid_volume1</span><span class="o">/</span><span class="n">last_price</span><span class="o">/</span><span class="n">highest</span><span class="o">/</span><span class="n">lowest</span><span class="o">/</span><span class="n">average</span><span class="o">/</span><span class="n">volume</span><span class="o">/</span><span class="n">amount</span><span class="o">/</span><span class="n">open_interest</span><span class="o">/</span><span class="n">price_tick</span><span class="o">/</span><span class="n">price_decs</span><span class="o">/</span><span class="n">volume_multiple</span><span class="o">/</span><span class="nb">max</span><span class="o">&amp;</span><span class="n">min_limit</span><span class="o">&amp;</span><span class="n">market_order_volume</span><span class="o">/</span><span class="n">underlying_symbol</span><span class="o">/</span><span class="n">strike_price</span>
<span class="k">elif</span> <span class="n">策略程序中使用了这个合约的K线序列</span><span class="p">:</span>
  <span class="n">每次K线序列推进时会更新quote</span><span class="o">.</span> <span class="n">使用</span> <span class="n">k线生成的</span> <span class="n">quote</span> <span class="n">的盘口由收盘价分别加</span><span class="o">/</span><span class="n">减一个最小变动单位</span><span class="p">,</span> <span class="n">并且</span> <span class="n">highest</span><span class="o">/</span><span class="n">lowest</span><span class="o">/</span><span class="n">average</span><span class="o">/</span><span class="n">amount</span> <span class="n">始终为</span> <span class="n">nan</span><span class="p">,</span> <span class="n">volume</span> <span class="n">始终为0</span><span class="o">.</span>
  <span class="n">每次K线序列推进时会更新quote的这些字段</span> <span class="n">datetime</span><span class="o">/</span><span class="n">ask</span><span class="o">&amp;</span><span class="n">bid_price1</span><span class="o">/</span><span class="n">ask</span><span class="o">&amp;</span><span class="n">bid_volume1</span><span class="o">/</span><span class="n">last_price</span><span class="o">/</span><span class="n">open_interest</span><span class="o">/</span><span class="n">price_tick</span><span class="o">/</span><span class="n">price_decs</span><span class="o">/</span><span class="n">volume_multiple</span><span class="o">/</span><span class="nb">max</span><span class="o">&amp;</span><span class="n">min_limit</span><span class="o">&amp;</span><span class="n">market_order_volume</span><span class="o">/</span><span class="n">underlying_symbol</span><span class="o">/</span><span class="n">strike_price</span>
  <span class="k">if</span> <span class="n">策略程序使用的K线周期大于1分钟</span><span class="p">:</span>
    <span class="n">回测框架会隐式的订阅一个1分钟K线</span><span class="p">,</span> <span class="n">确保quote的更新周期不会超过1分钟</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">回测框架会隐式的订阅一个1分钟K线</span><span class="p">,</span> <span class="n">确保quote的更新周期不会超过1分钟</span>
</pre></div>
</div>
<p>规则4: 策略程序中的多个序列的更新, 按时间顺序合并推进. 每次 wait_update 时, 优先处理用户事件, 当没有用户事件时, 从各序列中选择下一次更新时间最近的, 更新到这个时间:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ka</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>              <span class="c1"># 请求一个10秒线</span>
<span class="n">kb</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1902&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>              <span class="c1"># 请求一个15秒线</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">kb</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>   <span class="c1"># 2018/01/01 09:00:00, 2018/01/01 09:00:00</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                                         <span class="c1"># 推进一步, ka先更新了, 时间推到 09:00:10</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">kb</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>   <span class="c1"># 2018/01/01 09:00:10, 2018/01/01 09:00:00</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                                         <span class="c1"># 再推一步, 这次时间推到 09:00:15, kb更新了</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">kb</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>   <span class="c1"># 2018/01/01 09:00:10, 2018/01/01 09:00:15</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                                         <span class="c1"># 再推一步, 这次时间推到 09:00:20, ka更新了</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">kb</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>   <span class="c1"># 2018/01/01 09:00:20, 2018/01/01 09:00:15</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>                                         <span class="c1"># 再推一步, 时间推到 09:00:30, ka, kb都更新了</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ka</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">kb</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>   <span class="c1"># 2018/01/01 09:00:30, 2018/01/01 09:00:30</span>
</pre></div>
</div>
<p><strong>注意</strong> ：如果未订阅 quote，模拟交易在下单时会自动为此合约订阅 quote ，根据回测时 quote 的更新规则，如果此合约没有订阅K线或K线周期大于分钟线 <strong>则会自动订阅一个分钟线</strong> 。</p>
<p>另外，对 <strong>组合合约</strong> 进行回测时需注意：只能通过订阅 tick 数据来回测，不能订阅K线，因为K线是由最新价合成的，而交易所发回的组合合约数据中无最新价。</p>
</section>
<section id="id10">
<h4>了解更多<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>如果你要做大量回测, 或者试图做参数优化/参数搜索, 请看 <a class="reference internal" href="index.html#batch-backtest"><span class="std std-ref">批量回测, 参数搜索及其它</span></a></p></li>
<li><p>如果你在回测时需要图形化界面支持，我们提供 TqSdk 内置强大的图形化界面解决方案 <a class="reference internal" href="index.html#web-gui"><span class="std std-ref">策略程序图形化界面</span></a></p></li>
</ul>
</section>
</section>
<span id="document-usage/web_gui"></span><section id="web-gui">
<span id="id1"></span><h3>策略程序图形化界面<a class="headerlink" href="#web-gui" title="Permalink to this headline">¶</a></h3>
<p>要在 TqSdk 中实现图形化界面非常简单，在 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqApi</span></code> 中传入参数 web_gui = True即可，一套方案满足实盘/回测需求</p>
<p>对于需要固定web_gui网址的同学，可以传入本机IP端口 web_gui = &quot;<a class="reference external" href="http://192.168.143.0:9876">http://192.168.143.0:9876</a>&quot;（需填写本机IP端口） 来进行固定网址</p>
<section id="id2">
<h4>实盘情况下的图形化界面<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>实盘下的示例代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 引入TqSdk模块</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="c1"># 创建api实例，设置web_gui=True生成图形化界面</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 订阅 cu2002 合约的10秒线</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2002&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># 通过wait_update刷新数据</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
<p>当你运行该程序后，预期会显示如下两条信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>2019-12-13 10:45:26,468 - INFO - 您可以访问 http://127.0.0.1:62964 查看策略绘制出的 K 线图形。
2019-12-13 10:45:27,422 - INFO - 通知: 与 wss://openmd.shinnytech.com/t/md/front/mobile 的网络连接已建立
</pre></div>
</div>
<p>点击访问地址后，显示网址效果如下:</p>
<figure class="align-default">
<img alt="_images/web_gui_demo1.png" src="_images/web_gui_demo1.png" />
</figure>
</section>
<section id="id3">
<h4>回测情况下的图形化界面<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>回测情况下，设置完回测区间参数后传入web_gui=True，也可以用同样的方法来生成图形化地址:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqBacktest</span><span class="p">,</span> <span class="n">TargetPosTask</span>
<span class="c1"># 在创建 api 实例时传入 TqBacktest 就会进入回测模式,设置web_gui=True开启图形化界面</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span><span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 获得 m1901 5分钟K线的引用</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;DCE.m1901&quot;</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="c1"># 创建 m1901 的目标持仓 task，该 task 负责调整 m1901 的仓位到指定的目标仓位</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;DCE.m1901&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">15</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;MA&quot;</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价大于MA: 目标多头5手&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为多头5手</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价小于MA: 目标空仓&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为空仓</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>点击访问地址后，显示网址效果如下:</p>
<figure class="align-default">
<img alt="_images/web_gui_klines.png" src="_images/web_gui_klines.png" />
</figure>
<p>点击完整回测报告，显示更加详细的报告结果:</p>
<figure class="align-default">
<img alt="_images/web_gui_backtest_report.png" src="_images/web_gui_backtest_report.png" />
</figure>
<p>如何在 TqSdk 中进行回测可以参见 <a class="reference internal" href="index.html#backtest"><span class="std std-ref">策略程序回测</span></a></p>
<span class="target" id="web-gui-replay"></span></section>
</section>
</div>
</section>
<span id="document-demo/index"></span><section id="demo">
<span id="id1"></span><h2>示例程序<a class="headerlink" href="#demo" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-demo/base"></span><section id="demo-base">
<span id="id1"></span><h3><a class="toc-backref" href="#id4">基本使用</a><a class="headerlink" href="#demo-base" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="id2">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#demo-base" id="id4">基本使用</a></p>
<ul>
<li><p><a class="reference internal" href="#t10" id="id5">t10 - 获取实时行情</a></p></li>
<li><p><a class="reference internal" href="#t20" id="id6">t20 - 识别行情更新</a></p></li>
<li><p><a class="reference internal" href="#t30-k-tick" id="id7">t30 - 使用K线/Tick数据</a></p></li>
<li><p><a class="reference internal" href="#t40" id="id8">t40 - 下单/撤单</a></p></li>
<li><p><a class="reference internal" href="#t41" id="id9">t41 - 开仓/平仓</a></p></li>
<li><p><a class="reference internal" href="#t60" id="id10">t60 - 单均线策略</a></p></li>
<li><p><a class="reference internal" href="#t70" id="id11">t70 - 简单均线策略(目标持仓模型)</a></p></li>
<li><p><a class="reference internal" href="#t71" id="id12">t71 - 简单趋势策略</a></p></li>
<li><p><a class="reference internal" href="#t72" id="id13">t72 - 隔夜开盘抢单</a></p></li>
<li><p><a class="reference internal" href="#t80" id="id14">t80 - 价差回归策略</a></p></li>
<li><p><a class="reference internal" href="#t90" id="id15">t90 - 在主图中画指标线</a></p></li>
<li><p><a class="reference internal" href="#t91" id="id16">t91 - 在附图中画指标线</a></p></li>
<li><p><a class="reference internal" href="#t92" id="id17">t92 - 主图中画信号线及文字标注</a></p></li>
<li><p><a class="reference internal" href="#t93" id="id18">t93 - 在主图中画线和方框</a></p></li>
<li><p><a class="reference internal" href="#t94-k" id="id19">t94 - 在附图中画K线</a></p></li>
<li><p><a class="reference internal" href="#t95-k" id="id20">t95 - 附图中画K线、线段和方框</a></p></li>
<li><p><a class="reference internal" href="#t96-macd" id="id21">t96 - 附图中画MACD</a></p></li>
<li><p><a class="reference internal" href="#underlying-symbol" id="id22">underlying_symbol - 获取主连映射主力合约</a></p></li>
<li><p><a class="reference internal" href="#backtest" id="id23">backtest - 回测</a></p></li>
<li><p><a class="reference internal" href="#downloader" id="id24">downloader - 下载数据</a></p></li>
<li><p><a class="reference internal" href="#downloader-orders" id="id25">downloader_orders - 下载委托单和成交记录</a></p></li>
<li><p><a class="reference internal" href="#ta" id="id26">ta - 指标计算</a></p></li>
<li><p><a class="reference internal" href="#ta-option" id="id27">ta_option - 期权指标计算</a></p></li>
<li><p><a class="reference internal" href="#multiaccount" id="id28">multiaccount - 多账户</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="t10">
<span id="tutorial-t10"></span><h4><a class="toc-backref" href="#id5">t10 - 获取实时行情</a><a class="headerlink" href="#t10" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="c1"># 创建API实例,传入自己的快期账户</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 获得上期所 ni2206 的行情引用，当行情有变化时 quote 中的字段会对应更新</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.ni2206&quot;</span><span class="p">)</span>

<span class="c1"># 输出 ni2206 的最新行情时间和最新价</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>

<span class="c1"># 关闭api,释放资源</span>
<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="t20">
<span id="tutorial-t20"></span><h4><a class="toc-backref" href="#id6">t20 - 识别行情更新</a><a class="headerlink" href="#t20" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="c1"># 可以指定debug选项将调试信息写入指定的文件中</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="s2">&quot;debug.log&quot;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;CZCE.FG209&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">ask_price1</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">ask_price2</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># 调用 wait_update 等待业务信息发生变化，例如: 行情发生变化, 委托单状态变化, 发生成交等等</span>
    <span class="c1"># 注意：其他合约的行情的更新也会触发业务信息变化，因此下面使用 is_changing 判断 FG209 的行情是否有变化</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 如果 FG209 的任何字段有变化，is_changing就会返回 True</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;行情变化&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="p">)</span>
    <span class="c1"># 只有当 FG209 的最新价有变化，is_changing才会返回 True</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价变化&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>
    <span class="c1"># 当 FG209 的买1价/买1量/卖1价/卖1量中任何一个有变化，is_changing都会返回 True</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ask_price1&quot;</span><span class="p">,</span> <span class="s2">&quot;ask_volume1&quot;</span><span class="p">,</span> <span class="s2">&quot;bid_price1&quot;</span><span class="p">,</span> <span class="s2">&quot;bid_volume1&quot;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;盘口变化&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">ask_price1</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">ask_volume1</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">bid_price1</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">bid_volume1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="t30-k-tick">
<span id="tutorial-t30"></span><h4><a class="toc-backref" href="#id7">t30 - 使用K线/Tick数据</a><a class="headerlink" href="#t30-k-tick" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 获得 i2209 tick序列的引用</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_tick_serial</span><span class="p">(</span><span class="s2">&quot;DCE.i2209&quot;</span><span class="p">)</span>
<span class="c1"># 获得 i2209 10秒K线的引用</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;DCE.i2209&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">))</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 判断整个tick序列是否有变化</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">ticks</span><span class="p">):</span>
        <span class="c1"># ticks.iloc[-1]返回序列中最后一个tick</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tick变化&quot;</span><span class="p">,</span> <span class="n">ticks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># 判断最后一根K线的时间是否有变化，如果发生变化则表示新产生了一根K线</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="c1"># datetime: 自unix epoch(1970-01-01 00:00:00 GMT)以来的纳秒数</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;新K线&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">))</span>
    <span class="c1"># 判断最后一根K线的收盘价是否有变化</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;close&quot;</span><span class="p">):</span>
        <span class="c1"># klines.close返回收盘价序列</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;K线变化&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">),</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="t40">
<span id="tutorial-t40"></span><h4><a class="toc-backref" href="#id8">t40 - 下单/撤单</a><a class="headerlink" href="#t40" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 获得 m2105 的持仓引用，当持仓有变化时 position 中的字段会对应更新</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="s2">&quot;DCE.m2105&quot;</span><span class="p">)</span>
<span class="c1"># 获得资金账户引用，当账户有变化时 account 中的字段会对应更新</span>
<span class="n">account</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
<span class="c1"># 下单并返回委托单的引用，当该委托单有变化时 order 中的字段会对应更新</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;DCE.m2105&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">2750</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_orign&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_left&quot;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;单状态: </span><span class="si">%s</span><span class="s2">, 已成交: </span><span class="si">%d</span><span class="s2"> 手&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">volume_orign</span> <span class="o">-</span> <span class="n">order</span><span class="o">.</span><span class="n">volume_left</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="s2">&quot;pos_long_today&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;今多头: </span><span class="si">%d</span><span class="s2"> 手&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">pos_long_today</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="s2">&quot;available&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;可用资金: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">available</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="t41">
<span id="tutorial-t41"></span><h4><a class="toc-backref" href="#id9">t41 - 开仓/平仓</a><a class="headerlink" href="#t41" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.ni2206&quot;</span><span class="p">)</span>
<span class="c1"># 开仓两手并等待完成</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;SHFE.ni2206&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="n">quote</span><span class="o">.</span><span class="n">ask_price1</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">while</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;已开仓&quot;</span><span class="p">)</span>
<span class="c1"># 平今两手并等待完成</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;SHFE.ni2206&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;SELL&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;CLOSETODAY&quot;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="n">quote</span><span class="o">.</span><span class="n">bid_price1</span><span class="p">,</span>
                         <span class="n">volume</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">while</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;已平今&quot;</span><span class="p">)</span>
<span class="c1"># 关闭api,释放相应资源</span>
<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="t60">
<span id="tutorial-t60"></span><h4><a class="toc-backref" href="#id10">t60 - 单均线策略</a><a class="headerlink" href="#t60" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">如果当前价格大于10秒K线的MA15则开多仓 (使用 insert_order() 函数)</span>
<span class="sd">如果小于则平仓</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 获得 m2207 10秒K线的引用</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;DCE.m2207&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># 判断开仓条件</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">15</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;MA&quot;</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价大于MA: 市价开仓&quot;</span><span class="p">)</span>
            <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;DCE.m2207&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">break</span>
<span class="c1"># 判断平仓条件</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">15</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;MA&quot;</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价小于MA: 市价平仓&quot;</span><span class="p">)</span>
            <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;DCE.m2207&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;SELL&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;CLOSE&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">break</span>
<span class="c1"># 关闭api,释放相应资源</span>
<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="t70">
<span id="tutorial-t70"></span><h4><a class="toc-backref" href="#id11">t70 - 简单均线策略(目标持仓模型)</a><a class="headerlink" href="#t70" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">如果当前价格大于10秒K线的MA15则开多仓 (使用 TargetPosTask 调仓工具)</span>
<span class="sd">如果小于则平仓</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 获得 m2207 10秒K线的引用</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;DCE.m2207&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="c1"># 创建 m2207 的目标持仓 task，该 task 负责调整 m2207 的仓位到指定的目标仓位</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;DCE.m2207&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">15</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;MA&quot;</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价大于MA: 目标多头5手&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为多头5手</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价小于MA: 目标空仓&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为空仓</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="t71">
<span id="tutorial-t71"></span><h4><a class="toc-backref" href="#id12">t71 - 简单趋势策略</a><a class="headerlink" href="#t71" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;yanqiong&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">连续3根阴线就做空，连续3根阳线就做多，否则空仓</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 设定连续多少根阳线/阴线</span>
<span class="n">length</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c1"># 获得 ni2205 10秒K线的引用, 长度为 length+1</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.ni2205&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># 创建 ni2205 的目标持仓 task，该 task 负责调整 ni2105 的仓位到指定的目标仓位, offset_priority的用法详见文档</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.ni2205&quot;</span><span class="p">,</span> <span class="n">offset_priority</span><span class="o">=</span><span class="s2">&quot;今昨开&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 只有在新创建出K线时才判断开平仓条件</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="c1"># 跳过最后一根刚生成的K线</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># 比较收盘价和开盘价，判断是阳线还是阴线</span>
        <span class="c1"># df.close 为收盘价序列, df.open 为开盘价序列, &quot;&gt;&quot;(pandas.Series.gt) 返回收盘价是否大于开盘价的一个新序列</span>
        <span class="n">up</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">close</span> <span class="o">&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">open</span>
        <span class="n">down</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">close</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">open</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">up</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;连续阳线: 目标持仓 多头1手&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为正数表示多头，负数表示空头，0表示空仓</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">down</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;连续阴线: 目标持仓 空头1手&quot;</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标持仓: 空仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="t72">
<span id="tutorial-t72"></span><h4><a class="toc-backref" href="#id13">t72 - 隔夜开盘抢单</a><a class="headerlink" href="#t72" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;ringo&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.tafunc</span> <span class="kn">import</span> <span class="n">time_to_datetime</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">使用get_trading_status来判断合约是否进入交易状态来进行下单，该接口需要有天勤量化专业版资格才可使用</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_trading_status</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2201&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">trade_status</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 如果处于集合竞价状态则进行下单</span>
    <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">trade_status</span> <span class="o">==</span> <span class="s2">&quot;AUCTIONORDERING&quot;</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2201&quot;</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">71400</span><span class="p">)</span>
        <span class="k">break</span>
<span class="c1"># insert_order指令会在下一次wait_update()发出</span>
<span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="t80">
<span id="tutorial-t80"></span><h4><a class="toc-backref" href="#id14">t80 - 价差回归策略</a><a class="headerlink" href="#t80" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">价差回归</span>
<span class="sd">当近月-远月的价差大于250时做空近月，做多远月</span>
<span class="sd">当价差小于200时平仓</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote_near</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2104&quot;</span><span class="p">)</span>
<span class="n">quote_deferred</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2105&quot;</span><span class="p">)</span>
<span class="c1"># 创建 rb2104 的目标持仓 task，该 task 负责调整 rb2104 的仓位到指定的目标仓位</span>
<span class="n">target_pos_near</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb2104&quot;</span><span class="p">)</span>
<span class="c1"># 创建 rb2105 的目标持仓 task，该 task 负责调整 rb2105 的仓位到指定的目标仓位</span>
<span class="n">target_pos_deferred</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb2105&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote_near</span><span class="p">)</span> <span class="ow">or</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote_deferred</span><span class="p">):</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">quote_near</span><span class="o">.</span><span class="n">last_price</span> <span class="o">-</span> <span class="n">quote_deferred</span><span class="o">.</span><span class="n">last_price</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前价差:&quot;</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标持仓: 空近月，多远月&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为正数表示多头，负数表示空头，0表示空仓</span>
            <span class="n">target_pos_near</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">target_pos_deferred</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">spread</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标持仓: 空仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos_near</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">target_pos_deferred</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="t90">
<span id="tutorial-t90"></span><h4><a class="toc-backref" href="#id15">t90 - 在主图中画指标线</a><a class="headerlink" href="#t90" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">MA</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">画图示例: 在主图中画指标线</span>
<span class="sd">注意: 画图示例中用到的数据不含有实际意义，请根据自己的实际策略情况进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>  <span class="c1"># web_gui=True, 开启使用 web 界面查看绘图结果的功能</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2105&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># 画一次指标线</span>
<span class="n">ma</span> <span class="o">=</span> <span class="n">MA</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>  <span class="c1"># 使用 tqsdk 自带指标函数计算均线</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;ma_MAIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">ma</span>  <span class="c1"># 在主图中画一根默认颜色（红色）的 ma 指标线</span>

<span class="c1"># 由于需要在浏览器中查看绘图结果，因此程序不能退出</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="t91">
<span id="tutorial-t91"></span><h4><a class="toc-backref" href="#id16">t91 - 在附图中画指标线</a><a class="headerlink" href="#t91" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">MA</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">画图示例: 在附图中画指标线</span>
<span class="sd">(将画图代码放在循环中即可使图像随着行情推进而更新)</span>
<span class="sd">注意: 画图示例中用到的数据不含有实际意义，请根据自己的实际策略情况进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">web_gui</span><span class="o">=</span><span class="s2">&quot;:9878&quot;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>  <span class="c1"># web_gui=&quot;[ip]:port&quot;, 指定 web 界面地址的 ip 和 port</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2105&quot;</span><span class="p">,</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># 将画图代码放在循环中即可使图像随着行情推进而更新</span>
    <span class="n">ma</span> <span class="o">=</span> <span class="n">MA</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>  <span class="c1"># 使用tqsdk自带指标函数计算均线</span>

    <span class="c1"># 示例1: 在附图中画一根绿色的ma指标线</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;ma_B2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">ma</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;ma_B2.board&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;B2&quot;</span>  <span class="c1"># 设置附图: 可以设置任意字符串,同一字符串表示同一副图</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;ma_B2.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>  <span class="c1"># 设置为绿色. 以下设置颜色方式都可行: &quot;green&quot;, &quot;#00FF00&quot;, &quot;rgb(0,255,0)&quot;, &quot;rgba(0,125,0,0.5)&quot;</span>

    <span class="c1"># 示例2: 在另一个附图画一根比ma小4的宽度为4的紫色指标线</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;ma_4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">ma</span> <span class="o">-</span> <span class="mi">4</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;ma_4.board&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MA4&quot;</span>  <span class="c1"># 设置为另一个附图</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;ma_4.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF9933CC</span>  <span class="c1"># 设置为紫色, 或者 &quot;#9933FF&quot;</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;ma_4.width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># 设置宽度为4，默认为1</span>

    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="t92">
<span id="tutorial-t92"></span><h4><a class="toc-backref" href="#id17">t92 - 主图中画信号线及文字标注</a><a class="headerlink" href="#t92" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">画图示例: 在主图中画信号线及文字标注</span>
<span class="sd">注意: 画图示例中用到的数据不含有实际意义，请根据自己的实际策略情况进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>  <span class="c1"># web_gui=True, 开启使用 web 界面查看绘图结果的功能</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2105&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

<span class="c1"># 示例1: 在主图中最后一根K线上画射线以标注需要的信号</span>
<span class="n">api</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="n">line_type</span><span class="o">=</span><span class="s2">&quot;SEG&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xFFFF9900</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># 示例2: 绘制字符串</span>
<span class="n">api</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="s2">&quot;信号1&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">high</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xFFFF3333</span><span class="p">)</span>

<span class="c1"># 示例3: 给主图最后5根K线加一个方框</span>
<span class="n">api</span><span class="o">.</span><span class="n">draw_box</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">x1</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">],</span> <span class="n">x2</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xFF0000FF</span><span class="p">,</span>
             <span class="n">bg_color</span><span class="o">=</span><span class="mh">0x7000FF00</span><span class="p">)</span>

<span class="c1"># 由于需要在浏览器中查看绘图结果，因此程序不能退出</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="t93">
<span id="tutorial-t93"></span><h4><a class="toc-backref" href="#id18">t93 - 在主图中画线和方框</a><a class="headerlink" href="#t93" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">画图示例: 在主图中画线和方框</span>
<span class="sd">注意: 画图示例中用到的数据不含有实际意义，请根据自己的实际策略情况进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span> <span class="c1"># web_gui=True, 开启使用 web 界面查看绘图结果的功能</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2105&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># 由于需要在浏览器中查看绘图结果，因此程序不能退出</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span> <span class="c1"># 当有业务信息发生变化时执行</span>
    <span class="c1"># 当最后 1 根柱子最大最小值价差大于 0.05 时，在主图绘制信号</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">high</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">low</span>
    <span class="k">if</span> <span class="n">high</span> <span class="o">-</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="c1"># 绘制直线, 每一个 id 对应同一条直线</span>
        <span class="n">api</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;box</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xaa662244</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="c1"># 绘制字符串</span>
        <span class="n">api</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="s2">&quot;信号1&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">low</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;text</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xFFFF3333</span><span class="p">)</span>

</pre></div>
</div>
</section>
<section id="t94-k">
<span id="tutorial-t94"></span><h4><a class="toc-backref" href="#id19">t94 - 在附图中画K线</a><a class="headerlink" href="#t94-k" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">画图示例: 在附图中画K线</span>
<span class="sd">注意: 画图示例中用到的数据不含有实际意义，请根据自己的实际策略情况进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2104&quot;</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>
<span class="n">klines2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2105&quot;</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># 将画图代码放在循环中即可使图像随着行情推进而更新</span>
    <span class="c1"># 在附图画出 rb2105 的K线: 需要将open、high、log、close的数据都设置正确</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;rb2105.open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines2</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;rb2105.high&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines2</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;rb2105.low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines2</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;rb2105.close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines2</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;rb2105.board&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;B2&quot;</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="t95-k">
<span id="tutorial-t95"></span><h4><a class="toc-backref" href="#id20">t95 - 附图中画K线、线段和方框</a><a class="headerlink" href="#t95-k" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">MA</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">画图示例: 在同一附图中画K线、线段和方框</span>
<span class="sd">注意: 画图示例中用到的数据不含有实际意义，请根据自己的实际策略情况进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;CFFEX.T2103&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">klines2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;CFFEX.T2012&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># 示例1 : 在附图画出 T2012 的K线: 需要将open、high、log、close的数据都设置正确</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;T2012.open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines2</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;T2012.high&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines2</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;T2012.low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines2</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;T2012.close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines2</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;T2012.board&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;B2&quot;</span>
<span class="n">ma</span> <span class="o">=</span> <span class="n">MA</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;ma_MAIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">ma</span>

<span class="c1"># 示例2: 在附图中画线段(默认为红色)</span>
<span class="n">api</span><span class="o">.</span><span class="n">draw_line</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">klines2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">klines2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;my_line&quot;</span><span class="p">,</span> <span class="n">board</span><span class="o">=</span><span class="s2">&quot;B2&quot;</span><span class="p">,</span> <span class="n">line_type</span><span class="o">=</span><span class="s2">&quot;SEG&quot;</span><span class="p">,</span>
              <span class="n">color</span><span class="o">=</span><span class="mh">0xFFFF00FF</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># 示例3: 在附图K线上画黄色的方框: 需要设置画在附图时, 将board参数选择到对应的图板即可</span>
<span class="n">api</span><span class="o">.</span><span class="n">draw_box</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">x1</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">klines2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">],</span> <span class="n">x2</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="n">klines2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;low&quot;</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;my_box&quot;</span><span class="p">,</span> <span class="n">board</span><span class="o">=</span><span class="s2">&quot;B2&quot;</span><span class="p">,</span>
             <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xFF0000FF</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="mh">0x70FFFF00</span><span class="p">)</span>

<span class="c1"># 由于需要在浏览器中查看绘图结果，因此程序不能退出</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="t96-macd">
<span id="tutorial-t96"></span><h4><a class="toc-backref" href="#id21">t96 - 附图中画MACD</a><a class="headerlink" href="#t96-macd" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;yanqiong&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">MACD</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">画图示例: 在附图中画 macd 指标示例</span>
<span class="sd">注意: 画图示例中用到的数据不含有实际意义，请根据自己的实际策略情况进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">calc_macd_klines</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
    <span class="c1"># 计算 macd 指标</span>
    <span class="n">macd</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    <span class="c1"># 用 K 线图模拟 MACD 指标柱状图</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;MACD.open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;MACD.close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;MACD.high&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;MACD.close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;MACD.close&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;MACD.low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;MACD.close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;MACD.close&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;MACD.board&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MACD&quot;</span>
    <span class="c1"># 在 board=MACD 上添加 diff、dea 线</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;diff.board&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MACD&quot;</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;diff.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;dea&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="p">[</span><span class="s2">&quot;dea&quot;</span><span class="p">]</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;dea.board&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MACD&quot;</span>
    <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;dea.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;rgb(255,128,0)&quot;</span>


<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">),</span> <span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2105&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">calc_macd_klines</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="underlying-symbol">
<span id="id3"></span><h4><a class="toc-backref" href="#id22">underlying_symbol - 获取主连映射主力合约</a><a class="headerlink" href="#underlying-symbol" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ringo&quot;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="c1"># 订阅螺纹钢主连</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;KQ.m@SHFE.rb&quot;</span><span class="p">)</span>
<span class="c1"># 打印现在螺纹钢主连的标的合约</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">underlying_symbol</span><span class="p">)</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="backtest">
<span id="tutorial-backtest"></span><h4><a class="toc-backref" href="#id23">backtest - 回测</a><a class="headerlink" href="#backtest" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqBacktest</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">如果当前价格大于5分钟K线的MA15则开多仓</span>
<span class="sd">如果小于则平仓</span>
<span class="sd">回测从 2018-05-01 到 2018-10-01</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># 在创建 api 实例时传入 TqBacktest 就会进入回测模式</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 获得 m1901 5分钟K线的引用</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;DCE.m1901&quot;</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="c1"># 创建 m1901 的目标持仓 task，该 task 负责调整 m1901 的仓位到指定的目标仓位</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;DCE.m1901&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">15</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;MA&quot;</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价大于MA: 目标多头5手&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为多头5手</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价小于MA: 目标空仓&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为空仓</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="downloader">
<span id="tutorial-downloader"></span><h4><a class="toc-backref" href="#id24">downloader - 下载数据</a><a class="headerlink" href="#downloader" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.tools</span> <span class="kn">import</span> <span class="n">DataDownloader</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 下载从 2018-01-01凌晨6点 到 2018-06-01下午4点 的 cu1805 分钟线数据</span>
<span class="n">kd</span> <span class="o">=</span> <span class="n">DataDownloader</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">symbol_list</span><span class="o">=</span><span class="s2">&quot;SHFE.cu1805&quot;</span><span class="p">,</span> <span class="n">dur_sec</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                    <span class="n">start_dt</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">csv_file_name</span><span class="o">=</span><span class="s2">&quot;kline.csv&quot;</span><span class="p">)</span>
<span class="c1"># 下载从 2018-05-01凌晨0点 到 2018-07-01凌晨0点 的 T1809 盘口Tick数据</span>
<span class="n">td</span> <span class="o">=</span> <span class="n">DataDownloader</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">symbol_list</span><span class="o">=</span><span class="s2">&quot;CFFEX.T1809&quot;</span><span class="p">,</span> <span class="n">dur_sec</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">start_dt</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">csv_file_name</span><span class="o">=</span><span class="s2">&quot;tick.csv&quot;</span><span class="p">)</span>
<span class="c1"># 使用with closing机制确保下载完成后释放对应的资源</span>
<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">api</span><span class="p">):</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">kd</span><span class="o">.</span><span class="n">is_finished</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">td</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
        <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;progress: kline: </span><span class="si">%.2f%%</span><span class="s2"> tick:</span><span class="si">%.2f%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kd</span><span class="o">.</span><span class="n">get_progress</span><span class="p">(),</span> <span class="n">td</span><span class="o">.</span><span class="n">get_progress</span><span class="p">()))</span>
</pre></div>
</div>
</section>
<section id="downloader-orders">
<span id="tutorial-downloader-orders"></span><h4><a class="toc-backref" href="#id25">downloader_orders - 下载委托单和成交记录</a><a class="headerlink" href="#downloader-orders" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;yanqiong&#39;</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqKq</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">本示例用于下载账户当前交易日到目前位置的全部委托单、成交记录分别到 orders.csv、trades.csv 文件。</span>

<span class="sd">如果文件已经存在，会将记录追加到文件末尾。</span>

<span class="sd">用户可以在交易日结束之后，运行本示例，可以将当日的委托单、成交记录保存到本地。</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="n">order_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="s2">&quot;exchange_order_id&quot;</span><span class="p">,</span> <span class="s2">&quot;exchange_id&quot;</span><span class="p">,</span> <span class="s2">&quot;instrument_id&quot;</span><span class="p">,</span> <span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_orign&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_left&quot;</span><span class="p">,</span> <span class="s2">&quot;limit_price&quot;</span><span class="p">,</span> <span class="s2">&quot;price_type&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_condition&quot;</span><span class="p">,</span> <span class="s2">&quot;time_condition&quot;</span><span class="p">,</span> <span class="s2">&quot;insert_date_time&quot;</span><span class="p">,</span> <span class="s2">&quot;last_msg&quot;</span><span class="p">]</span>
<span class="n">trade_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;trade_id&quot;</span><span class="p">,</span> <span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="s2">&quot;exchange_trade_id&quot;</span><span class="p">,</span> <span class="s2">&quot;exchange_id&quot;</span><span class="p">,</span> <span class="s2">&quot;instrument_id&quot;</span><span class="p">,</span> <span class="s2">&quot;direction&quot;</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;trade_date_time&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">write_csv</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">datas</span><span class="p">):</span>
    <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">datas</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;insert_date_time&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;insert_date_time&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;trade_date_time&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;trade_date_time&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>


<span class="k">with</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqKq</span><span class="p">(),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">api</span><span class="p">:</span>
    <span class="c1"># 将当前账户下全部委托单、成交信息写入 csv 文件中</span>
    <span class="n">write_csv</span><span class="p">(</span><span class="s2">&quot;orders.csv&quot;</span><span class="p">,</span> <span class="n">order_cols</span><span class="p">,</span> <span class="n">api</span><span class="o">.</span><span class="n">get_order</span><span class="p">())</span>
    <span class="n">write_csv</span><span class="p">(</span><span class="s2">&quot;trades.csv&quot;</span><span class="p">,</span> <span class="n">trade_cols</span><span class="p">,</span> <span class="n">api</span><span class="o">.</span><span class="n">get_trade</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="ta">
<span id="tutorial-ta"></span><h4><a class="toc-backref" href="#id26">ta - 指标计算</a><a class="headerlink" href="#ta" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 获得 cu1909 10秒K线的引用</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1910&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;K线时间&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ATR&quot;</span><span class="p">,</span> <span class="n">ATR</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">26</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BIAS&quot;</span><span class="p">,</span> <span class="n">BIAS</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BOLL&quot;</span><span class="p">,</span> <span class="n">BOLL</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DMI&quot;</span><span class="p">,</span> <span class="n">DMI</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KDJ&quot;</span><span class="p">,</span> <span class="n">KDJ</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MA&quot;</span><span class="p">,</span> <span class="n">MA</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MACD&quot;</span><span class="p">,</span> <span class="n">MACD</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SAR&quot;</span><span class="p">,</span> <span class="n">SAR</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="ta-option">
<span id="tutorial-ta-option"></span><h4><a class="toc-backref" href="#id27">ta_option - 期权指标计算</a><a class="headerlink" href="#ta-option" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!usr/bin/env python3</span>
<span class="c1">#-*- coding:utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">tafunc</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="n">underlying_quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2009&quot;</span><span class="p">)</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s1">&#39;SHFE.cu2009&#39;</span><span class="p">,</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">tafunc</span><span class="o">.</span><span class="n">get_his_volatility</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">underlying_quote</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;历史波动率:&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2009C44000&quot;</span><span class="p">)</span>
<span class="n">bs_serise</span> <span class="o">=</span> <span class="n">BS_VALUE</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;理论价:&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">bs_serise</span><span class="p">[</span><span class="s1">&#39;bs_price&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>


<span class="n">klines2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">([</span><span class="s2">&quot;SHFE.cu2009C44000&quot;</span><span class="p">,</span> <span class="s2">&quot;SHFE.cu2009&quot;</span><span class="p">],</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="n">values</span> <span class="o">=</span> <span class="n">OPTION_VALUE</span><span class="p">(</span><span class="n">klines2</span><span class="p">,</span> <span class="n">quote</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;内在价值:&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;intrins&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;时间价值:&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]))</span>

<span class="n">impv</span> <span class="o">=</span> <span class="n">OPTION_IMPV</span><span class="p">(</span><span class="n">klines2</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;隐含波动率:&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">impv</span><span class="p">[</span><span class="s1">&#39;impv&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="n">greeks</span> <span class="o">=</span> <span class="n">OPTION_GREEKS</span><span class="p">(</span><span class="n">klines2</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">impv</span><span class="p">[</span><span class="s1">&#39;impv&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;delta:&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;theta:&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gamma:&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vega:&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;vega&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rho:&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;rho&quot;</span><span class="p">]))</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="multiaccount">
<span id="tutorial-multiaccount"></span><h4><a class="toc-backref" href="#id28">multiaccount - 多账户</a><a class="headerlink" href="#multiaccount" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;hongyan&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqAccount</span><span class="p">,</span> <span class="n">TqKq</span><span class="p">,</span> <span class="n">TqSim</span><span class="p">,</span> <span class="n">TqMultiAccount</span>
<span class="c1"># 多账户模式下, 同时操作实盘、模拟交易和快期模拟账户交易</span>
<span class="n">tqact</span> <span class="o">=</span> <span class="n">TqAccount</span><span class="p">(</span><span class="s2">&quot;H海通期货&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">)</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">TqSim</span><span class="p">()</span>
<span class="n">kq</span> <span class="o">=</span> <span class="n">TqKq</span><span class="p">()</span>

<span class="k">with</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqMultiAccount</span><span class="p">([</span><span class="n">tqact</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">kq</span><span class="p">]),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">api</span><span class="p">:</span>
    <span class="n">order1</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;DCE.m2101&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="n">tqact</span><span class="p">)</span>
    <span class="n">order2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;SHFE.au2012C308&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mf">78.1</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="n">sim</span><span class="p">)</span>
    <span class="n">order3</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;SHFE.cu2101&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">51610</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="n">kq</span><span class="p">)</span>
    <span class="n">api</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">order3</span><span class="p">,</span> <span class="n">kq</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">order1</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;FINISHED&quot;</span> <span class="ow">or</span> <span class="n">order2</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">:</span>
        <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 分别获取账户资金信息</span>
    <span class="n">account_info1</span> <span class="o">=</span> <span class="n">tqact</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
    <span class="n">account_info2</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
    <span class="n">account_info3</span> <span class="o">=</span> <span class="n">kq</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
    <span class="c1"># 分别获取账户持仓信息</span>
    <span class="n">position1</span> <span class="o">=</span> <span class="n">tqact</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="s2">&quot;DCE.m2101&quot;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">position2</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="n">position3</span> <span class="o">=</span> <span class="n">kq</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="c1"># 分别获取账户委托数据</span>
    <span class="n">orders1</span> <span class="o">=</span> <span class="n">tqact</span><span class="o">.</span><span class="n">get_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="n">order1</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">orders2</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="n">orders3</span> <span class="o">=</span> <span class="n">kq</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="c1"># 分别获取账户成交数据</span>
    <span class="n">trades1</span> <span class="o">=</span> <span class="n">tqact</span><span class="o">.</span><span class="n">get_trade</span><span class="p">()</span>
    <span class="n">trades2</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">get_trade</span><span class="p">()</span>
    <span class="n">trades3</span> <span class="o">=</span> <span class="n">kq</span><span class="o">.</span><span class="n">get_trade</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<span id="document-demo/option_base"></span><section id="demo-options">
<span id="id1"></span><h3><a class="toc-backref" href="#id3">期权基本使用</a><a class="headerlink" href="#demo-options" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="id2">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#demo-options" id="id3">期权基本使用</a></p>
<ul>
<li><p><a class="reference internal" href="#o10" id="id4">o10 - 获取期权实时行情</a></p></li>
<li><p><a class="reference internal" href="#o20" id="id5">o20 - 查询符合要求的期权</a></p></li>
<li><p><a class="reference internal" href="#o30" id="id6">o30 - 查询平值/虚值/实值期权</a></p></li>
<li><p><a class="reference internal" href="#o40" id="id7">o40 - 计算期权的希腊字母</a></p></li>
<li><p><a class="reference internal" href="#o41" id="id8">o41 - 计算期权隐含波动率和历史波动率</a></p></li>
<li><p><a class="reference internal" href="#o60" id="id9">o60 - 获取期权波动率曲面</a></p></li>
<li><p><a class="reference internal" href="#o70" id="id10">o70 - 期权套利策略</a></p></li>
<li><p><a class="reference internal" href="#o71" id="id11">o71 - 获取一组期权和其对应行权价</a></p></li>
<li><p><a class="reference internal" href="#o72" id="id12">o72 - 查询标的对应期权按虚值平值实值分类方法一</a></p></li>
<li><p><a class="reference internal" href="#o73" id="id13">o73 - 查询标的对应期权按虚值平值实值分类方法二</a></p></li>
<li><p><a class="reference internal" href="#o74-etf" id="id14">o74 - 本地计算ETF期权卖方开仓保证金</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="o10">
<span id="option-tutorial-t10"></span><h4><a class="toc-backref" href="#id4">o10 - 获取期权实时行情</a><a class="headerlink" href="#o10" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;ringo&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="c1"># 创建API实例,传入自己的快期账户</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="c1"># 获取大商所豆粕期权行情</span>
<span class="n">quote_m</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;DCE.m1807-C-2450&quot;</span><span class="p">)</span>

<span class="c1"># 获取中金所股指期权行情</span>
<span class="n">quote_IO</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;CFFEX.IO2002-C-3550&quot;</span><span class="p">)</span>

<span class="c1"># 输出 m1807-C-2450 的最新行情时间和最新价</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quote_m</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">quote_m</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>

<span class="c1"># 关闭api,释放资源</span>
<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="o20">
<span id="option-tutorial-t20"></span><h4><a class="toc-backref" href="#id5">o20 - 查询符合要求的期权</a><a class="headerlink" href="#o20" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;ringo&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 标的为 &quot;SHFE.au2012&quot; 的所有期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">option_class</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 标的为 &quot;SHFE.au2012&quot; 的看跌期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">option_class</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="n">expired</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 标的为 &quot;SHFE.au2012&quot; 的看跌期权, 未下市的</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">strike_price</span><span class="o">=</span><span class="mi">340</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 标的为 &quot;SHFE.au2012&quot; 、行权价为 340 的期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SSE.000300&quot;</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s2">&quot;CFFEX&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 中金所沪深300股指期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SSE.510300&quot;</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s2">&quot;SSE&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 上交所沪深300etf期权</span>

<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SSE.510300&quot;</span><span class="p">,</span> <span class="n">exchange_id</span><span class="o">=</span><span class="s2">&quot;SSE&quot;</span><span class="p">,</span> <span class="n">exercise_year</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span> <span class="n">exercise_month</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>  <span class="c1"># 上交所沪深300etf期权, 限制条件 2020 年 12 月份行权</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="o30">
<span id="option-tutorial-t30"></span><h4><a class="toc-backref" href="#id6">o30 - 查询平值/虚值/实值期权</a><a class="headerlink" href="#o30" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;ringo&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">)</span>

<span class="c1"># 预计输出的为以au2012现在最新价来比对的认购的平值期权，当没有符合的平值期权时返回为空,如果有返回则格式为 [&quot;SHFE.au2012C30000&quot;]</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_atm_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;CALL&quot;</span><span class="p">)</span>

<span class="c1"># 预计输出的为au2012，以开盘价来比对的认购的实值3档，实值2档，实值1档期权，如果没有符合要求的期权则对应栏返回为None，如果有则返回格式例如 [None,None,&quot;SHFE.au2012C30000&quot;]</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_atm_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;CALL&quot;</span><span class="p">)</span>

<span class="c1"># 预计输出的为au2012，以开盘价来比对的认购的实值1档，平值期权，虚值1档，如果没有符合要求的期权则对应栏返回为None，如果有则返回格式例如</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_atm_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;CALL&quot;</span><span class="p">)</span>

<span class="c1"># 预计输出的为au2012，以现在最新价来比对的认购的虚值1档期权</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_atm_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2012&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;CALL&quot;</span><span class="p">)</span>

<span class="c1"># 预计输出沪深300股指期权,2020年12月的虚值1档期权</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_atm_options</span><span class="p">(</span><span class="s2">&quot;SSE.000300&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;CALL&quot;</span><span class="p">,</span> <span class="n">exercise_year</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span> <span class="n">exercise_month</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># 预计输出 上交所 沪深300股指ETF期权,2020年12月的虚值1档期权</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_atm_options</span><span class="p">(</span><span class="s2">&quot;SSE.510300&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;CALL&quot;</span><span class="p">,</span> <span class="n">exercise_year</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span> <span class="n">exercise_month</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="o40">
<span id="option-tutorial-t40"></span><h4><a class="toc-backref" href="#id7">o40 - 计算期权的希腊字母</a><a class="headerlink" href="#o40" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;ringo&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">OPTION_GREEKS</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="c1"># 获取指定期权行情</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2006C44000&quot;</span><span class="p">)</span>

<span class="c1"># 获取期权和其对应标的的多合约的 kline 数据</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">([</span><span class="s2">&quot;SHFE.cu2006C44000&quot;</span><span class="p">,</span> <span class="s2">&quot;SHFE.cu2006&quot;</span><span class="p">],</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="c1"># 运行 OPTION_GREEKS 希腊值计算函数</span>
<span class="n">greeks</span> <span class="o">=</span> <span class="n">OPTION_GREEKS</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">)</span>

<span class="c1"># 输出希腊字母</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;vega&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">greeks</span><span class="p">[</span><span class="s2">&quot;rho&quot;</span><span class="p">]))</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="o41">
<span id="option-tutorial-t41"></span><h4><a class="toc-backref" href="#id8">o41 - 计算期权隐含波动率和历史波动率</a><a class="headerlink" href="#o41" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;ringo&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">OPTION_IMPV</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="c1"># 获取指定期权行情</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2006C50000&quot;</span><span class="p">)</span>

<span class="c1"># 获取期权和对应标的的多合约 kline</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">([</span><span class="s2">&quot;SHFE.cu2006C50000&quot;</span><span class="p">,</span> <span class="s2">&quot;SHFE.cu2006&quot;</span><span class="p">],</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="c1"># 通过 OPTION_IMPV 函数计算隐含波动率，设置无风险利率为 0.025</span>
<span class="n">impv</span> <span class="o">=</span> <span class="n">OPTION_IMPV</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">impv</span><span class="p">[</span><span class="s2">&quot;impv&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="o60">
<span id="option-tutorial-t60"></span><h4><a class="toc-backref" href="#id9">o60 - 获取期权波动率曲面</a><a class="headerlink" href="#o60" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">VOLATILITY_CURVE</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="c1"># 获取 m2112 的看跌期权</span>
<span class="n">underlying</span> <span class="o">=</span> <span class="s2">&quot;DCE.m2101&quot;</span>
<span class="n">options</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="n">underlying_symbol</span><span class="o">=</span><span class="n">underlying</span><span class="p">,</span> <span class="n">option_class</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="n">expired</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 批量获取合约的行情信息, 存储结构必须为 dict, key 为合约, value 为行情数据</span>
<span class="n">quote</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
    <span class="n">quote</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
<span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">underlying</span><span class="p">)</span>

<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="c1"># 使用 VOLATILITY_CURVE 函数计算波动率曲面</span>
<span class="n">vc</span> <span class="o">=</span> <span class="n">VOLATILITY_CURVE</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">quote</span><span class="p">,</span> <span class="n">underlying</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.025</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="o70">
<span id="option-tutorial-t70"></span><h4><a class="toc-backref" href="#id10">o70 - 期权套利策略</a><a class="headerlink" href="#o70" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">如果买入看涨期权构建多头期货的价格小于卖出期货价格</span>
<span class="sd">存在套利机会则发出双边挂单</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账号密码&quot;</span><span class="p">))</span>

<span class="c1"># 获取行权价为2950的MA109看涨期权的quote数据</span>
<span class="n">quote_option</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s1">&#39;CZCE.MA109C2950&#39;</span><span class="p">)</span>

<span class="c1"># 获取期权对应标的期货，即MA109的quote数据</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">quote_option</span><span class="o">.</span><span class="n">underlying_symbol</span><span class="p">)</span>

<span class="c1"># 套利机会尝试次数</span>
<span class="n">times</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 以对手价来计算买入看涨期权然后行权后的期货成本价格</span>
    <span class="n">option_buy</span> <span class="o">=</span> <span class="n">quote_option</span><span class="o">.</span><span class="n">strike_price</span> <span class="o">+</span> <span class="n">quote_option</span><span class="o">.</span><span class="n">ask_price1</span>
    <span class="c1"># 判断当期货的买入1档，即卖出期货价格大于买入看涨期权的期货成本价格，形成套利空间时进行限价下单</span>
    <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">bid_price1</span> <span class="o">&gt;</span> <span class="n">option_buy</span> <span class="ow">and</span> <span class="n">times</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># 以现在卖1档价格买入看涨期权</span>
        <span class="n">order_opiton</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s1">&#39;CZCE.MA109C2950&#39;</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">quote_option</span><span class="o">.</span><span class="n">ask_price1</span><span class="p">)</span>
        <span class="c1"># 以现在买1档的价格卖出期货</span>
        <span class="n">order_future</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">underlying_symbol</span><span class="p">,</span> <span class="s2">&quot;SELL&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">bid_price1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;存在期货，期权套利空间尝试买入&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="o71">
<h4><a class="toc-backref" href="#id11">o71 - 获取一组期权和其对应行权价</a><a class="headerlink" href="#o71" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">获取标的对应看涨期权的期权和行权价对应列表</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账号密码&quot;</span><span class="p">))</span>

<span class="c1"># 获取沪深300股指期权的认购在市合约</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_options</span><span class="p">(</span><span class="s2">&quot;SSE.000300&quot;</span><span class="p">,</span> <span class="s2">&quot;CALL&quot;</span><span class="p">,</span> <span class="n">expired</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 批量获取这些合约的quote合约信息</span>
<span class="n">quote_ls</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote_list</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>

<span class="n">option_ls</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># 遍历quote合约信息，将合约和其对应行权价组装成字典</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">quote_ls</span><span class="p">:</span>
    <span class="n">option_ls</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">instrument_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">strike_price</span>

<span class="nb">print</span><span class="p">(</span><span class="n">option_ls</span><span class="p">)</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="o72">
<h4><a class="toc-backref" href="#id12">o72 - 查询标的对应期权按虚值平值实值分类方法一</a><a class="headerlink" href="#o72" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">tqsdk.tafunc</span> <span class="kn">import</span> <span class="n">time_to_datetime</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">查询标的对应期权按虚值平值实值分类</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.au2112&quot;</span><span class="p">)</span>
<span class="n">in_money_options</span><span class="p">,</span> <span class="n">at_money_options</span><span class="p">,</span> <span class="n">out_of_money_options</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_all_level_options</span><span class="p">(</span><span class="s2">&quot;SHFE.au2112&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="s2">&quot;CALL&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">in_money_options</span><span class="p">)</span>  <span class="c1"># 实值期权列表</span>
<span class="nb">print</span><span class="p">(</span><span class="n">at_money_options</span><span class="p">)</span>  <span class="c1"># 平值期权列表</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out_of_money_options</span><span class="p">)</span>  <span class="c1"># 虚值期权列表</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="o73">
<h4><a class="toc-backref" href="#id13">o73 - 查询标的对应期权按虚值平值实值分类方法二</a><a class="headerlink" href="#o73" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">tqsdk.tafunc</span> <span class="kn">import</span> <span class="n">time_to_datetime</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">查询标的对应期权按虚值平值实值分类</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SSE.510300&quot;</span><span class="p">)</span>

<span class="c1"># 获取下月的上交所看涨300etf期权</span>
<span class="n">in_money_options</span><span class="p">,</span> <span class="n">at_money_options</span><span class="p">,</span> <span class="n">out_of_money_options</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">query_all_level_finance_options</span><span class="p">(</span><span class="s2">&quot;SSE.510300&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="s2">&quot;CALL&quot;</span><span class="p">,</span> <span class="n">nearbys</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">in_money_options</span><span class="p">)</span>  <span class="c1"># 实值期权列表</span>
<span class="nb">print</span><span class="p">(</span><span class="n">at_money_options</span><span class="p">)</span>  <span class="c1"># 平值期权列表</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out_of_money_options</span><span class="p">)</span>  <span class="c1"># 虚值期权列表</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="o74-etf">
<h4><a class="toc-backref" href="#id14">o74 - 本地计算ETF期权卖方开仓保证金</a><a class="headerlink" href="#o74-etf" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">根据输入的ETF期权来查询该期权的交易所规则下的理论卖方保证金，实际情况请以期货公司收取的一手保证金为准</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">etf_margin_cal</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
    <span class="n">quote_etf</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="c1"># 判断期权标的是不是ETF</span>
    <span class="k">if</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">underlying_symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SSE.510050&quot;</span><span class="p">,</span> <span class="s2">&quot;SSE.510300&quot;</span><span class="p">,</span> <span class="s2">&quot;SZSE.159919&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">option_class</span> <span class="o">==</span> <span class="s2">&quot;CALL&quot;</span><span class="p">:</span>
            <span class="c1"># 认购期权虚值＝Max（行权价-合约标的前收盘价，0）</span>
            <span class="n">call_out_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">quote_etf</span><span class="o">.</span><span class="n">strike_price</span> <span class="o">-</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">underlying_quote</span><span class="o">.</span><span class="n">pre_close</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># 认购期权义务仓开仓保证金＝[合约前结算价+Max（12%×合约标的前收盘价-认购期权虚值，7%×合约标的前收盘价）]×合约单位</span>
            <span class="n">call_margin</span> <span class="o">=</span> <span class="p">(</span><span class="n">quote_etf</span><span class="o">.</span><span class="n">pre_settlement</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.12</span> <span class="o">*</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">underlying_quote</span><span class="o">.</span><span class="n">pre_close</span> <span class="o">-</span> <span class="n">call_out_value</span><span class="p">,</span>
                                                          <span class="mf">0.07</span> <span class="o">*</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">underlying_quote</span><span class="o">.</span><span class="n">pre_close</span><span class="p">))</span> <span class="o">*</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">volume_multiple</span>
            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">call_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">option_class</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
            <span class="c1"># 认沽期权虚值＝Max（合约标的前收盘价-行权价，0）</span>
            <span class="n">put_out_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">quote_etf</span><span class="o">.</span><span class="n">underlying_quote</span><span class="o">.</span><span class="n">pre_close</span> <span class="o">-</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">strike_price</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># 认沽期权义务仓开仓保证金＝Min[合约前结算价+Max（12%×合约标的前收盘价-认沽期权虚值，7%×行权价），行权价]×合约单位。</span>
            <span class="n">put_margin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">quote_etf</span><span class="o">.</span><span class="n">pre_settlement</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.12</span> <span class="o">*</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">underlying_quote</span><span class="o">.</span><span class="n">pre_close</span> <span class="o">-</span> <span class="n">put_out_value</span><span class="p">,</span>
                                                            <span class="mf">0.07</span> <span class="o">*</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">strike_price</span><span class="p">),</span>
                             <span class="n">quote_etf</span><span class="o">.</span><span class="n">strike_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">quote_etf</span><span class="o">.</span><span class="n">volume_multiple</span>
            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">put_margin</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;输入的不是ETF期权合约&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="c1"># 创建api</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="c1"># 深交所300etf期权</span>
<span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;SZSE.90000833&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="n">etf_margin_cal</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<span id="document-demo/algorithm"></span><section id="demo-algorithm">
<span id="id1"></span><h3><a class="toc-backref" href="#id3">算法模块示例</a><a class="headerlink" href="#demo-algorithm" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="id2">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#demo-algorithm" id="id3">算法模块示例</a></p>
<ul>
<li><p><a class="reference internal" href="#twap-table" id="id4">twap_table - 时间平均加权算法</a></p></li>
<li><p><a class="reference internal" href="#vwap-table" id="id5">vwap_table - 交易量平均加权算法</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="twap-table">
<span id="demo-algorithm-twap"></span><h4><a class="toc-backref" href="#id4">twap_table - 时间平均加权算法</a><a class="headerlink" href="#twap-table" title="Permalink to this headline">¶</a></h4>
</section>
<section id="vwap-table">
<span id="demo-algorithm-vwap"></span><h4><a class="toc-backref" href="#id5">vwap_table - 交易量平均加权算法</a><a class="headerlink" href="#vwap-table" title="Permalink to this headline">¶</a></h4>
</section>
</section>
<span id="document-demo/strategy"></span><section id="demo-strategy">
<span id="id1"></span><h3><a class="toc-backref" href="#id11">交易策略示例</a><a class="headerlink" href="#demo-strategy" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="id2">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#demo-strategy" id="id11">交易策略示例</a></p>
<ul>
<li><p><a class="reference internal" href="#aberration" id="id12">Aberration 策略 (难度：初级)</a></p></li>
<li><p><a class="reference internal" href="#doublema" id="id13">Doublema 双均线策略 (难度：初级)</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id14">价格动量策略 (难度：初级)</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id15">自动扶梯策略 (难度：初级)</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id16">菲阿里四价 策略 (难度：初级)</a></p></li>
<li><p><a class="reference internal" href="#r-breaker" id="id17">R-Breaker 交易策略 - 隔夜留仓 (难度：初级)</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id18">R-Breaker 交易策略 - 非隔夜留仓 (难度：初级)</a></p></li>
<li><p><a class="reference internal" href="#dual-thrust" id="id19">Dual Thrust 策略 (难度：中级)</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id20">网格交易策略 (难度：中级)</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id21">网格交易策略 - 异步代码 (难度：中级)</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id22">随机森林 (难度：中级)</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id23">海龟交易策略 (难度：中级)</a></p></li>
<li><p><a class="reference internal" href="#volume-weighted-average-price" id="id24">Volume Weighted Average Price 策略 (难度：高级)</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="aberration">
<h4><a class="toc-backref" href="#id12">Aberration 策略 (难度：初级)</a><a class="headerlink" href="#aberration" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/aberration/">https://www.shinnytech.com/blog/aberration/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ringo&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Aberration策略 (难度：初级)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/aberration/</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">BOLL</span>

<span class="c1"># 设置合约代码</span>
<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;DCE.m2105&quot;</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>


<span class="c1"># 使用BOLL指标计算中轨、上轨和下轨，其中26为周期N  ，2为参数p</span>
<span class="k">def</span> <span class="nf">boll_line</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
    <span class="n">boll</span> <span class="o">=</span> <span class="n">BOLL</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">midline</span> <span class="o">=</span> <span class="n">boll</span><span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">topline</span> <span class="o">=</span> <span class="n">boll</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bottomline</span> <span class="o">=</span> <span class="n">boll</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;策略运行，中轨：</span><span class="si">%.2f</span><span class="s2">，上轨为:</span><span class="si">%.2f</span><span class="s2">，下轨为:</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">midline</span><span class="p">,</span> <span class="n">topline</span><span class="p">,</span> <span class="n">bottomline</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">midline</span><span class="p">,</span> <span class="n">topline</span><span class="p">,</span> <span class="n">bottomline</span>


<span class="n">midline</span><span class="p">,</span> <span class="n">topline</span><span class="p">,</span> <span class="n">bottomline</span> <span class="o">=</span> <span class="n">boll_line</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 每次生成新的K线时重新计算BOLL指标</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">midline</span><span class="p">,</span> <span class="n">topline</span><span class="p">,</span> <span class="n">bottomline</span> <span class="o">=</span> <span class="n">boll_line</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>

    <span class="c1"># 每次最新价发生变化时进行判断</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>
        <span class="c1"># 判断开仓条件</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_long</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_short</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 如果最新价大于上轨，K线上穿上轨，开多仓</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">topline</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;K线上穿上轨，开多仓&quot;</span><span class="p">)</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
            <span class="c1"># 如果最新价小于轨，K线下穿下轨，开空仓</span>
            <span class="k">elif</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">bottomline</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;K线下穿下轨，开空仓&quot;</span><span class="p">)</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前最新价</span><span class="si">%.2f</span><span class="s2">,未穿上轨或下轨，不开仓&quot;</span> <span class="o">%</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>

        <span class="c1"># 在多头情况下，空仓条件</span>
        <span class="k">elif</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_long</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 如果最新价低于中线，多头清仓离场</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">midline</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价低于中线，多头清仓离场&quot;</span><span class="p">)</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前多仓，未穿越中线，仓位无变化&quot;</span><span class="p">)</span>

        <span class="c1"># 在空头情况下，空仓条件</span>
        <span class="k">elif</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_short</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 如果最新价高于中线，空头清仓离场</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">midline</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价高于中线，空头清仓离场&quot;</span><span class="p">)</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前空仓，未穿越中线，仓位无变化&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="doublema">
<h4><a class="toc-backref" href="#id13">Doublema 双均线策略 (难度：初级)</a><a class="headerlink" href="#doublema" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">双均线策略</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>
<span class="kn">from</span> <span class="nn">tqsdk.tafunc</span> <span class="kn">import</span> <span class="n">ma</span>

<span class="n">SHORT</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 短周期</span>
<span class="n">LONG</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># 长周期</span>
<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;SHFE.bu2012&quot;</span>  <span class="c1"># 合约代码</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;策略开始运行&quot;</span><span class="p">)</span>

<span class="n">data_length</span> <span class="o">=</span> <span class="n">LONG</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># k线数据长度</span>
<span class="c1"># &quot;duration_seconds=60&quot;为一分钟线, 日线的duration_seconds参数为: 24*60*60</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">data_length</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>  <span class="c1"># 产生新k线:重新计算SMA</span>
        <span class="n">short_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">SHORT</span><span class="p">)</span>  <span class="c1"># 短周期</span>
        <span class="n">long_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">LONG</span><span class="p">)</span>  <span class="c1"># 长周期</span>

        <span class="c1"># 均线下穿，做空</span>
        <span class="k">if</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线下穿，做空&quot;</span><span class="p">)</span>

        <span class="c1"># 均线上穿，做多</span>
        <span class="k">if</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线上穿，做多&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4><a class="toc-backref" href="#id14">价格动量策略 (难度：初级)</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/momentum-strategy/">https://www.shinnytech.com/blog/momentum-strategy/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ringo&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">价格动量 策略 (难度：初级)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/momentum-strategy/</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="c1"># 设置指定合约,获取N条K线计算价格动量</span>
<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;SHFE.au2012&quot;</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">AR</span><span class="p">(</span><span class="n">kline1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;价格动量函数AR，以前N-1日K线计算价格动量ar&quot;&quot;&quot;</span>
    <span class="n">spread_ho</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">kline1</span><span class="o">.</span><span class="n">high</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">kline1</span><span class="o">.</span><span class="n">open</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">spread_oc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">kline1</span><span class="o">.</span><span class="n">open</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">kline1</span><span class="o">.</span><span class="n">low</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># spread_oc 为0时，设置为最小价格跳动值</span>
    <span class="k">if</span> <span class="n">spread_oc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">spread_oc</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">price_tick</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="n">spread_ho</span> <span class="o">/</span> <span class="n">spread_oc</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="n">ar</span>


<span class="n">ar</span> <span class="o">=</span> <span class="n">AR</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;策略开始启动&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 生成新K线时，重新计算价格动量值ar</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">AR</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;价格动量是：&quot;</span><span class="p">,</span> <span class="n">ar</span><span class="p">)</span>
    <span class="c1"># 每次最新价发生变动时，重新进行判断</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>
        <span class="c1"># 开仓策略</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_long</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_short</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 如果ar大于110并且小于150，开多仓</span>
            <span class="k">if</span> <span class="mi">110</span> <span class="o">&lt;</span> <span class="n">ar</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;价值动量超过110，小于150，做多&quot;</span><span class="p">)</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="c1"># 如果ar大于50，小于90，开空仓</span>
            <span class="k">elif</span> <span class="mi">50</span> <span class="o">&lt;</span> <span class="n">ar</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;价值动量大于50，小于90，做空&quot;</span><span class="p">)</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># 止损策略，多头下当前ar值小于90则平仓止损，空头下当前ar值大于110则平仓止损</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">pos_long</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ar</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">pos_short</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ar</span> <span class="o">&gt;</span> <span class="mi">110</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;止损平仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id4">
<h4><a class="toc-backref" href="#id15">自动扶梯策略 (难度：初级)</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/escalator/">https://www.shinnytech.com/blog/escalator/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Ringo&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">自动扶梯 策略 (难度：初级)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/escalator/</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">MA</span>

<span class="c1"># 设置合约</span>
<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;SHFE.rb2012&quot;</span>
<span class="c1"># 设置均线长短周期</span>
<span class="n">MA_SLOW</span><span class="p">,</span> <span class="n">MA_FAST</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">40</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>


<span class="c1"># K线收盘价在这根K线波动范围函数</span>


<span class="k">def</span> <span class="nf">kline_range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">kl_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">close</span> <span class="o">-</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">)</span> <span class="o">/</span> \
               <span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kl_range</span>


<span class="c1"># 获取长短均线值</span>
<span class="k">def</span> <span class="nf">ma_caculate</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
    <span class="n">ma_slow</span> <span class="o">=</span> <span class="n">MA</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">MA_SLOW</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ma</span>
    <span class="n">ma_fast</span> <span class="o">=</span> <span class="n">MA</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">MA_FAST</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ma</span>
    <span class="k">return</span> <span class="n">ma_slow</span><span class="p">,</span> <span class="n">ma_fast</span>


<span class="n">ma_slow</span><span class="p">,</span> <span class="n">ma_fast</span> <span class="o">=</span> <span class="n">ma_caculate</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;慢速均线为</span><span class="si">%.2f</span><span class="s2">,快速均线为</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ma_slow</span><span class="p">,</span> <span class="n">ma_fast</span><span class="p">))</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 每次k线更新，重新计算快慢均线</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">ma_slow</span><span class="p">,</span> <span class="n">ma_fast</span> <span class="o">=</span> <span class="n">ma_caculate</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;慢速均线为</span><span class="si">%.2f</span><span class="s2">,快速均线为</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ma_slow</span><span class="p">,</span> <span class="n">ma_fast</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>
        <span class="c1"># 开仓判断</span>
        <span class="k">if</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_long</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_short</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 计算前后两根K线在当时K线范围波幅</span>
            <span class="n">kl_range_cur</span> <span class="o">=</span> <span class="n">kline_range</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">kl_range_pre</span> <span class="o">=</span> <span class="n">kline_range</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="c1"># 开多头判断，最近一根K线收盘价在短期均线和长期均线之上，前一根K线收盘价位于K线波动范围底部25%，最近这根K线收盘价位于K线波动范围顶部25%</span>
            <span class="k">if</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">close</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">ma_slow</span><span class="p">,</span> <span class="n">ma_fast</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kl_range_pre</span> <span class="o">&lt;=</span> <span class="mf">0.25</span> <span class="ow">and</span> <span class="n">kl_range_cur</span> <span class="o">&gt;=</span> <span class="mf">0.75</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价为:</span><span class="si">%.2f</span><span class="s2"> 开多头&quot;</span> <span class="o">%</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

            <span class="c1"># 开空头判断，最近一根K线收盘价在短期均线和长期均线之下，前一根K线收盘价位于K线波动范围顶部25%，最近这根K线收盘价位于K线波动范围底部25%</span>
            <span class="k">elif</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">close</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">ma_slow</span><span class="p">,</span> <span class="n">ma_fast</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kl_range_pre</span> <span class="o">&gt;=</span> <span class="mf">0.75</span> <span class="ow">and</span> <span class="n">kl_range_cur</span> <span class="o">&lt;=</span> <span class="mf">0.25</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价为:</span><span class="si">%.2f</span><span class="s2"> 开空头&quot;</span> <span class="o">%</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价位:</span><span class="si">%.2f</span><span class="s2"> ，未满足开仓条件&quot;</span> <span class="o">%</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>

        <span class="c1"># 多头持仓止损策略</span>
        <span class="k">elif</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_long</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 在两根K线较低点减一跳，进行多头止损</span>
            <span class="n">kline_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">low</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">close</span> <span class="o">&lt;=</span> <span class="n">kline_low</span> <span class="o">-</span> <span class="n">quote</span><span class="o">.</span><span class="n">price_tick</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价为:</span><span class="si">%.2f</span><span class="s2">,进行多头止损&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">))</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;多头持仓，当前价格 </span><span class="si">%.2f</span><span class="s2">,多头离场价格</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="n">kline_low</span> <span class="o">-</span> <span class="n">quote</span><span class="o">.</span><span class="n">price_tick</span><span class="p">))</span>

        <span class="c1"># 空头持仓止损策略</span>
        <span class="k">elif</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_short</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># 在两根K线较高点加一跳，进行空头止损</span>
            <span class="n">kline_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">high</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">close</span> <span class="o">&gt;=</span> <span class="n">kline_high</span> <span class="o">+</span> <span class="n">quote</span><span class="o">.</span><span class="n">price_tick</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价为:</span><span class="si">%.2f</span><span class="s2"> 进行空头止损&quot;</span> <span class="o">%</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;空头持仓，当前价格 </span><span class="si">%.2f</span><span class="s2">,空头离场价格</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="n">kline_high</span> <span class="o">+</span> <span class="n">quote</span><span class="o">.</span><span class="n">price_tick</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="id5">
<h4><a class="toc-backref" href="#id16">菲阿里四价 策略 (难度：初级)</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/fairy-four-price/">https://www.shinnytech.com/blog/fairy-four-price/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">菲阿里四价 策略(日内突破策略, 在每日收盘前对所持合约进行平仓)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/fairy-four-price/</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;SHFE.ni2012&quot;</span>  <span class="c1"># 合约代码</span>
<span class="n">close_hour</span><span class="p">,</span> <span class="n">close_minute</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">50</span>  <span class="c1"># 平仓时间</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>  <span class="c1"># 使用模拟帐号直连行情和交易服务器</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>  <span class="c1"># 获取指定合约的盘口行情</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># 获取日线</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>  <span class="c1"># 持仓信息</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>  <span class="c1"># 目标持仓</span>

<span class="n">top_rail</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 上轨: 昨日高点</span>
<span class="n">bottom_rail</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 下轨: 昨日低点</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;上轨:&quot;</span><span class="p">,</span> <span class="n">top_rail</span><span class="p">,</span> <span class="s2">&quot;,下轨:&quot;</span><span class="p">,</span> <span class="n">bottom_rail</span><span class="p">,</span> <span class="s2">&quot;,昨日收盘价:&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;,今日开盘价:&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">open</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>  <span class="c1"># 如果产生一根新日线 (即到达下一个交易日): 重新获取上下轨</span>
        <span class="n">top_rail</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">bottom_rail</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;上轨:&quot;</span><span class="p">,</span> <span class="n">top_rail</span><span class="p">,</span> <span class="s2">&quot;,下轨:&quot;</span><span class="p">,</span> <span class="n">bottom_rail</span><span class="p">,</span> <span class="s2">&quot;,昨日收盘价:&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;,今日开盘价:&quot;</span><span class="p">,</span> <span class="n">klines</span><span class="o">.</span><span class="n">open</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>  <span class="c1"># 如果行情最新价发生变化</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前最新价&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>
        <span class="c1"># 开仓突破</span>
        <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">top_rail</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_long</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 如果价格突破上轨: 买入开仓</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价:&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="s2">&quot;, 价格突破上轨,买入开仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 设置目标持仓手数，将指定合约调整到目标头寸</span>
        <span class="k">elif</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">bottom_rail</span> <span class="ow">and</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_short</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 如果价格跌破下轨: 卖出开仓</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价:&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="s2">&quot;, 价格跌破下轨, 卖出开仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># 平仓止损: 当价格 向上突破上轨 或 向下突破下轨 后, 再次回破当日开盘价</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">highest</span> <span class="o">&gt;</span> <span class="n">top_rail</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;=</span> <span class="n">quote</span><span class="o">.</span><span class="n">open</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">quote</span><span class="o">.</span><span class="n">lowest</span> <span class="o">&lt;</span> <span class="n">bottom_rail</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;=</span> <span class="n">quote</span><span class="o">.</span><span class="n">open</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;平仓止损&quot;</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">now_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 获取当前的行情时间</span>
        <span class="k">if</span> <span class="n">now_time</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">close_hour</span> <span class="ow">and</span> <span class="n">now_time</span><span class="o">.</span><span class="n">minute</span> <span class="o">&gt;=</span> <span class="n">close_minute</span><span class="p">:</span>  <span class="c1"># 到达平仓时间: 平仓</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;临近本交易日收盘: 平仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">60</span>  <span class="c1"># 设置截止时间为当前时间的60秒以后</span>
            <span class="k">while</span> <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">(</span><span class="n">deadline</span><span class="o">=</span><span class="n">deadline</span><span class="p">):</span>  <span class="c1"># 等待60秒</span>
                <span class="k">pass</span>
            <span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭api</span>
            <span class="k">break</span>  <span class="c1"># 退出while循环</span>
</pre></div>
</div>
</section>
<section id="r-breaker">
<h4><a class="toc-backref" href="#id17">R-Breaker 交易策略 - 隔夜留仓 (难度：初级)</a><a class="headerlink" href="#r-breaker" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/r-breaker/">https://www.shinnytech.com/blog/r-breaker/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">R-Breaker策略(隔夜留仓) (难度：初级)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/r-breaker</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;SHFE.au2006&quot;</span>  <span class="c1"># 合约代码</span>
<span class="n">STOP_LOSS_PRICE</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 止损点(价格)</span>


<span class="k">def</span> <span class="nf">get_index_line</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;计算指标线&#39;&#39;&#39;</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 前一日的最高价</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 前一日的最低价</span>
    <span class="n">close</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 前一日的收盘价</span>

    <span class="n">pivot</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>  <span class="c1"># 枢轴点</span>
    <span class="n">b_break</span> <span class="o">=</span> <span class="n">high</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">pivot</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>  <span class="c1"># 突破买入价</span>
    <span class="n">s_setup</span> <span class="o">=</span> <span class="n">pivot</span> <span class="o">+</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>  <span class="c1"># 观察卖出价</span>
    <span class="n">s_enter</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pivot</span> <span class="o">-</span> <span class="n">low</span>  <span class="c1"># 反转卖出价</span>
    <span class="n">b_enter</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pivot</span> <span class="o">-</span> <span class="n">high</span>  <span class="c1"># 反转买入价</span>
    <span class="n">b_setup</span> <span class="o">=</span> <span class="n">pivot</span> <span class="o">-</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>  <span class="c1"># 观察买入价</span>
    <span class="n">s_break</span> <span class="o">=</span> <span class="n">low</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">pivot</span><span class="p">)</span>  <span class="c1"># 突破卖出价</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;已计算新标志线, 枢轴点: </span><span class="si">%f</span><span class="s2">, 突破买入价: </span><span class="si">%f</span><span class="s2">, 观察卖出价: </span><span class="si">%f</span><span class="s2">, 反转卖出价: </span><span class="si">%f</span><span class="s2">, 反转买入价: </span><span class="si">%f</span><span class="s2">, 观察买入价: </span><span class="si">%f</span><span class="s2">, 突破卖出价: </span><span class="si">%f</span><span class="s2">&quot;</span>
          <span class="o">%</span> <span class="p">(</span><span class="n">pivot</span><span class="p">,</span> <span class="n">b_break</span><span class="p">,</span> <span class="n">s_setup</span><span class="p">,</span> <span class="n">s_enter</span><span class="p">,</span> <span class="n">b_enter</span><span class="p">,</span> <span class="n">b_setup</span><span class="p">,</span> <span class="n">s_break</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">b_break</span><span class="p">,</span> <span class="n">s_setup</span><span class="p">,</span> <span class="n">s_enter</span><span class="p">,</span> <span class="n">b_enter</span><span class="p">,</span> <span class="n">b_setup</span><span class="p">,</span> <span class="n">s_break</span>


<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># 86400: 使用日线</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">target_pos_value</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_long</span> <span class="o">-</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_short</span>  <span class="c1"># 目标净持仓数</span>
<span class="n">open_position_price</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">open_price_long</span> <span class="k">if</span> <span class="n">target_pos_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">position</span><span class="o">.</span><span class="n">open_price_short</span>  <span class="c1"># 开仓价</span>
<span class="n">pivot</span><span class="p">,</span> <span class="n">b_break</span><span class="p">,</span> <span class="n">s_setup</span><span class="p">,</span> <span class="n">s_enter</span><span class="p">,</span> <span class="n">b_enter</span><span class="p">,</span> <span class="n">b_setup</span><span class="p">,</span> <span class="n">s_break</span> <span class="o">=</span> <span class="n">get_index_line</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>  <span class="c1"># 七条标准线</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="n">target_pos_value</span><span class="p">)</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>  <span class="c1"># 产生新k线,则重新计算7条指标线</span>
        <span class="n">pivot</span><span class="p">,</span> <span class="n">b_break</span><span class="p">,</span> <span class="n">s_setup</span><span class="p">,</span> <span class="n">s_enter</span><span class="p">,</span> <span class="n">b_enter</span><span class="p">,</span> <span class="n">b_setup</span><span class="p">,</span> <span class="n">s_break</span> <span class="o">=</span> <span class="n">get_index_line</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;交易规则&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价: &quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>

        <span class="c1"># 开仓价与当前行情价之差大于止损点则止损</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">target_pos_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">open_position_price</span> <span class="o">-</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;=</span> <span class="n">STOP_LOSS_PRICE</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">target_pos_value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">-</span> <span class="n">open_position_price</span> <span class="o">&gt;=</span> <span class="n">STOP_LOSS_PRICE</span><span class="p">):</span>
            <span class="n">target_pos_value</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 平仓</span>

        <span class="c1"># 反转:</span>
        <span class="k">if</span> <span class="n">target_pos_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 多头持仓</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">highest</span> <span class="o">&gt;</span> <span class="n">s_setup</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">s_enter</span><span class="p">:</span>
                <span class="c1"># 多头持仓,当日内最高价超过观察卖出价后，</span>
                <span class="c1"># 盘中价格出现回落，且进一步跌破反转卖出价构成的支撑线时，</span>
                <span class="c1"># 采取反转策略，即在该点位反手做空</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;多头持仓,当日内最高价超过观察卖出价后跌破反转卖出价: 反手做空&quot;</span><span class="p">)</span>
                <span class="n">target_pos_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>  <span class="c1"># 做空</span>
                <span class="n">open_position_price</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span>
        <span class="k">elif</span> <span class="n">target_pos_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 空头持仓</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">lowest</span> <span class="o">&lt;</span> <span class="n">b_setup</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">b_enter</span><span class="p">:</span>
                <span class="c1"># 空头持仓，当日内最低价低于观察买入价后，</span>
                <span class="c1"># 盘中价格出现反弹，且进一步超过反转买入价构成的阻力线时，</span>
                <span class="c1"># 采取反转策略，即在该点位反手做多</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;空头持仓,当日最低价低于观察买入价后超过反转买入价: 反手做多&quot;</span><span class="p">)</span>
                <span class="n">target_pos_value</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 做多</span>
                <span class="n">open_position_price</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span>

        <span class="c1"># 突破:</span>
        <span class="k">elif</span> <span class="n">target_pos_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 空仓条件</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">b_break</span><span class="p">:</span>
                <span class="c1"># 在空仓的情况下，如果盘中价格超过突破买入价，</span>
                <span class="c1"># 则采取趋势策略，即在该点位开仓做多</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;空仓,盘中价格超过突破买入价: 开仓做多&quot;</span><span class="p">)</span>
                <span class="n">target_pos_value</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 做多</span>
                <span class="n">open_position_price</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span>
            <span class="k">elif</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">s_break</span><span class="p">:</span>
                <span class="c1"># 在空仓的情况下，如果盘中价格跌破突破卖出价，</span>
                <span class="c1"># 则采取趋势策略，即在该点位开仓做空</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;空仓,盘中价格跌破突破卖出价: 开仓做空&quot;</span><span class="p">)</span>
                <span class="n">target_pos_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>  <span class="c1"># 做空</span>
                <span class="n">open_position_price</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span>
</pre></div>
</div>
</section>
<section id="id6">
<h4><a class="toc-backref" href="#id18">R-Breaker 交易策略 - 非隔夜留仓 (难度：初级)</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/r-breaker/">https://www.shinnytech.com/blog/r-breaker/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># !/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">R-Breaker策略(非隔夜留仓: 在每日收盘前，对所持合约进行平仓)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/r-breaker</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;SHFE.au2006&quot;</span>  <span class="c1"># 合约代码</span>
<span class="n">CLOSE_HOUR</span><span class="p">,</span> <span class="n">CLOSE_MINUTE</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">50</span>  <span class="c1"># 平仓时间</span>
<span class="n">STOP_LOSS_PRICE</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 止损点(价格)</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;策略开始运行&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_index_line</span><span class="p">(</span><span class="n">klines</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;计算指标线&#39;&#39;&#39;</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 前一日的最高价</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 前一日的最低价</span>
    <span class="n">close</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 前一日的收盘价</span>
    <span class="n">pivot</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">+</span> <span class="n">low</span> <span class="o">+</span> <span class="n">close</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>  <span class="c1"># 枢轴点</span>
    <span class="n">b_break</span> <span class="o">=</span> <span class="n">high</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">pivot</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>  <span class="c1"># 突破买入价</span>
    <span class="n">s_setup</span> <span class="o">=</span> <span class="n">pivot</span> <span class="o">+</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>  <span class="c1"># 观察卖出价</span>
    <span class="n">s_enter</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pivot</span> <span class="o">-</span> <span class="n">low</span>  <span class="c1"># 反转卖出价</span>
    <span class="n">b_enter</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pivot</span> <span class="o">-</span> <span class="n">high</span>  <span class="c1"># 反转买入价</span>
    <span class="n">b_setup</span> <span class="o">=</span> <span class="n">pivot</span> <span class="o">-</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span>  <span class="c1"># 观察买入价</span>
    <span class="n">s_break</span> <span class="o">=</span> <span class="n">low</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">pivot</span><span class="p">)</span>  <span class="c1"># 突破卖出价</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;已计算新标志线, 枢轴点: </span><span class="si">%f</span><span class="s2">, 突破买入价: </span><span class="si">%f</span><span class="s2">, 观察卖出价: </span><span class="si">%f</span><span class="s2">, 反转卖出价: </span><span class="si">%f</span><span class="s2">, 反转买入价: </span><span class="si">%f</span><span class="s2">, 观察买入价: </span><span class="si">%f</span><span class="s2">, 突破卖出价: </span><span class="si">%f</span><span class="s2">&quot;</span>
          <span class="o">%</span> <span class="p">(</span><span class="n">pivot</span><span class="p">,</span> <span class="n">b_break</span><span class="p">,</span> <span class="n">s_setup</span><span class="p">,</span> <span class="n">s_enter</span><span class="p">,</span> <span class="n">b_enter</span><span class="p">,</span> <span class="n">b_setup</span><span class="p">,</span> <span class="n">s_break</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">b_break</span><span class="p">,</span> <span class="n">s_setup</span><span class="p">,</span> <span class="n">s_enter</span><span class="p">,</span> <span class="n">b_enter</span><span class="p">,</span> <span class="n">b_setup</span><span class="p">,</span> <span class="n">s_break</span>


<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># 86400: 使用日线</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">target_pos_value</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_long</span> <span class="o">-</span> <span class="n">position</span><span class="o">.</span><span class="n">pos_short</span>  <span class="c1"># 目标净持仓数</span>
<span class="n">open_position_price</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">open_price_long</span> <span class="k">if</span> <span class="n">target_pos_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">position</span><span class="o">.</span><span class="n">open_price_short</span>  <span class="c1"># 开仓价</span>
<span class="n">pivot</span><span class="p">,</span> <span class="n">b_break</span><span class="p">,</span> <span class="n">s_setup</span><span class="p">,</span> <span class="n">s_enter</span><span class="p">,</span> <span class="n">b_enter</span><span class="p">,</span> <span class="n">b_setup</span><span class="p">,</span> <span class="n">s_break</span> <span class="o">=</span> <span class="n">get_index_line</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>  <span class="c1"># 七条标准线</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="n">target_pos_value</span><span class="p">)</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>  <span class="c1"># 产生新k线,则重新计算7条指标线</span>
        <span class="n">pivot</span><span class="p">,</span> <span class="n">b_break</span><span class="p">,</span> <span class="n">s_setup</span><span class="p">,</span> <span class="n">s_enter</span><span class="p">,</span> <span class="n">b_enter</span><span class="p">,</span> <span class="n">b_setup</span><span class="p">,</span> <span class="n">s_break</span> <span class="o">=</span> <span class="n">get_index_line</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">CLOSE_HOUR</span> <span class="ow">and</span> <span class="n">now</span><span class="o">.</span><span class="n">minute</span> <span class="o">&gt;=</span> <span class="n">CLOSE_MINUTE</span><span class="p">:</span>  <span class="c1"># 到达平仓时间: 平仓</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;临近本交易日收盘: 平仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos_value</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 平仓</span>
            <span class="n">pivot</span> <span class="o">=</span> <span class="n">b_break</span> <span class="o">=</span> <span class="n">s_setup</span> <span class="o">=</span> <span class="n">s_enter</span> <span class="o">=</span> <span class="n">b_enter</span> <span class="o">=</span> <span class="n">b_setup</span> <span class="o">=</span> <span class="n">s_break</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>  <span class="c1"># 修改各指标线的值, 避免平仓后再次触发</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;交易规则&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>

        <span class="c1"># 开仓价与当前行情价之差大于止损点则止损</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">target_pos_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">open_position_price</span> <span class="o">-</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;=</span> <span class="n">STOP_LOSS_PRICE</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">target_pos_value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">-</span> <span class="n">open_position_price</span> <span class="o">&gt;=</span> <span class="n">STOP_LOSS_PRICE</span><span class="p">):</span>
            <span class="n">target_pos_value</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 平仓</span>

        <span class="c1"># 反转:</span>
        <span class="k">if</span> <span class="n">target_pos_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 多头持仓</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">highest</span> <span class="o">&gt;</span> <span class="n">s_setup</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">s_enter</span><span class="p">:</span>
                <span class="c1"># 多头持仓,当日内最高价超过观察卖出价后，</span>
                <span class="c1"># 盘中价格出现回落，且进一步跌破反转卖出价构成的支撑线时，</span>
                <span class="c1"># 采取反转策略，即在该点位反手做空</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;多头持仓,当日内最高价超过观察卖出价后跌破反转卖出价: 反手做空&quot;</span><span class="p">)</span>
                <span class="n">target_pos_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>  <span class="c1"># 做空</span>
                <span class="n">open_position_price</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span>
        <span class="k">elif</span> <span class="n">target_pos_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 空头持仓</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">lowest</span> <span class="o">&lt;</span> <span class="n">b_setup</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">b_enter</span><span class="p">:</span>
                <span class="c1"># 空头持仓，当日内最低价低于观察买入价后，</span>
                <span class="c1"># 盘中价格出现反弹，且进一步超过反转买入价构成的阻力线时，</span>
                <span class="c1"># 采取反转策略，即在该点位反手做多</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;空头持仓,当日最低价低于观察买入价后超过反转买入价: 反手做多&quot;</span><span class="p">)</span>
                <span class="n">target_pos_value</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 做多</span>
                <span class="n">open_position_price</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span>

        <span class="c1"># 突破:</span>
        <span class="k">elif</span> <span class="n">target_pos_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 空仓条件</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">b_break</span><span class="p">:</span>
                <span class="c1"># 在空仓的情况下，如果盘中价格超过突破买入价，</span>
                <span class="c1"># 则采取趋势策略，即在该点位开仓做多</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;空仓,盘中价格超过突破买入价: 开仓做多&quot;</span><span class="p">)</span>
                <span class="n">target_pos_value</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 做多</span>
                <span class="n">open_position_price</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span>
            <span class="k">elif</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">s_break</span><span class="p">:</span>
                <span class="c1"># 在空仓的情况下，如果盘中价格跌破突破卖出价，</span>
                <span class="c1"># 则采取趋势策略，即在该点位开仓做空</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;空仓,盘中价格跌破突破卖出价: 开仓做空&quot;</span><span class="p">)</span>
                <span class="n">target_pos_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>  <span class="c1"># 做空</span>
                <span class="n">open_position_price</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span>
</pre></div>
</div>
</section>
<section id="dual-thrust">
<h4><a class="toc-backref" href="#id19">Dual Thrust 策略 (难度：中级)</a><a class="headerlink" href="#dual-thrust" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/dual-thrust/">https://www.shinnytech.com/blog/dual-thrust/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Dual Thrust策略 (难度：中级)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/dual-thrust</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;DCE.jd2011&quot;</span>  <span class="c1"># 合约代码</span>
<span class="n">NDAY</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 天数</span>
<span class="n">K1</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># 上轨K值</span>
<span class="n">K2</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># 下轨K值</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;策略开始运行&quot;</span><span class="p">)</span>

<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># 86400使用日线</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dual_thrust</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="n">klines</span><span class="p">):</span>
    <span class="n">current_open</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;open&quot;</span><span class="p">]</span>
    <span class="n">HH</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">NDAY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># N日最高价的最高价</span>
    <span class="n">HC</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">NDAY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># N日收盘价的最高价</span>
    <span class="n">LC</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">NDAY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># N日收盘价的最低价</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">NDAY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># N日最低价的最低价</span>
    <span class="nb">range</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">HH</span> <span class="o">-</span> <span class="n">LC</span><span class="p">,</span> <span class="n">HC</span> <span class="o">-</span> <span class="n">LL</span><span class="p">)</span>
    <span class="n">buy_line</span> <span class="o">=</span> <span class="n">current_open</span> <span class="o">+</span> <span class="nb">range</span> <span class="o">*</span> <span class="n">K1</span>  <span class="c1"># 上轨</span>
    <span class="n">sell_line</span> <span class="o">=</span> <span class="n">current_open</span> <span class="o">-</span> <span class="nb">range</span> <span class="o">*</span> <span class="n">K2</span>  <span class="c1"># 下轨</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前开盘价: </span><span class="si">%f</span><span class="s2">, 上轨: </span><span class="si">%f</span><span class="s2">, 下轨: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_open</span><span class="p">,</span> <span class="n">buy_line</span><span class="p">,</span> <span class="n">sell_line</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">buy_line</span><span class="p">,</span> <span class="n">sell_line</span>


<span class="n">buy_line</span><span class="p">,</span> <span class="n">sell_line</span> <span class="o">=</span> <span class="n">dual_thrust</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="n">klines</span><span class="p">)</span>  <span class="c1"># 获取上下轨</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;open&quot;</span><span class="p">]):</span>  <span class="c1"># 新产生一根日线或开盘价发生变化: 重新计算上下轨</span>
        <span class="n">buy_line</span><span class="p">,</span> <span class="n">sell_line</span> <span class="o">=</span> <span class="n">dual_thrust</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="n">klines</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">buy_line</span><span class="p">:</span>  <span class="c1"># 高于上轨</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;高于上轨,目标持仓 多头3手&quot;</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 交易</span>
        <span class="k">elif</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">sell_line</span><span class="p">:</span>  <span class="c1"># 低于下轨</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;低于下轨,目标持仓 空头3手&quot;</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 交易</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;未穿越上下轨,不调整持仓&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id7">
<h4><a class="toc-backref" href="#id20">网格交易策略 (难度：中级)</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/grid-trading/">https://www.shinnytech.com/blog/grid-trading/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">网格交易策略 (难度：中级)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/grid-trading/</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;DCE.jd2011&quot;</span>  <span class="c1"># 合约代码</span>
<span class="n">START_PRICE</span> <span class="o">=</span> <span class="mi">4247</span>  <span class="c1"># 起始价位</span>
<span class="n">GRID_AMOUNT</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 网格在多头、空头方向的格子(档位)数量</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">grid_region_long</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">]</span> <span class="o">*</span> <span class="n">GRID_AMOUNT</span>  <span class="c1"># 多头每格价格跌幅(网格密度)</span>
<span class="n">grid_region_short</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">]</span> <span class="o">*</span> <span class="n">GRID_AMOUNT</span>  <span class="c1"># 空头每格价格涨幅(网格密度)</span>
<span class="n">grid_volume_long</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GRID_AMOUNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># 多头每格持仓手数</span>
<span class="n">grid_volume_short</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">GRID_AMOUNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># 空头每格持仓手数</span>
<span class="n">grid_prices_long</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="n">grid_region_long</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">START_PRICE</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">GRID_AMOUNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># 多头每格的触发价位列表</span>
<span class="n">grid_prices_short</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span> <span class="n">grid_region_short</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">START_PRICE</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                     <span class="nb">range</span><span class="p">(</span><span class="n">GRID_AMOUNT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># 空头每格的触发价位列表</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;策略开始运行, 起始价位: </span><span class="si">%f</span><span class="s2">, 多头每格持仓手数:</span><span class="si">%s</span><span class="s2">, 多头每格的价位:</span><span class="si">%s</span><span class="s2">, 空头每格的价位:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
<span class="n">START_PRICE</span><span class="p">,</span> <span class="n">grid_volume_long</span><span class="p">,</span> <span class="n">grid_prices_long</span><span class="p">,</span> <span class="n">grid_prices_short</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>  <span class="c1"># 行情数据</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>  <span class="c1"># 持仓信息</span>


<span class="k">def</span> <span class="nf">wait_price</span><span class="p">(</span><span class="n">layer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;等待行情最新价变动到其他档位,则进入下一档位或回退到上一档位; 如果从下一档位回退到当前档位,则设置为当前对应的持仓手数;</span>
<span class="sd">        layer : 当前所在第几个档位层次; layer&gt;0 表示多头方向, layer&lt;0 表示空头方向</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">layer</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;=</span> <span class="n">grid_prices_long</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># 是多头方向</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
            <span class="c1"># 如果当前档位小于最大档位,并且最新价小于等于下一个档位的价格: 则设置为下一档位对应的手数后进入下一档位层次</span>
            <span class="k">if</span> <span class="n">layer</span> <span class="o">&lt;</span> <span class="n">GRID_AMOUNT</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;=</span> <span class="n">grid_prices_long</span><span class="p">[</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="n">grid_volume_long</span><span class="p">[</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价: </span><span class="si">%f</span><span class="s2">, 进入: 多头第 </span><span class="si">%d</span><span class="s2"> 档&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">wait_price</span><span class="p">(</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c1"># 从下一档位回退到当前档位后, 设置回当前对应的持仓手数</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="n">grid_volume_long</span><span class="p">[</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="c1"># 如果最新价大于当前档位的价格: 则回退到上一档位</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">grid_prices_long</span><span class="p">[</span><span class="n">layer</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价: </span><span class="si">%f</span><span class="s2">, 回退到: 多头第 </span><span class="si">%d</span><span class="s2"> 档&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                <span class="k">return</span>
    <span class="k">elif</span> <span class="n">layer</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;=</span> <span class="n">grid_prices_short</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># 是空头方向</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="o">-</span><span class="n">layer</span>  <span class="c1"># 转为正数便于计算</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
            <span class="c1"># 如果当前档位小于最大档位层次,并且最新价大于等于下一个档位的价格: 则设置为下一档位对应的持仓手数后进入下一档位层次</span>
            <span class="k">if</span> <span class="n">layer</span> <span class="o">&lt;</span> <span class="n">GRID_AMOUNT</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;=</span> <span class="n">grid_prices_short</span><span class="p">[</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="n">grid_volume_short</span><span class="p">[</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价: </span><span class="si">%f</span><span class="s2">, 进入: 空头第 </span><span class="si">%d</span><span class="s2"> 档&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">wait_price</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="c1"># 从下一档位回退到当前档位后, 设置回当前对应的持仓手数</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="n">grid_volume_short</span><span class="p">[</span><span class="n">layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="c1"># 如果最新价小于当前档位的价格: 则回退到上一档位</span>
            <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">grid_prices_short</span><span class="p">[</span><span class="n">layer</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价: </span><span class="si">%f</span><span class="s2">, 回退到: 空头第 </span><span class="si">%d</span><span class="s2"> 档&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="n">layer</span><span class="p">))</span>
                <span class="k">return</span>


<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="n">wait_price</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 从第0层开始进入网格</span>
    <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id8">
<h4><a class="toc-backref" href="#id21">网格交易策略 - 异步代码 (难度：中级)</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/grid-trading/">https://www.shinnytech.com/blog/grid-trading/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;chengzhi&#39;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">网格交易策略</span>
<span class="sd">参考: https://www.shinnytech.com/blog/grid-trading/</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="c1"># 网格计划参数:</span>
<span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;DCE.jd2011&quot;</span>  <span class="c1"># 合约代码</span>
<span class="n">start_price</span> <span class="o">=</span> <span class="mi">4247</span>  <span class="c1"># 起始价位</span>
<span class="n">grid_amount</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 网格在多头、空头方向的格子(档位)数量</span>
<span class="n">grid_region_long</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_amount</span>  <span class="c1"># 多头每格价格跌幅(网格密度)</span>
<span class="n">grid_region_short</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_amount</span>  <span class="c1"># 空头每格价格涨幅(网格密度)</span>
<span class="n">grid_volume_long</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_amount</span>  <span class="c1"># 多头每格交易手数</span>
<span class="n">grid_volume_short</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">grid_amount</span>  <span class="c1"># 空头每格交易手数</span>
<span class="n">grid_prices_long</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">r</span><span class="p">),</span> <span class="n">grid_region_long</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">start_price</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_amount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># 多头每格的触发价位列表, 第一个元素为起始价位</span>
<span class="n">grid_prices_short</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">r</span><span class="p">),</span> <span class="n">grid_region_short</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">start_price</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_amount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># 空头每格的触发价位列表, 第一个元素为起始价位</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;起始价位:&quot;</span><span class="p">,</span> <span class="n">start_price</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;多头每格交易量:&quot;</span><span class="p">,</span> <span class="n">grid_volume_long</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;多头每格的价位:&quot;</span><span class="p">,</span> <span class="n">grid_prices_long</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;空头每格的价位:&quot;</span><span class="p">,</span> <span class="n">grid_prices_short</span><span class="p">)</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>  <span class="c1"># 行情数据</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
<span class="n">target_volume</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 目标持仓手数</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">price_watcher</span><span class="p">(</span><span class="n">open_price</span><span class="p">,</span> <span class="n">close_price</span><span class="p">,</span> <span class="n">volume</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;该task在价格触发开仓价时开仓，触发平仓价时平仓&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">target_volume</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">api</span><span class="o">.</span><span class="n">register_update_notify</span><span class="p">(</span><span class="n">quote</span><span class="p">)</span> <span class="k">as</span> <span class="n">update_chan</span><span class="p">:</span>  <span class="c1"># 当 quote 有更新时会发送通知到 update_chan 上</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">update_chan</span><span class="p">:</span>  <span class="c1"># 当从 update_chan 上收到行情更新通知时判断是否触发开仓条件</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;=</span> <span class="n">open_price</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;=</span> <span class="n">open_price</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="n">target_volume</span> <span class="o">+=</span> <span class="n">volume</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="n">target_volume</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;时间:&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">&quot;最新价:&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="s2">&quot;开仓&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="s2">&quot;手&quot;</span><span class="p">,</span> <span class="s2">&quot;总仓位:&quot;</span><span class="p">,</span> <span class="n">target_volume</span><span class="p">,</span> <span class="s2">&quot;手&quot;</span><span class="p">)</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">update_chan</span><span class="p">:</span>  <span class="c1"># 当从 update_chan 上收到行情更新通知时判断是否触发平仓条件</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="n">close_price</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="n">close_price</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="n">target_volume</span> <span class="o">-=</span> <span class="n">volume</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="n">target_volume</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;时间:&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">&quot;最新价:&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">,</span> <span class="s2">&quot;平仓&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="s2">&quot;手&quot;</span><span class="p">,</span> <span class="s2">&quot;总仓位:&quot;</span><span class="p">,</span> <span class="n">target_volume</span><span class="p">,</span> <span class="s2">&quot;手&quot;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_amount</span><span class="p">):</span>
    <span class="n">api</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">price_watcher</span><span class="p">(</span><span class="n">grid_prices_long</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid_prices_long</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">grid_volume_long</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">api</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">price_watcher</span><span class="p">(</span><span class="n">grid_prices_short</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid_prices_short</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">grid_volume_short</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">api</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id9">
<h4><a class="toc-backref" href="#id22">随机森林 (难度：中级)</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqBacktest</span><span class="p">,</span> <span class="n">BacktestFinished</span><span class="p">,</span> <span class="n">TargetPosTask</span>
<span class="kn">from</span> <span class="nn">tqsdk.tafunc</span> <span class="kn">import</span> <span class="n">sma</span><span class="p">,</span> <span class="n">ema2</span><span class="p">,</span> <span class="n">trma</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># 设置Pandas显示的行数</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># 设置Pandas显示的宽度</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">应用随机森林对某交易日涨跌情况的预测(使用sklearn包)</span>
<span class="sd">参考:https://www.joinquant.com/post/1571</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;SHFE.ru1811&quot;</span>  <span class="c1"># 交易合约代码</span>
<span class="n">close_hour</span><span class="p">,</span> <span class="n">close_minute</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">50</span>  <span class="c1"># 预定收盘时间(因为真实收盘后无法进行交易, 所以提前设定收盘时间)</span>


<span class="k">def</span> <span class="nf">get_prediction_data</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;获取用于随机森林的n个输入数据(n为数据长度): n天中每天的特征参数及其涨跌情况&quot;&quot;&quot;</span>
    <span class="n">close_prices</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="p">[</span><span class="o">-</span> <span class="mi">30</span> <span class="o">-</span> <span class="n">n</span><span class="p">:]</span>  <span class="c1"># 获取本交易日及以前的收盘价(此时在预定的收盘时间: 认为本交易日已收盘)</span>
    <span class="c1"># 计算所需指标</span>
    <span class="n">sma_data</span> <span class="o">=</span> <span class="n">sma</span><span class="p">(</span><span class="n">close_prices</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>  <span class="c1"># SMA指标, 函数默认时间周期参数:30</span>
    <span class="n">wma_data</span> <span class="o">=</span> <span class="n">ema2</span><span class="p">(</span><span class="n">close_prices</span><span class="p">,</span> <span class="mi">30</span><span class="p">)[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>  <span class="c1"># WMA指标</span>
    <span class="n">mom_data</span> <span class="o">=</span> <span class="n">trma</span><span class="p">(</span><span class="n">close_prices</span><span class="p">,</span> <span class="mi">30</span><span class="p">)[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>  <span class="c1"># MOM指标</span>
    <span class="n">x_all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sma_data</span><span class="p">,</span> <span class="n">wma_data</span><span class="p">,</span> <span class="n">mom_data</span><span class="p">))</span>  <span class="c1"># 样本特征组</span>
    <span class="n">y_all</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))))</span>  <span class="c1"># 样本标签组</span>
    <span class="c1"># x_all:            大前天指标 前天指标 昨天指标 (今天指标)</span>
    <span class="c1"># y_all:   (大前天)    前天     昨天    今天      -明天-</span>
    <span class="c1"># 准备算法需要用到的数据</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_all</span><span class="p">[:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 训练数据: 特征</span>
    <span class="n">x_predict</span> <span class="o">=</span> <span class="n">x_all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 预测数据(用本交易日的指标预测下一交易日的涨跌)</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_all</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># 训练数据: 标签 (去掉第一个数据后让其与指标隔一位对齐(例如: 昨天的特征 -&gt; 对应预测今天的涨跌标签))</span>

    <span class="k">return</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_predict</span>


<span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 用于记录每次的预测结果(在每个交易日收盘时用收盘数据预测下一交易日的涨跌,并记录在此列表里)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">26</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># 日线</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">api</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>  <span class="c1"># 等到达下一个交易日</span>
                <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
                <span class="c1"># 在收盘后预测下一交易日的涨跌情况</span>
                <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
                    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 当前quote的时间</span>
                    <span class="c1"># 判断是否到达预定收盘时间: 如果到达 则认为本交易日收盘, 此时预测下一交易日的涨跌情况, 并调整为对应仓位</span>
                    <span class="k">if</span> <span class="n">now</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="n">close_hour</span> <span class="ow">and</span> <span class="n">now</span><span class="o">.</span><span class="n">minute</span> <span class="o">&gt;=</span> <span class="n">close_minute</span><span class="p">:</span>
                        <span class="c1"># 1- 获取数据</span>
                        <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_predict</span> <span class="o">=</span> <span class="n">get_prediction_data</span><span class="p">(</span><span class="n">klines</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>  <span class="c1"># 参数1: K线, 参数2:需要的数据长度</span>

                        <span class="c1"># 2- 利用机器学习算法预测下一个交易日的涨跌情况</span>
                        <span class="c1"># n_estimators 参数: 选择森林里（决策）树的数目; bootstrap 参数: 选择建立决策树时，是否使用有放回抽样</span>
                        <span class="n">clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>  <span class="c1"># 传入训练数据, 进行参数训练</span>
                        <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">x_predict</span><span class="p">])))</span>  <span class="c1"># 传入测试数据进行预测, 得到预测的结果</span>

                        <span class="c1"># 3- 进行交易</span>
                        <span class="k">if</span> <span class="n">predictions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># 如果预测结果为涨: 买入</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">&quot;预测下一交易日为 涨&quot;</span><span class="p">)</span>
                            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果预测结果为跌: 卖出</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">&quot;预测下一交易日为 跌&quot;</span><span class="p">)</span>
                            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
                        <span class="k">break</span>

    <span class="k">except</span> <span class="n">BacktestFinished</span><span class="p">:</span>  <span class="c1"># 回测结束, 获取预测结果，统计正确率</span>
        <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;pre_close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 增加 pre_close(上一交易日的收盘价) 字段</span>
        <span class="n">klines</span> <span class="o">=</span> <span class="n">klines</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>  <span class="c1"># 取出在回测日期内的K线数据</span>
        <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 增加预测的本交易日涨跌情况字段(向后移一个数据目的: 将 本交易日对应下一交易日的涨跌 调整为 本交易日对应本交易日的涨跌)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;pre_close&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">klines</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----回测结束----&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;预测结果正误:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;预测结果数目统计: 总计&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span><span class="s2">&quot;个预测结果&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;预测的准确率:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">((</span><span class="n">pd</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">results</span><span class="p">)[</span><span class="kc">True</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="id10">
<h4><a class="toc-backref" href="#id23">海龟交易策略 (难度：中级)</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/turtle/">https://www.shinnytech.com/blog/turtle/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">海龟策略 (难度：中级)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/turtle/</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>
<span class="kn">from</span> <span class="nn">tqsdk.ta</span> <span class="kn">import</span> <span class="n">ATR</span>


<span class="k">class</span> <span class="nc">Turtle</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">donchian_channel_open_position</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                 <span class="n">donchian_channel_stop_profit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">atr_day_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_risk_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">account</span>  <span class="c1"># 交易账号</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span>  <span class="c1"># 快期账户</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span>  <span class="c1"># 合约代码</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_open_position</span> <span class="o">=</span> <span class="n">donchian_channel_open_position</span>  <span class="c1"># 唐奇安通道的天数周期(开仓)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_stop_profit</span> <span class="o">=</span> <span class="n">donchian_channel_stop_profit</span>  <span class="c1"># 唐奇安通道的天数周期(止盈)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atr_day_length</span> <span class="o">=</span> <span class="n">atr_day_length</span>  <span class="c1"># ATR计算所用天数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_ratio</span> <span class="o">=</span> <span class="n">max_risk_ratio</span>  <span class="c1"># 最高风险度</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 本策略净持仓数(正数表示多头，负数表示空头，0表示空仓)</span>
            <span class="s2">&quot;last_price&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>  <span class="c1"># 上次调仓价</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 平均真实波幅(N值)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 买卖单位</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_high</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 唐奇安通道上轨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_low</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 唐奇安通道下轨</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
        <span class="c1"># 由于ATR是路径依赖函数，因此使用更长的数据序列进行计算以便使其值稳定下来</span>
        <span class="n">kline_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">donchian_channel_open_position</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">donchian_channel_stop_profit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atr_day_length</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">klines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">kline_length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recalc_paramter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 平均真实波幅(N值)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">ATR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atr_day_length</span><span class="p">)[</span><span class="s2">&quot;atr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># 买卖单位</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">volume_multiple</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>
        <span class="c1"># 唐奇安通道上轨：前N个交易日的最高价</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klines</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_open_position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># 唐奇安通道下轨：前N个交易日的最低价</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klines</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_open_position</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;唐其安通道上下轨: </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_high</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_low</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">set_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">[</span><span class="s2">&quot;last_price&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">try_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;开仓策略&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>  <span class="c1"># 如果产生新k线,则重新计算唐奇安通道及买卖单位</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recalc_paramter</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_high</span><span class="p">:</span>  <span class="c1"># 当前价&gt;唐奇安通道上轨，买入1个Unit；(持多仓)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前价&gt;唐奇安通道上轨，买入1个Unit(持多仓): </span><span class="si">%d</span><span class="s2"> 手&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_low</span><span class="p">:</span>  <span class="c1"># 当前价&lt;唐奇安通道下轨，卖出1个Unit；(持空仓)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前价&lt;唐奇安通道下轨，卖出1个Unit(持空仓): </span><span class="si">%d</span><span class="s2"> 手&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">try_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;交易策略&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">,</span> <span class="s2">&quot;last_price&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;最新价: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 持多单</span>
                    <span class="c1"># 加仓策略: 如果是多仓且行情最新价在上一次建仓（或者加仓）的基础上又上涨了0.5N，就再加一个Unit的多仓,并且风险度在设定范围内(以防爆仓)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span>
                        <span class="s2">&quot;last_price&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">risk_ratio</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_ratio</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;加仓:加1个Unit的多仓&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
                    <span class="c1"># 止损策略: 如果是多仓且行情最新价在上一次建仓（或者加仓）的基础上又下跌了2N，就卖出全部头寸止损</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;止损:卖出全部头寸&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># 止盈策略: 如果是多仓且行情最新价跌破了10日唐奇安通道的下轨，就清空所有头寸结束策略,离场</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klines</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_stop_profit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;止盈:清空所有头寸结束策略,离场&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 持空单</span>
                    <span class="c1"># 加仓策略: 如果是空仓且行情最新价在上一次建仓（或者加仓）的基础上又下跌了0.5N，就再加一个Unit的空仓,并且风险度在设定范围内(以防爆仓)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span>
                        <span class="s2">&quot;last_price&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">risk_ratio</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_risk_ratio</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;加仓:加1个Unit的空仓&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
                    <span class="c1"># 止损策略: 如果是空仓且行情最新价在上一次建仓（或者加仓）的基础上又上涨了2N，就平仓止损</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_price&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;止损:卖出全部头寸&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># 止盈策略: 如果是空仓且行情最新价升破了10日唐奇安通道的上轨，就清空所有头寸结束策略,离场</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klines</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">donchian_channel_stop_profit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;止盈:清空所有头寸结束策略,离场&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;海龟策略&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;等待K线及账户数据...&quot;</span><span class="p">)</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recalc_paramter</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">(</span><span class="n">deadline</span><span class="o">=</span><span class="n">deadline</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;获取数据失败，请确认行情连接正常并已经登录交易账户&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">try_open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">try_close</span><span class="p">()</span>


<span class="n">turtle</span> <span class="o">=</span> <span class="n">Turtle</span><span class="p">(</span><span class="s2">&quot;SHFE.au2006&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;策略开始运行&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">turtle</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;turtle_state.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span>  <span class="c1"># 读取数据: 本策略目标净持仓数,上一次开仓价</span>
<span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前持仓数: </span><span class="si">%d</span><span class="s2">, 上次调仓价: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">turtle</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">],</span> <span class="n">turtle</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_price&quot;</span><span class="p">]))</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">turtle</span><span class="o">.</span><span class="n">strategy</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">turtle</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">turtle</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;turtle_state.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">))</span>  <span class="c1"># 保存数据</span>
</pre></div>
</div>
</section>
<section id="volume-weighted-average-price">
<h4><a class="toc-backref" href="#id24">Volume Weighted Average Price 策略 (难度：高级)</a><a class="headerlink" href="#volume-weighted-average-price" title="Permalink to this headline">¶</a></h4>
<p>策略说明 <a class="reference external" href="https://www.shinnytech.com/blog/vwap/">https://www.shinnytech.com/blog/vwap/</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#  -*- coding: utf-8 -*-</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;limin&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Volume Weighted Average Price策略 (难度：高级)</span>
<span class="sd">参考: https://www.shinnytech.com/blog/vwap</span>
<span class="sd">注: 该示例策略仅用于功能示范, 实盘时请根据自己的策略/经验进行修改</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">TIME_CELL</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># 等时长下单的时间单元, 单位: 秒</span>
<span class="n">TARGET_VOLUME</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># 目标交易手数 (&gt;0: 多头, &lt;0: 空头)</span>
<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;DCE.jd2001&quot;</span>  <span class="c1"># 交易合约代码</span>
<span class="n">HISTORY_DAY_LENGTH</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># 使用多少天的历史数据用来计算每个时间单元的下单手数</span>
<span class="n">START_HOUR</span><span class="p">,</span> <span class="n">START_MINUTE</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">35</span>  <span class="c1"># 计划交易时段起始时间点</span>
<span class="n">END_HOUR</span><span class="p">,</span> <span class="n">END_MINUTE</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span>  <span class="c1"># 计划交易时段终点时间点</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;策略开始运行&quot;</span><span class="p">)</span>
<span class="c1"># 根据 HISTORY_DAY_LENGTH 推算出需要订阅的历史数据长度, 需要注意history_day_length与time_cell的比例关系以避免超过订阅限制</span>
<span class="n">time_slot_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">START_HOUR</span><span class="p">,</span> <span class="n">START_MINUTE</span><span class="p">)</span>  <span class="c1"># 计划交易时段起始时间点</span>
<span class="n">time_slot_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">END_HOUR</span><span class="p">,</span> <span class="n">END_MINUTE</span><span class="p">)</span>  <span class="c1"># 计划交易时段终点时间点</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">TIME_CELL</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">TIME_CELL</span> <span class="o">*</span> <span class="n">HISTORY_DAY_LENGTH</span><span class="p">))</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>  <span class="c1"># 持仓信息</span>


<span class="k">def</span> <span class="nf">get_kline_time</span><span class="p">(</span><span class="n">kline_datetime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;获取k线的时间(不包含日期)&quot;&quot;&quot;</span>
    <span class="n">kline_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">kline_datetime</span> <span class="o">//</span> <span class="mi">1000000000</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># 每根k线的时间</span>
    <span class="k">return</span> <span class="n">kline_time</span>


<span class="k">def</span> <span class="nf">get_market_day</span><span class="p">(</span><span class="n">kline_datetime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;获取k线所对应的交易日&quot;&quot;&quot;</span>
    <span class="n">kline_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">kline_datetime</span> <span class="o">//</span> <span class="mi">1000000000</span><span class="p">)</span>  <span class="c1"># 每根k线的日期和时间</span>
    <span class="k">if</span> <span class="n">kline_dt</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">:</span>  <span class="c1"># 当天18点以后: 移到下一个交易日</span>
        <span class="n">kline_dt</span> <span class="o">=</span> <span class="n">kline_dt</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">kline_dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># 是周六或周日,移到周一</span>
        <span class="n">kline_dt</span> <span class="o">=</span> <span class="n">kline_dt</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kline_dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>


<span class="c1"># 添加辅助列: time及date, 分别为K线时间的时:分:秒和其所属的交易日</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_kline_time</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_market_day</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># 获取在预设交易时间段内的所有K线, 即时间位于 time_slot_start 到 time_slot_end 之间的数据</span>
<span class="k">if</span> <span class="n">time_slot_end</span> <span class="o">&gt;</span> <span class="n">time_slot_start</span><span class="p">:</span>  <span class="c1"># 判断是否类似 23:00:00 开始， 01:00:00 结束这样跨天的情况</span>
    <span class="n">klines</span> <span class="o">=</span> <span class="n">klines</span><span class="p">[(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">time_slot_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">time_slot_end</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">klines</span> <span class="o">=</span> <span class="n">klines</span><span class="p">[(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">time_slot_start</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">time_slot_end</span><span class="p">)]</span>

<span class="c1"># 由于可能有节假日导致部分天并没有填满整个预设交易时间段</span>
<span class="c1"># 因此去除缺失部分交易时段的日期(即剩下的每个日期都包含预设的交易时间段内所需的全部时间单元)</span>
<span class="n">date_cnt</span> <span class="o">=</span> <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">max_num</span> <span class="o">=</span> <span class="n">date_cnt</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c1"># 所有日期中最完整的交易时段长度</span>
<span class="n">need_date</span> <span class="o">=</span> <span class="n">date_cnt</span><span class="p">[</span><span class="n">date_cnt</span> <span class="o">==</span> <span class="n">max_num</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="n">HISTORY_DAY_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 获取今天以前的预设数目个交易日的日期</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">klines</span><span class="p">[</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">need_date</span><span class="p">)]</span>  <span class="c1"># 最终用来计算的k线数据</span>

<span class="c1"># 计算每个时间单元的成交量占比, 并使用算数平均计算出预测值</span>
<span class="n">datetime_grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># 将K线的volume按照date、time建立多重索引分组</span>
<span class="c1"># 计算每个交易日内的预设交易时间段内的成交量总和(level=0: 表示按第一级索引&quot;data&quot;来分组)后,将每根k线的成交量除以所在交易日内的总成交量,计算其所占比例</span>
<span class="n">volume_percent</span> <span class="o">=</span> <span class="n">datetime_grouped</span> <span class="o">/</span> <span class="n">datetime_grouped</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">predicted_percent</span> <span class="o">=</span> <span class="n">volume_percent</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># 将历史上相同时间单元的成交量占比使用算数平均计算出预测值</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;各时间单元成交量占比: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">predicted_percent</span><span class="p">)</span>

<span class="c1"># 计算每个时间单元的成交量预测值</span>
<span class="n">predicted_volume</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 记录每个时间单元需调整的持仓量</span>
<span class="n">percentage_left</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 剩余比例</span>
<span class="n">volume_left</span> <span class="o">=</span> <span class="n">TARGET_VOLUME</span>  <span class="c1"># 剩余手数</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">predicted_percent</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">volume_left</span> <span class="o">*</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">percentage_left</span><span class="p">))</span>
    <span class="n">predicted_volume</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
    <span class="n">percentage_left</span> <span class="o">-=</span> <span class="n">value</span>
    <span class="n">volume_left</span> <span class="o">-=</span> <span class="n">volume</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;各时间单元应下单手数: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">predicted_volume</span><span class="p">)</span>

<span class="c1"># 交易</span>
<span class="n">current_volume</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 记录已调整持仓量</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 新产生一根K线并且在计划交易时间段内: 调整目标持仓量</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">1000000000</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">predicted_volume</span><span class="p">:</span>
            <span class="n">current_volume</span> <span class="o">+=</span> <span class="n">predicted_volume</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;到达下一时间单元,调整持仓为: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">current_volume</span><span class="p">)</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="n">current_volume</span><span class="p">)</span>
    <span class="c1"># 用持仓信息判断是否完成所有目标交易手数</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="s2">&quot;volume_long&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="s2">&quot;volume_short&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="s2">&quot;volume_long&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="s2">&quot;volume_short&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">TARGET_VOLUME</span><span class="p">:</span>
            <span class="k">break</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</div>
</section>
<span id="document-reference/index"></span><section id="tqsdk">
<span id="tqsdk-apis"></span><h2>TqSdk 模块参考<a class="headerlink" href="#tqsdk" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-reference/tqsdk.api"></span><section id="tqsdk-tqapi">
<span id="tqsdk-api"></span><h3>tqsdk.TqApi - 框架及核心业务<a class="headerlink" href="#tqsdk-tqapi" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.auth"></span><section id="tqsdk-tqauth">
<span id="tqsdk-auth"></span><h3>tqsdk.TqAuth - 用户认证类<a class="headerlink" href="#tqsdk-tqauth" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.account"></span><section id="tqsdk-tqaccount">
<span id="tqsdk-account"></span><h3>tqsdk.TqAccount - 实盘账户类<a class="headerlink" href="#tqsdk-tqaccount" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.tqkq"></span><section id="tqsdk-tqkq">
<span id="id1"></span><h3>tqsdk.TqKq - 快期模拟交易类<a class="headerlink" href="#tqsdk-tqkq" title="Permalink to this headline">¶</a></h3>
</section>
<section id="tqsdk-tqkqstock">
<span id="tqsdk-tqkq-stock"></span><h3>tqsdk.TqKqStock - 快期股票模拟交易类<a class="headerlink" href="#tqsdk-tqkqstock" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.sim"></span><section id="tqsdk-tqsim">
<span id="tqsdk-sim"></span><h3>tqsdk.TqSim - 本地模拟交易<a class="headerlink" href="#tqsdk-tqsim" title="Permalink to this headline">¶</a></h3>
</section>
<section id="tqsdk-tqsimstock">
<span id="tqsdk-sim-stock"></span><h3>tqsdk.TqSimStock - 本地股票模拟交易<a class="headerlink" href="#tqsdk-tqsimstock" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.multiaccount"></span><section id="tqsdk-tqmultiaccount">
<span id="tqsdk-multiaccount"></span><h3>tqsdk.TqMultiAccount - 多账户<a class="headerlink" href="#tqsdk-tqmultiaccount" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.objs"></span><section id="tqsdk-objs">
<span id="id1"></span><h3>tqsdk.objs - 业务对象<a class="headerlink" href="#tqsdk-objs" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.lib"></span><section id="tqsdk-lib">
<span id="id1"></span><h3>tqsdk.lib - 业务工具库<a class="headerlink" href="#tqsdk-lib" title="Permalink to this headline">¶</a></h3>
<section id="tqsdk-tqnotify">
<span id="tqsdk-lib-notify"></span><h4>tqsdk.TqNotify - 收集通知信息工具<a class="headerlink" href="#tqsdk-tqnotify" title="Permalink to this headline">¶</a></h4>
</section>
<section id="tqsdk-targetpostask">
<span id="tqsdk-target-pos-task"></span><h4>tqsdk.TargetPosTask - 目标持仓工具<a class="headerlink" href="#tqsdk-targetpostask" title="Permalink to this headline">¶</a></h4>
</section>
<section id="tqsdk-targetposscheduler">
<span id="tqsdk-lib-target-pos-scheduler"></span><h4>tqsdk.TargetPosScheduler - 基于时间维度的目标持仓工具<a class="headerlink" href="#tqsdk-targetposscheduler" title="Permalink to this headline">¶</a></h4>
</section>
</section>
<span id="document-reference/tqsdk.ta"></span><section id="tqsdk-ta">
<span id="id1"></span><h3>tqsdk.ta - 技术指标计算函数<a class="headerlink" href="#tqsdk-ta" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.tafunc"></span><section id="tqsdk-tafunc">
<span id="id1"></span><h3>tqsdk.tafunc - 序列计算函数<a class="headerlink" href="#tqsdk-tafunc" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.backtest"></span><section id="tqsdk-tqbacktest">
<span id="tqsdk-backtest"></span><h3>tqsdk.TqBacktest - 策略回测<a class="headerlink" href="#tqsdk-tqbacktest" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.algorithm"></span><section id="tqsdk-algorithm">
<span id="id1"></span><h3>tqsdk.algorithm - 算法模块<a class="headerlink" href="#tqsdk-algorithm" title="Permalink to this headline">¶</a></h3>
<section id="tqsdk-algorithm-twap-twap">
<span id="tqsdk-algorithm-twap"></span><h4>tqsdk.algorithm.twap - Twap 算法<a class="headerlink" href="#tqsdk-algorithm-twap-twap" title="Permalink to this headline">¶</a></h4>
</section>
<section id="tqsdk-algorithm-time-table-generater-time-table">
<span id="tqsdk-algorithm-time-table-generater"></span><h4>tqsdk.algorithm.time_table_generater - 生成 time_table 辅助函数<a class="headerlink" href="#tqsdk-algorithm-time-table-generater-time-table" title="Permalink to this headline">¶</a></h4>
</section>
</section>
<span id="document-reference/tqsdk.risk_rule"></span><section id="tqsdk-risk-rule">
<span id="id1"></span><h3>tqsdk.risk_rule - 风控类模块<a class="headerlink" href="#tqsdk-risk-rule" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.tools.download"></span><section id="tqsdk-tools-datadownloader">
<span id="tqsdk-tools-downloader"></span><h3>tqsdk.tools.DataDownloader - 数据下载工具<a class="headerlink" href="#tqsdk-tools-datadownloader" title="Permalink to this headline">¶</a></h3>
</section>
<span id="document-reference/tqsdk.exceptions"></span><section id="tqsdk-exceptions">
<span id="id1"></span><h3>tqsdk.exceptions - 抛出例外<a class="headerlink" href="#tqsdk-exceptions" title="Permalink to this headline">¶</a></h3>
</section>
</div>
</section>
<span id="document-advanced/index"></span><section id="advanced">
<span id="id1"></span><h2>进阶主题<a class="headerlink" href="#advanced" title="Permalink to this headline">¶</a></h2>
<p>这一部分内容提供给有经验的 TqSdk 用户, 主要讲解将 TqSdk 用于实际工作时的一些重要问题的处理方案和最佳实践.</p>
<div class="toctree-wrapper compound">
<span id="document-advanced/order"></span><section id="advanced-order">
<span id="id1"></span><h3>高级委托指令<a class="headerlink" href="#advanced-order" title="Permalink to this headline">¶</a></h3>
<p>在实盘交易中, 除常见的限价委托指令外, tqsdk 提供了 FAK / FOK 两种高级市价指令。</p>
<p>insert_order 为用户提供了 limit_price，advanced 两个参数指定下单指令，两个参数支持的值的组合为：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 15%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>limit_price</p></th>
<th class="head"><p>advanced</p></th>
<th class="head"><p>memo</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>指定价格</p></td>
<td><p>None</p></td>
<td><p>限价指令，即时成交，当日有效</p></td>
</tr>
<tr class="row-odd"><td><p>指定价格</p></td>
<td><p>FAK</p></td>
<td><p>限价指令，即时成交剩余撤销</p></td>
</tr>
<tr class="row-even"><td><p>指定价格</p></td>
<td><p>FOK</p></td>
<td><p>限价指令，即时全部成交或撤销</p></td>
</tr>
<tr class="row-odd"><td><p>None</p></td>
<td><p>None</p></td>
<td><p>市价指令，即时成交剩余撤销</p></td>
</tr>
<tr class="row-even"><td><p>None</p></td>
<td><p>FAK</p></td>
<td><p>市价指令，即时成交剩余撤销</p></td>
</tr>
<tr class="row-odd"><td><p>None</p></td>
<td><p>FOK</p></td>
<td><p>市价指令，即时全部成交或撤销</p></td>
</tr>
<tr class="row-even"><td><p>BEST</p></td>
<td><p>None</p></td>
<td><p>最优一档即时成交剩余撤销指令</p></td>
</tr>
<tr class="row-odd"><td><p>BEST</p></td>
<td><p>FAK</p></td>
<td><p>最优一档即时成交剩余撤销指令</p></td>
</tr>
<tr class="row-even"><td><p>FIVELEVEL</p></td>
<td><p>None</p></td>
<td><p>最优五档即时成交剩余撤销指令</p></td>
</tr>
<tr class="row-odd"><td><p>FIVELEVEL</p></td>
<td><p>FAK</p></td>
<td><p>最优五档即时成交剩余撤销指令</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>limit_price 默认值为 <code class="docutils literal notranslate"><span class="pre">None</span></code></p></li>
<li><p>advance 默认值为 <code class="docutils literal notranslate"><span class="pre">None</span></code></p></li>
<li><p>对于市价单、BEST、FIVELEVEL，<code class="docutils literal notranslate"><span class="pre">advanced=&quot;FAK&quot;</span></code> 与默认参数 <code class="docutils literal notranslate"><span class="pre">None</span></code> 的实际报单请求一样。</p></li>
</ul>
<p>例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 当日有效限价单</span>
<span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2009&quot;</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">14200</span><span class="p">)</span>
<span class="c1"># FAK 限价单</span>
<span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2009&quot;</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">14200</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="s2">&quot;FAK&quot;</span><span class="p">)</span>
<span class="c1"># FOK 限价单</span>
<span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2009&quot;</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">14200</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="s2">&quot;FOK&quot;</span><span class="p">)</span>

<span class="c1"># 市价单</span>
<span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;DCE.m2009&quot;</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="c1"># FOK 市价单</span>
<span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;DCE.m2009&quot;</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">advanced</span><span class="o">=</span><span class="s2">&quot;FOK&quot;</span><span class="p">)</span>

<span class="c1"># BEST</span>
<span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;CFFEX.T2003&quot;</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="s2">&quot;BEST&quot;</span><span class="p">)</span>
<span class="c1"># FIVELEVEL</span>
<span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;CFFEX.T2003&quot;</span><span class="p">,</span> <span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="s2">&quot;FIVELEVEL&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>不同交易所支持的高级指令参数组合：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 23%" />
<col style="width: 32%" />
<col style="width: 32%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>交易所</p></th>
<th class="head"><p>品种</p></th>
<th class="head"><p>limit_price</p></th>
<th class="head"><p>advance</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>郑商所</p></td>
<td><p>期货</p></td>
<td><p>指定价格 / None</p></td>
<td><p>None / FAK</p></td>
</tr>
<tr class="row-odd"><td><p>郑商所</p></td>
<td><p>期权</p></td>
<td><p>指定价格 / None</p></td>
<td><p>None / FAK / FOK</p></td>
</tr>
<tr class="row-even"><td><p>大商所</p></td>
<td><p>期货</p></td>
<td><p>指定价格 / None</p></td>
<td><p>None / FAK / FOK</p></td>
</tr>
<tr class="row-odd"><td><p>大商所</p></td>
<td><p>期权</p></td>
<td><p>指定价格</p></td>
<td><p>None / FAK / FOK</p></td>
</tr>
<tr class="row-even"><td><p>上期所</p></td>
<td><p>期货/期权</p></td>
<td><p>指定价格</p></td>
<td><p>None / FAK / FOK</p></td>
</tr>
<tr class="row-odd"><td><p>中金所</p></td>
<td><p>期货/期权</p></td>
<td><p>指定价格</p></td>
<td><p>None / FAK / FOK</p></td>
</tr>
<tr class="row-even"><td><p>中金所</p></td>
<td><p>期货/期权</p></td>
<td><p>BEST / FIVELEVEL</p></td>
<td><p>None / FAK</p></td>
</tr>
<tr class="row-odd"><td><p>上交所</p></td>
<td><p>ETF期权</p></td>
<td><p>指定价格</p></td>
<td><p>None / FOK</p></td>
</tr>
<tr class="row-even"><td><p>深交所</p></td>
<td><p>ETF期权</p></td>
<td><p>指定价格</p></td>
<td><p>None / FOK</p></td>
</tr>
</tbody>
</table>
</section>
<span id="document-advanced/backtest"></span><section id="batch-backtest">
<span id="id1"></span><h3>批量回测, 参数搜索及其它<a class="headerlink" href="#batch-backtest" title="Permalink to this headline">¶</a></h3>
<p>在阅读本文档前, 请确保您已经熟悉了 <a class="reference internal" href="index.html#backtest"><span class="std std-ref">策略程序回测</span></a></p>
<section id="id2">
<h4>参数优化/参数搜索<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>TqSdk 并不提供专门的参数优化机制. 您可以按照自己的需求, 针对可能的每个参数值安排一个回测, 观察它们的回测结果, 以简单的双均线策略为例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqSim</span><span class="p">,</span> <span class="n">TargetPosTask</span><span class="p">,</span> <span class="n">BacktestFinished</span><span class="p">,</span> <span class="n">TqBacktest</span>
<span class="kn">from</span> <span class="nn">tqsdk.tafunc</span> <span class="kn">import</span> <span class="n">ma</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="n">LONG</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;SHFE.cu1907&quot;</span>

<span class="k">for</span> <span class="n">SHORT</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">):</span> <span class="c1"># 短周期参数从20-40分别做回测</span>
  <span class="n">acc</span> <span class="o">=</span> <span class="n">TqSim</span><span class="p">()</span>             <span class="c1"># 每次回测都创建一个新的模拟账户</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
    <span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">LONG</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">short_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">SHORT</span><span class="p">)</span>
        <span class="n">long_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">LONG</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
          <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
          <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">BacktestFinished</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SHORT=&quot;</span><span class="p">,</span> <span class="n">SHORT</span><span class="p">,</span> <span class="s2">&quot;最终权益=&quot;</span><span class="p">,</span> <span class="n">account</span><span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">])</span>   <span class="c1"># 每次回测结束时, 输出使用的参数和最终权益</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>多进程并发执行多个回测任务<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>如果您有大量回测任务想要尽快完成, 您首先需要一台给力的电脑(可以考虑到XX云上租一台32核的, 一小时几块钱). 然后您就可以并发执行N个回测了. 还是以上面的策略为例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqSim</span><span class="p">,</span> <span class="n">TargetPosTask</span><span class="p">,</span> <span class="n">BacktestFinished</span><span class="p">,</span> <span class="n">TqBacktest</span>
<span class="kn">from</span> <span class="nn">tqsdk.tafunc</span> <span class="kn">import</span> <span class="n">ma</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="k">def</span> <span class="nf">MyStrategy</span><span class="p">(</span><span class="n">SHORT</span><span class="p">):</span>
  <span class="n">LONG</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;SHFE.cu1907&quot;</span>
  <span class="n">acc</span> <span class="o">=</span> <span class="n">TqSim</span><span class="p">()</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">backtest</span><span class="o">=</span><span class="n">TqBacktest</span><span class="p">(</span><span class="n">start_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">end_dt</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
    <span class="n">data_length</span> <span class="o">=</span> <span class="n">LONG</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">data_length</span><span class="p">)</span>
    <span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">short_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">SHORT</span><span class="p">)</span>
        <span class="n">long_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">LONG</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
          <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
          <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">BacktestFinished</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SHORT=&quot;</span><span class="p">,</span> <span class="n">SHORT</span><span class="p">,</span> <span class="s2">&quot;最终权益=&quot;</span><span class="p">,</span> <span class="n">acc</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">balance</span><span class="p">)</span>  <span class="c1"># 每次回测结束时, 输出使用的参数和最终权益</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>                               <span class="c1"># 进程池, 建议小于cpu数</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">MyStrategy</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="p">,))</span>  <span class="c1"># 把20个回测任务交给进程池执行</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting for all subprocesses done...&#39;</span><span class="p">)</span>
  <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All subprocesses done.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>注意: 由于服务器流控限制, 同时执行的回测任务请勿超过10个</strong></p>
</section>
</section>
<span id="document-advanced/multi_strategy"></span><section id="multi-instance">
<span id="id1"></span><h3>交易策略的多实例运行<a class="headerlink" href="#multi-instance" title="Permalink to this headline">¶</a></h3>
<p>我们可能会将一个策略应用于不同的目标品种, 不同品种使用的策略参数也不同.</p>
<p>以简单的双均线策略为例. 一个简单的双均线策略代码大致是这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;SHFE.bu1912&quot;</span>  <span class="c1"># 合约代码</span>
<span class="n">SHORT</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 短周期</span>
<span class="n">LONG</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># 长周期</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">LONG</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">short_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">SHORT</span><span class="p">)</span>
        <span class="n">long_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">LONG</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线下穿，做空&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线上穿，做多&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>我们可能需要将这个策略运行多份, 每份的 SYMBOL, LONG, SHORT 都不同.</p>
<p>TqSdk 为这类需求提供两种解决方案, 您可任意选择一种.</p>
<section id="id2">
<h4>每个进程执行一个策略实例<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>最简单的办法是直接将上面的程序复制为N个文件, 手工修改每个文件中的 SYMBOL, SHORT, LONG 的值, 再把N个程序分别启动运行即可达到目的.</p>
<p>如果觉得代码复制N份会导致修改不方便, 可以简单的剥离一个函数文件, 每个策略实例文件引用它:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">在函数文件</span> <span class="n">mylib</span><span class="o">.</span><span class="n">py</span> <span class="n">中</span><span class="p">:</span>

<span class="k">def</span> <span class="nf">ma</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">SHORT</span><span class="p">,</span> <span class="n">LONG</span><span class="p">):</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqSim</span><span class="p">())</span>

    <span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">LONG</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
            <span class="n">short_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">SHORT</span><span class="p">)</span>
            <span class="n">long_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">LONG</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线下穿，做空&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线上穿，做多&quot;</span><span class="p">)</span>

<span class="o">--------------------------------------------------</span>
<span class="n">在策略文件</span> <span class="n">ma</span><span class="o">-</span><span class="n">股指</span><span class="o">.</span><span class="n">py</span> <span class="n">中</span><span class="p">:</span>

<span class="kn">from</span> <span class="nn">mylib</span> <span class="kn">import</span> <span class="n">ma</span>
<span class="n">ma</span><span class="p">(</span><span class="s2">&quot;CFFEX.IF1906&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

<span class="o">--------------------------------------------------</span>
<span class="n">在策略文件</span> <span class="n">ma</span><span class="o">-</span><span class="n">玉米</span><span class="o">.</span><span class="n">py</span> <span class="n">中</span><span class="p">:</span>

<span class="kn">from</span> <span class="nn">mylib</span> <span class="kn">import</span> <span class="n">ma</span>
<span class="n">ma</span><span class="p">(</span><span class="s2">&quot;DCE.c1906&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>习惯使用命令行的同学也可以做命令行参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--SYMBOL&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--SHORT&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--LONG&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqSim</span><span class="p">())</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">LONG</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">SYMBOL</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
        <span class="n">short_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">SHORT</span><span class="p">)</span>
        <span class="n">long_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">LONG</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线下穿，做空&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线上穿，做多&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>使用时在命令行挂参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">ma</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">SYMBOL</span><span class="o">=</span><span class="n">SHFE</span><span class="o">.</span><span class="n">cu1901</span> <span class="o">--</span><span class="n">LONG</span><span class="o">=</span><span class="mi">30</span> <span class="o">--</span><span class="n">SHORT</span><span class="o">=</span><span class="mi">20</span>
<span class="n">python</span> <span class="n">ma</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">SYMBOL</span><span class="o">=</span><span class="n">SHFE</span><span class="o">.</span><span class="n">rb1901</span> <span class="o">--</span><span class="n">LONG</span><span class="o">=</span><span class="mi">50</span> <span class="o">--</span><span class="n">SHORT</span><span class="o">=</span><span class="mi">10</span>
</pre></div>
</div>
<p>优点:</p>
<ul class="simple">
<li><p>思路简单, 好学好做, 不易出错</p></li>
<li><p>每个单独策略可以分别启动/停止</p></li>
<li><p>策略代码最简单, 调试方便</p></li>
</ul>
<p>缺点:</p>
<ul class="simple">
<li><p>每个策略进程要建立一个单独的服务器连接, 数量过大时可能无法连接成功</p></li>
</ul>
</section>
<section id="multi-async-task">
<span id="id3"></span><h4>单线程创建多个异步任务<a class="headerlink" href="#multi-async-task" title="Permalink to this headline">¶</a></h4>
<p>TqSdk 内核支持以异步方式实现多任务。 如果用户策略代码实现为一个异步任务, 即可在单线程内执行多个策略。</p>
<p>TqSdk（2.6.1 版本）对几个常用接口 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_quote()</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_quote_list()</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tick_serial()</span></code> 支持协程中调用。</p>
<p>对于 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_quote()</span></code> 接口，在异步代码中可以写为 <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">api.get_quote('SHFE.cu2110')</span></code>，代码更加紧凑，可读性更好。</p>
<p>示例代码如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 协程示例，为每个合约创建 task</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">demo</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">):</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="k">await</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">)</span>  <span class="c1"># 支持 await 异步，这里会订阅合约，等到收到合约行情才返回</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;quote: </span><span class="si">{</span><span class="n">SYMBOL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>  <span class="c1"># 这一行就会打印出合约的最新行情</span>

    <span class="c1">##############################################################################</span>
    <span class="c1"># 以上代码和下面的代码是等价的，强烈建议在异步中用上面的写法</span>
    <span class="c1"># quote = api.get_quote(SYMBOL)  # 这里还是同步写法，仅仅返回 quote 的引用，还没有订阅合约，会在下次调用 api.wait_update() 时才发出订阅合约请求</span>
    <span class="c1"># print(f&quot;quote: {SYMBOL}&quot;, quote.datetime, quote.last_price)  # 这一行不会打印出合约的信息</span>
    <span class="c1">#</span>
    <span class="c1"># async with api.register_update_notify() as update_chan:</span>
    <span class="c1">#    async for _ in update_chan:</span>
    <span class="c1">#        if quote.datetime != &quot;&quot;:  # 当收到 datetime 字段时，可以判断收到了合约行情</span>
    <span class="c1">#            print(SYMBOL, quote.datetime, quote.last_price)  # 此时会打印出行情</span>
    <span class="c1">#            break</span>
    <span class="c1">##############################################################################</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">api</span><span class="o">.</span><span class="n">register_update_notify</span><span class="p">()</span> <span class="k">as</span> <span class="n">update_chan</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">update_chan</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span><span class="p">)</span>
            <span class="c1"># ... 策略代码 ...</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 为每个合约创建异步任务</span>
<span class="n">api</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">demo</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2107&quot;</span><span class="p">))</span>
<span class="n">api</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">demo</span><span class="p">(</span><span class="s2">&quot;DCE.m2109&quot;</span><span class="p">))</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
<p>下面是一个更完整的示例，用异步方式实现为每个合约创建双均线策略，示例代码如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 协程示例，为每个合约创建 task</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>  <span class="c1"># 构造 api 实例</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">demo</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">SHORT</span><span class="p">,</span> <span class="n">LONG</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    双均线策略 -- SYMBOL: 合约, SHORT: 短周期, LONG: 长周期</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_length</span> <span class="o">=</span> <span class="n">LONG</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># k线数据长度</span>
    <span class="c1"># get_kline_serial 支持 await 异步写法，这里会订阅 K 线，等到收到 k 线数据才返回</span>
    <span class="n">klines</span> <span class="o">=</span> <span class="k">await</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">data_length</span><span class="p">)</span>
    <span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">api</span><span class="o">.</span><span class="n">register_update_notify</span><span class="p">()</span> <span class="k">as</span> <span class="n">update_chan</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">update_chan</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>
                <span class="n">short_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">SHORT</span><span class="p">)</span>  <span class="c1"># 短周期</span>
                <span class="n">long_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">],</span> <span class="n">LONG</span><span class="p">)</span>  <span class="c1"># 长周期</span>
                <span class="k">if</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线下穿，做空&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线上穿，做多&quot;</span><span class="p">)</span>

<span class="c1"># 为每个合约创建异步任务</span>
<span class="n">api</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">demo</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2107&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
<span class="n">api</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">demo</span><span class="p">(</span><span class="s2">&quot;DCE.m2109&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
<span class="n">api</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">demo</span><span class="p">(</span><span class="s2">&quot;DCE.jd2109&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
</pre></div>
</div>
<p>优点:</p>
<ul class="simple">
<li><p>单线程内执行多个策略, 只消耗一份网络连接</p></li>
<li><p>没有线程或进程切换成本, 性能高, 延时低, 内存消耗小, 性能最优</p></li>
</ul>
<p>缺点:</p>
<ul class="simple">
<li><p>用户需熟练掌握 asyncio 异步编程, 学习成本高</p></li>
</ul>
<p>example 中的 <a class="reference external" href="https://github.com/shinnytech/tqsdk-python/blob/master/tqsdk/demo/example/gridtrading_async.py">gridtrading_async.py</a> 就是一个完全按异步框架实现的网格交易策略. 有意学习的同学可以与 gridtrading.py 对比一下</p>
</section>
</section>
<span id="document-advanced/gui"></span><section id="gui">
<span id="id1"></span><h3>与Gui库共同工作<a class="headerlink" href="#gui" title="Permalink to this headline">¶</a></h3>
<p>某些情况下, 我们可能需要在一个 Python GUI 程序中使用TqSdk库. TqSdk 可以与Tkinter, PyQt, WxPython, PySimpleGui 等大多数常见 Python Gui 库配合工作.</p>
<p>下面以 PySimpleGui 为例, 介绍 Gui 库与 TqSdk 组合使用的方式.</p>
<section id="guitqsdk">
<h4>先后使用GUI库和TqSdk<a class="headerlink" href="#guitqsdk" title="Permalink to this headline">¶</a></h4>
<p>参见示例程序 param_input.py. 这个程序先使用 PySimpleGui 创建一个参数输入对话框, 用户输入参数后, 关闭对话框, 开始使用 TqSdk:</p>
</section>
<section id="id2">
<h4>在两个线程中分别运行Gui和TqSdk<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>参见示例程序 multi_thread.py.</p>
</section>
<section id="tqsdkgui">
<h4>在TqSdk任务中驱动Gui消息循环<a class="headerlink" href="#tqsdkgui" title="Permalink to this headline">¶</a></h4>
<p>参见示例程序 loop_integrate.py.</p>
</section>
</section>
<span id="document-advanced/dingding"></span><section id="dingding">
<span id="id1"></span><h3>将程序信息推送到手机端<a class="headerlink" href="#dingding" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 并不提供专门的服务器来推送消息，但是你可以通过其他 SDK 来做到这个效果，在发生成交或者条件满足时，进行消息推送，以钉钉为例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TargetPosTask</span>


<span class="k">def</span> <span class="nf">send_msg</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;钉钉消息提醒模块&quot;&quot;&quot;</span>
    <span class="n">webhook</span> <span class="o">=</span> <span class="s2">&quot;设置自己的钉钉 webhook&quot;</span>

    <span class="c1"># 钉钉安全规则将 天勤量化 设为关键字</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;msgtype&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
           <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;天勤量化</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">content</span><span class="p">,</span>
                                                 <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))},</span> <span class="p">}</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;content-type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json;charset=utf-8&quot;</span><span class="p">}</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">webhook</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2109&quot;</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb2110&quot;</span><span class="p">)</span>
<span class="n">send_msg</span><span class="p">(</span><span class="s2">&quot;策略开始运行&quot;</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># 通过本地变量 a 来避免多次发送钉钉消息触发流控</span>
    <span class="k">if</span> <span class="n">quote</span><span class="o">.</span><span class="n">last_price</span> <span class="o">&gt;</span> <span class="mi">5110</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">send_msg</span><span class="p">(</span><span class="s2">&quot;行情满足条件，开多头5手&quot;</span><span class="p">)</span>
        <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>具体说明，请参考 <a class="reference external" href="https://developers.dingtalk.com/document/app/custom-robot-access">钉钉操作手册</a></p>
</section>
<span id="document-advanced/for_vnpy_user"></span><section id="tqsdk-vn-py">
<span id="for-vnpy-user"></span><h3>TqSdk 与 vn.py 有哪些差别<a class="headerlink" href="#tqsdk-vn-py" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 与 vn.py 有非常多的差别. 如果您是一位有经验的 vn.py 用户, 刚开始接触 TqSdk, 下面的信息将帮助您尽快理解 TqSdk.</p>
<section id="id1">
<h4>系统整体架构<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>vn.py 是一套 all-in-one 的结构, 在一个Python软件包中包含了数据库, 行情接收/存储, 交易接口, 图形界面等功能.</p>
<p>TqSdk 则使用基于网络协作的组件设计. 如下图:</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="761px" viewBox="-0.5 -0.5 761 261" style="max-width:100%;max-height:261px;"><defs/><g><path d="M 620 60 L 620 40" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><a xlink:href="https://github.com/shinnytech/open-md-gateway"><rect x="480" y="60" width="280" height="40" fill="#fff2cc" stroke="#d6b656"/><g transform="translate(569.5,66.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="100" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 102px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div><a href="https://github.com/shinnytech/open-md-gateway">Open Md Gateway</a></div><div><a href="https://github.com/shinnytech/open-md-gateway">行情网关</a></div></div></div></foreignObject><text x="50" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><a xlink:href="https://github.com/shinnytech/open-trade-gateway"><rect x="0" y="60" width="280" height="40" fill="#fff2cc" stroke="#d6b656"/><g transform="translate(82.5,66.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="114" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 116px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="https://github.com/shinnytech/open-trade-gateway">Open Trade Gateway<br />交易中继网关</a><br /></div></div></foreignObject><text x="57" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><rect x="0" y="0" width="280" height="40" fill="#eeeeee" stroke="#36393d"/><g transform="translate(84.5,6.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="110" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 110px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">期货公司交易系统<br />CTP / FEMAS / UFX<br /></div></div></foreignObject><text x="55" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">期货公司交易系统&lt;br&gt;CTP / FEMAS / UFX&lt;br&gt;</text></switch></g><rect x="480" y="0" width="280" height="40" fill="#eeeeee" stroke="#36393d"/><g transform="translate(577.5,13.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 85px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">交易所行情系统<br /></div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">交易所行情系统&lt;br&gt;</text></switch></g><path d="M 140 60 L 140 40" fill="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 380 120 L 140 100" fill="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 380 120 L 620 100" fill="none" stroke="#000000" stroke-miterlimit="10"/><a xlink:href="http://doc.shinnytech.com/diff/latest/"><rect x="0" y="120" width="760" height="40" rx="6" ry="6" fill="#f8cecc" stroke="#b85450"/><g transform="translate(352.5,133.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="54" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 55px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="https://github.com/shinnytech/diff">DIFF 协议</a></div></div></foreignObject><text x="27" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><path d="M 380 180 L 380 160" fill="none" stroke="#000000" stroke-miterlimit="10"/><a xlink:href="http://www.shinnytech.com/tianqin"><rect x="320" y="180" width="120" height="40" fill="#dae8fc" stroke="#6c8ebf"/><g transform="translate(355.5,193.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 49px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="http://www.tq18.cn">天勤终端</a></div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><a xlink:href="https://github.com/shinnytech/tqsdk-python"><rect x="320" y="220" width="120" height="40" fill="#dae8fc" stroke="#6c8ebf"/><g transform="translate(362.5,233.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="34" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="https://github.com/shinnytech/tqsdk-python">TqSdk</a><br /></div></div></foreignObject><text x="17" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a></g></svg><p>如图所示, 整个系统结构包括这些关键组件:</p>
<ul class="simple">
<li><p>行情网关 (Open Md Gateway) 负责提供实时行情和历史数据</p></li>
<li><p>交易中继网关 (Open Trade Gateway) 负责连接到期货公司交易系统</p></li>
<li><p>上面两个网关统一以 Diff 协议对下方提供服务</p></li>
<li><p>天勤终端和TqSdk按照Diff协议连接到行情网关和交易中继网关, 实现行情和交易功能</p></li>
</ul>
<p>这样的结构可以给用户带来一些好处:</p>
<ul class="simple">
<li><p>TqSdk 很小, 安装也很方便, 只要简单 pip install tqsdk 即可</p></li>
<li><p>官方专门运维行情数据库, 用户可以直接使用, 不需要自己接收和存储数据</p></li>
<li><p>交易相关接口被大幅度简化, 不再需要处理CTP接口的复杂回调, 也不需要发起任何查询请求</p></li>
</ul>
<p>也有一些不如vn.py方便的地方:</p>
<ul class="simple">
<li><p>由于交易指令经交易网关转发, 用户无法直接指定CTP服务器地址. 用户如果需要连接到官方交易网关不支持的期货公司, 需要自行部署交易网关.</p></li>
</ul>
</section>
<section id="py">
<h4>每个策略是一个单独运行的py文件<a class="headerlink" href="#py" title="Permalink to this headline">¶</a></h4>
<p>在 vn.py 中, 要实现一个策略程序, 通常是从 CtaTemplate 等基类派生一个子类, 像这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DoubleMaStrategy</span><span class="p">(</span><span class="n">CtaTemplate</span><span class="p">):</span>

  <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fast_window&quot;</span><span class="p">,</span> <span class="s2">&quot;slow_window&quot;</span><span class="p">]</span>
  <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fast_ma0&quot;</span><span class="p">,</span> <span class="s2">&quot;fast_ma1&quot;</span><span class="p">,</span> <span class="s2">&quot;slow_ma0&quot;</span><span class="p">,</span> <span class="s2">&quot;slow_ma1&quot;</span><span class="p">]</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cta_engine</span><span class="p">,</span> <span class="n">strategy_name</span><span class="p">,</span> <span class="n">vt_symbol</span><span class="p">,</span> <span class="n">setting</span><span class="p">):</span>
    <span class="o">...</span>

  <span class="k">def</span> <span class="nf">on_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">TickData</span><span class="p">):</span>
    <span class="o">...</span>

  <span class="k">def</span> <span class="nf">on_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">:</span> <span class="n">BarData</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>这个 DoubleMaStrategy 类写好以后, 由vn.py的策略管理器负责加载运行. 整个程序结构中, vn.py作为调用方, 用户代码作为被调用方, 结构图是这样的:</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="689px" viewBox="-0.5 -0.5 689 208" style="max-width:100%;max-height:208px;"><defs/><g><rect x="0" y="87" width="680" height="40" rx="6" ry="6" fill="#f8cecc" stroke="#b85450" pointer-events="none"/><g transform="translate(297.5,100.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 86px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Vnpy cta runner</div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Vnpy cta runner</text></switch></g><path d="M 126 160.63 L 126 127" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 126 165.88 L 122.5 158.88 L 126 160.63 L 129.5 158.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(77.5,140.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="96" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">调用事件响应函数</div></div></foreignObject><text x="48" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">调用事件响应函数</text></switch></g><rect x="110" y="167" width="120" height="40" fill="#dae8fc" stroke="#6c8ebf" pointer-events="none"/><g transform="translate(154.5,180.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="30" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">策略1</div></div></foreignObject><text x="15" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">策略1</text></switch></g><path d="M 334.47 83.84 L 200 7" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 339.03 86.45 L 331.22 86.01 L 334.47 83.84 L 334.69 79.93 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(227.5,40.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">接收行情和回单</div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">接收行情和回单</text></switch></g><path d="M 474.47 10.16 L 340 87" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 479.03 7.55 L 474.69 14.07 L 474.47 10.16 L 471.22 7.99 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(373.5,40.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="72" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">发送交易指令</div></div></foreignObject><text x="36" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">发送交易指令</text></switch></g><path d="M 222 136.37 L 222 167" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 222 131.12 L 225.5 138.12 L 222 136.37 L 218.5 138.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(185.5,142.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="72" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">调用下单函数</div></div></foreignObject><text x="36" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">调用下单函数</text></switch></g><path d="M 336 160.63 L 336 127" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 336 165.88 L 332.5 158.88 L 336 160.63 L 339.5 158.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(287.5,140.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="96" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">调用事件响应函数</div></div></foreignObject><text x="48" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">调用事件响应函数</text></switch></g><rect x="320" y="167" width="120" height="40" fill="#dae8fc" stroke="#6c8ebf" pointer-events="none"/><g transform="translate(364.5,180.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="30" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">策略2</div></div></foreignObject><text x="15" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">策略2</text></switch></g><path d="M 432 136.37 L 432 167" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 432 131.12 L 435.5 138.12 L 432 136.37 L 428.5 138.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(395.5,142.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="72" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">调用下单函数</div></div></foreignObject><text x="36" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">调用下单函数</text></switch></g><path d="M 556 160.63 L 556 127" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 556 165.88 L 552.5 158.88 L 556 160.63 L 559.5 158.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(507.5,140.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="96" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">调用事件响应函数</div></div></foreignObject><text x="48" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">调用事件响应函数</text></switch></g><rect x="540" y="167" width="120" height="40" fill="#dae8fc" stroke="#6c8ebf" pointer-events="none"/><g transform="translate(584.5,180.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="30" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">策略3</div></div></foreignObject><text x="15" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">策略3</text></switch></g><path d="M 652 136.37 L 652 167" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 652 131.12 L 655.5 138.12 L 652 136.37 L 648.5 138.12 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(615.5,142.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="72" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">调用下单函数</div></div></foreignObject><text x="36" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">调用下单函数</text></switch></g></g></svg><p>而在 TqSdk 中, 策略程序并没有一个统一的基类. TqSdk只是提供一些行情和交易函数, 用户可以任意组合它们来实现自己的策略程序, 还是以双均线策略为例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">双均线策略</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqSim</span><span class="p">,</span> <span class="n">TargetPosTask</span>
<span class="kn">from</span> <span class="nn">tqsdk.tafunc</span> <span class="kn">import</span> <span class="n">ma</span>

<span class="n">SHORT</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">LONG</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;SHFE.bu1912&quot;</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>

<span class="n">data_length</span> <span class="o">=</span> <span class="n">LONG</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">data_length</span><span class="o">=</span><span class="n">data_length</span><span class="p">)</span>
<span class="n">target_pos</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;datetime&quot;</span><span class="p">):</span>  <span class="c1"># 产生新k线:重新计算SMA</span>
        <span class="n">short_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">SHORT</span><span class="p">)</span>  <span class="c1"># 短周期</span>
        <span class="n">long_avg</span> <span class="o">=</span> <span class="n">ma</span><span class="p">(</span><span class="n">klines</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="n">LONG</span><span class="p">)</span>  <span class="c1"># 长周期</span>

        <span class="c1"># 均线下穿，做空</span>
        <span class="k">if</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线下穿，做空&quot;</span><span class="p">)</span>

        <span class="c1"># 均线上穿，做多</span>
        <span class="k">if</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">short_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">long_avg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">target_pos</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;均线上穿，做多&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>以上代码文件单独运行, 即可执行一个双均线交易策略. 整个程序结构中, 用户代码作为调用方, TqSdk库代码作为被调用方, 每个策略是完全独立的. 结构是这样:</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="576px" viewBox="-0.5 -0.5 576 209" style="max-width:100%;max-height:209px;"><defs/><g><rect x="7" y="80" width="160" height="40" rx="6" ry="6" fill="#f8cecc" stroke="#b85450" pointer-events="none"/><g transform="translate(69.5,93.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="34" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">TqSdk<br /></div></div></foreignObject><text x="17" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqSdk&lt;br&gt;</text></switch></g><rect x="7" y="0" width="160" height="40" fill="#dae8fc" stroke="#6c8ebf" pointer-events="none"/><g transform="translate(71.5,13.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="30" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">策略1</div></div></foreignObject><text x="15" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">策略1</text></switch></g><path d="M 82.5 124.5 L 7 200" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 86.21 120.79 L 83.73 128.22 L 82.5 124.5 L 78.78 123.27 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(4.5,153.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">接收行情和回单</div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">接收行情和回单</text></switch></g><path d="M 162.5 195.5 L 87 120" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 166.21 199.21 L 158.78 196.73 L 162.5 195.5 L 163.73 191.78 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(90.5,153.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="72" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">发送交易指令</div></div></foreignObject><text x="36" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">发送交易指令</text></switch></g><path d="M 87 73.63 L 87 40" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 87 78.88 L 83.5 71.88 L 87 73.63 L 90.5 71.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(62.5,53.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">调用函数</div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">调用函数</text></switch></g><rect x="207" y="80" width="160" height="40" rx="6" ry="6" fill="#f8cecc" stroke="#b85450" pointer-events="none"/><g transform="translate(269.5,93.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="34" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">TqSdk<br /></div></div></foreignObject><text x="17" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqSdk&lt;br&gt;</text></switch></g><rect x="207" y="0" width="160" height="40" fill="#dae8fc" stroke="#6c8ebf" pointer-events="none"/><g transform="translate(271.5,13.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="30" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">策略2</div></div></foreignObject><text x="15" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">策略2</text></switch></g><path d="M 282.5 124.5 L 207 200" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 286.21 120.79 L 283.73 128.22 L 282.5 124.5 L 278.78 123.27 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(204.5,153.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">接收行情和回单</div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">接收行情和回单</text></switch></g><path d="M 362.5 195.5 L 287 120" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 366.21 199.21 L 358.78 196.73 L 362.5 195.5 L 363.73 191.78 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(290.5,153.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="72" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">发送交易指令</div></div></foreignObject><text x="36" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">发送交易指令</text></switch></g><path d="M 287 73.63 L 287 40" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 287 78.88 L 283.5 71.88 L 287 73.63 L 290.5 71.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(262.5,53.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">调用函数</div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">调用函数</text></switch></g><rect x="407" y="80" width="160" height="40" rx="6" ry="6" fill="#f8cecc" stroke="#b85450" pointer-events="none"/><g transform="translate(469.5,93.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="34" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">TqSdk<br /></div></div></foreignObject><text x="17" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqSdk&lt;br&gt;</text></switch></g><rect x="407" y="0" width="160" height="40" fill="#dae8fc" stroke="#6c8ebf" pointer-events="none"/><g transform="translate(471.5,13.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="30" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">策略3</div></div></foreignObject><text x="15" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">策略3</text></switch></g><path d="M 482.5 124.5 L 407 200" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 486.21 120.79 L 483.73 128.22 L 482.5 124.5 L 478.78 123.27 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(404.5,153.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">接收行情和回单</div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">接收行情和回单</text></switch></g><path d="M 562.5 195.5 L 487 120" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 566.21 199.21 L 558.78 196.73 L 562.5 195.5 L 563.73 191.78 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(490.5,153.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="72" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">发送交易指令</div></div></foreignObject><text x="36" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">发送交易指令</text></switch></g><path d="M 487 73.63 L 487 40" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 487 78.88 L 483.5 71.88 L 487 73.63 L 490.5 71.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(462.5,53.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">调用函数</div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">调用函数</text></switch></g></g></svg><p>TqSdk将每个策略作为一个独立进程运行, 这样就可以:</p>
<ul class="simple">
<li><p>在运行多策略时可以充分利用多CPU的计算能力</p></li>
<li><p>每个策略都可以随时启动/停止/调试/修改代码, 而不影响其它策略程序的运行</p></li>
<li><p>可以方便的针对单个策略程序进行调试</p></li>
</ul>
<p>在策略程序中, 用户代码可以随意调用 TqSdk 包中的任意函数, 这带来了更大的自由度, 比如:</p>
<ul class="simple">
<li><p>在一个策略程序中使用多个合约或周期的K线数据, 盘口数据和Tick数据. 对于某些类型的策略来说这是很方便的</p></li>
<li><p>对多个合约的交易指令进行精细管理</p></li>
<li><p>管理复杂的子任务</p></li>
<li><p>方便策略程序跟其它库或框架集成</p></li>
</ul>
<p>以一个套利策略的代码为例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">价差回归</span>
<span class="sd">当近月-远月的价差大于200时做空近月，做多远月</span>
<span class="sd">当价差小于150时平仓</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote_near</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.rb1910&quot;</span><span class="p">)</span>
<span class="n">quote_deferred</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2001&quot;</span><span class="p">)</span>
<span class="c1"># 创建 rb1910 的目标持仓 task，该 task 负责调整 rb1910 的仓位到指定的目标仓位</span>
<span class="n">target_pos_near</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb1910&quot;</span><span class="p">)</span>
<span class="c1"># 创建 rb2001 的目标持仓 task，该 task 负责调整 rb2001 的仓位到指定的目标仓位</span>
<span class="n">target_pos_deferred</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb2001&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote_near</span><span class="p">)</span> <span class="ow">or</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">quote_deferred</span><span class="p">):</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="n">quote_near</span><span class="o">.</span><span class="n">last_price</span> <span class="o">-</span> <span class="n">quote_deferred</span><span class="o">.</span><span class="n">last_price</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;当前价差:&quot;</span><span class="p">,</span> <span class="n">spread</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spread</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标持仓: 空近月，多远月&quot;</span><span class="p">)</span>
            <span class="c1"># 设置目标持仓为正数表示多头，负数表示空头，0表示空仓</span>
            <span class="n">target_pos_near</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">target_pos_deferred</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">spread</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;目标持仓: 空仓&quot;</span><span class="p">)</span>
            <span class="n">target_pos_near</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">target_pos_deferred</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>在这个程序中, 我们同时跟踪两个合约的行情信息, 并为两个合约各创建一个调仓任务, 可以方便的实现套利策略</p>
</section>
<section id="k">
<h4>K线数据与指标计算<a class="headerlink" href="#k" title="Permalink to this headline">¶</a></h4>
<p>使用vn.py时, K线是由vn.py接收实时行情, 并在用户电脑上生成K线, 存储于用户电脑上的数据库中.</p>
<p>而在TqSdk中, K线数据和其它行情数据一样是由行情网关生成并推送的. 这带来了一些差别:</p>
<ul class="simple">
<li><p>用户不再需要维护K线数据库. 用户电脑实时行情中断后, 也不再需要补历史数据</p></li>
<li><p>行情服务器生成K线时, 采用了按K线时间严格补全对齐的算法. 这与vn.py或其它软件有明显区别, 详见 <a class="reference external" href="https://www.shinnytech.com/blog/why-our-kline-different/">https://www.shinnytech.com/blog/why-our-kline-different/</a></p></li>
<li><p>行情数据只在每次程序运行时通过网络获取, 不在用户硬盘保存. 如果策略研究工作需要大量静态历史数据, 我们推荐使用数据下载工具, 另行下载csv文件使用.</p></li>
</ul>
<p>TqSdk中的K线序列采用 pandas.DataFrame 格式. pandas 提供了 <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html">非常丰富的数据处理函数</a> , 使我们可以非常方便的进行数据处理, 例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ks</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>            <span class="c1"># &lt;- 最后一根K线</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>               <span class="c1"># &lt;- 收盘价序列</span>
<span class="n">ks</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="n">ks</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="c1"># &lt;- 每根K线最高价-前一根K线最高价, 形成一个新序列</span>
</pre></div>
</div>
<p>TqSdk 也通过 <code class="xref py py-mod docutils literal notranslate"><span class="pre">tqsdk.tafunc</span></code> 提供了一批行情分析中常用的计算函数, 例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">tafunc</span>
<span class="n">ks</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">ms</span> <span class="o">=</span> <span class="n">tafunc</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>           <span class="c1"># &lt;- 取每根K线开盘价和收盘价的高者构建一个新序列</span>
<span class="n">median3</span> <span class="o">=</span> <span class="n">tafunc</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>       <span class="c1"># &lt;- 求最近100根K线收盘价的中间值</span>
<span class="n">ss</span> <span class="o">=</span> <span class="n">tafunc</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>                 <span class="c1"># &lt;- 每5根K线的收盘价标准差</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>数据接收和更新<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>vn.py按照事件回调模型设计, 使用 CtaTemplate 的 on_xxx 回调函数进行行情数据和回单处理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DoubleMaStrategy</span><span class="p">(</span><span class="n">CtaTemplate</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">on_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">:</span> <span class="n">TickData</span><span class="p">):</span>
    <span class="o">...</span>
  <span class="k">def</span> <span class="nf">on_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bar</span><span class="p">:</span> <span class="n">BarData</span><span class="p">):</span>
    <span class="o">...</span>
  <span class="k">def</span> <span class="nf">on_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">OrderData</span><span class="p">):</span>
    <span class="k">pass</span>
  <span class="k">def</span> <span class="nf">on_trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trade</span><span class="p">:</span> <span class="n">TradeData</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">put_event</span><span class="p">()</span>
</pre></div>
</div>
<p>TqSdk则不使用事件回调机制. <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 函数设计用来获取任意数据更新, 像这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">ks</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>       <span class="c1"># &lt;- 这个 wait_update 将尝试更新所有数据. 如果没有任何新信息, 程序会阻塞在这一句. 一旦有任意数据被更新, 程序会继续往下执行</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>      <span class="c1"># &lt;- 最后一根K线的收盘价</span>
</pre></div>
</div>
<p>一次 wait_update 可能更新多个实体, 在这种情况下, <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_changing()</span></code> 被用来判断某个实体是否有变更:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">)</span>
<span class="n">ks</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>      <span class="c1"># &lt;- 这个 wait_update 将尝试更新所有数据. 如果没有任何新信息, 程序会阻塞在这一句. 一旦有任意数据被更新, 程序会继续往下执行</span>
  <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">q</span><span class="p">):</span> <span class="c1"># &lt;- 这个 is_changing 用来判定这次更新是否影响到了q</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">):</span> <span class="c1"># &lt;- 这个 is_changing 用来判定这次更新是否影响到了报单的status字段</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>TqSdk针对行情数据和交易信息都采用相同的 wait_update/is_changing 方案. 用户需要记住的要点包括:</p>
<ul class="simple">
<li><p>get_quote, get_kline_serial, insert_order 等业务函数返回的是一个引用(refrence, not value), 它们的值总是在 wait_update 时更新.</p></li>
<li><p>用户程序除执行自己业务逻辑外, 需要反复调用 wait_update. 在两次 wait_update 间, 所有数据都不更新</p></li>
<li><p>用 insert_order 函数下单, 报单指令实际是在 insert_order 后调用 wait_update 时发出的.</p></li>
<li><p>用户程序中需要避免阻塞, 不要使用 sleep 暂停程序</p></li>
</ul>
<p>关于 wait_update 机制的详细说明, 请见 <a class="reference internal" href="index.html#framework"><span class="std std-ref">策略程序结构</span></a></p>
</section>
<section id="id4">
<h4>图形界面<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>TqSdk 提供  <a class="reference internal" href="index.html#web-gui"><span class="std std-ref">策略程序图形化界面</span></a> 来供有图形化需求的用户使用:</p>
<ul class="simple">
<li><p>策略运行时, 交易记录和持仓记录自动在行情图上标记, 可以快速定位跳转, 可以跨周期缩放定位</p></li>
<li><p>策略回测时, 提供回测报告/图上标记和对应的回测分析报告.</p></li>
<li><p>策略运行和回测信息自动保存, 可事后随时查阅显示</p></li>
</ul>
<p>TqSdk配合web_gui使用时, 还支持自定义绘制行情图表, 像这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span><span class="s2">&quot;账户密码&quot;</span><span class="p">),</span> <span class="n">web_gui</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># 获取 cu1905 和 cu1906 的日线数据</span>
<span class="n">klines</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1905&quot;</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>
<span class="n">klines2</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1906&quot;</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)</span>

<span class="c1"># 算出 cu1906 - cu1905 的价差，并以折线型态显示在副图</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;dif&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">klines2</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">klines</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;dif.board&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DIF&quot;</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;dif.color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF00FF00</span>
<span class="n">klines</span><span class="p">[</span><span class="s2">&quot;dif.width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</section>
<section id="id5">
<h4>回测<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>使用TqSdk开发的策略可以回测:</p>
<ul class="simple">
<li><p>提供Tick及K线级别的回测.</p></li>
<li><p>TqSdk 允许在一个策略中使用任意多个数据序列. 回测框架将正确识别并处理这种情况.</p></li>
<li><p>回测前不需要准备数据</p></li>
</ul>
<p>关于策略回测的详细说明, 请见 <a class="reference internal" href="index.html#backtest"><span class="std std-ref">策略程序回测</span></a></p>
</section>
<section id="id6">
<h4>其它区别<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>此外, 还有一些差别值得注意</p>
<ul class="simple">
<li><p>TqSdk 要求 Python 3.6.4 以上版本, 不支持 Python 2.x</p></li>
<li><p>TqSdk 使用了Python3的async框架, 某些 IDE 不支持, 需要使用支持 async 的IDE, 例如 pycharm</p></li>
</ul>
<p>要学习使用 TqSdk, 推荐从 <a class="reference internal" href="index.html#quickstart"><span class="std std-ref">十分钟快速入门</span></a> 开始</p>
</section>
</section>
<span id="document-advanced/for_ctp_user"></span><section id="tqsdkctp">
<span id="for-ctp-user"></span><h3>TqSdk与使用Ctp接口开发策略程序有哪些差别<a class="headerlink" href="#tqsdkctp" title="Permalink to this headline">¶</a></h3>
<p>如果您曾经直接使用CTP接口开发过交易策略程序, 目前刚开始接触 TqSdk, 下面的信息将帮助您尽快理解 TqSdk.</p>
<section id="id1">
<h4>系统整体架构<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>CTP接口直接连接到期货公司交易系统, 从期货公司系统获取行情并执行交易指令.</p>
<p>TqSdk 则使用基于网络协作的组件设计. 如下图:</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="761px" viewBox="-0.5 -0.5 761 261" style="max-width:100%;max-height:261px;"><defs/><g><path d="M 620 60 L 620 40" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><a xlink:href="https://github.com/shinnytech/open-md-gateway"><rect x="480" y="60" width="280" height="40" fill="#fff2cc" stroke="#d6b656"/><g transform="translate(569.5,66.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="100" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 102px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><div><a href="https://github.com/shinnytech/open-md-gateway">Open Md Gateway</a></div><div><a href="https://github.com/shinnytech/open-md-gateway">行情网关</a></div></div></div></foreignObject><text x="50" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><a xlink:href="https://github.com/shinnytech/open-trade-gateway"><rect x="0" y="60" width="280" height="40" fill="#fff2cc" stroke="#d6b656"/><g transform="translate(82.5,66.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="114" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 116px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="https://github.com/shinnytech/open-trade-gateway">Open Trade Gateway<br />交易中继网关</a><br /></div></div></foreignObject><text x="57" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><rect x="0" y="0" width="280" height="40" fill="#eeeeee" stroke="#36393d"/><g transform="translate(84.5,6.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="110" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 110px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">期货公司交易系统<br />CTP / FEMAS / UFX<br /></div></div></foreignObject><text x="55" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">期货公司交易系统&lt;br&gt;CTP / FEMAS / UFX&lt;br&gt;</text></switch></g><rect x="480" y="0" width="280" height="40" fill="#eeeeee" stroke="#36393d"/><g transform="translate(577.5,13.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 85px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">交易所行情系统<br /></div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">交易所行情系统&lt;br&gt;</text></switch></g><path d="M 140 60 L 140 40" fill="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 380 120 L 140 100" fill="none" stroke="#000000" stroke-miterlimit="10"/><path d="M 380 120 L 620 100" fill="none" stroke="#000000" stroke-miterlimit="10"/><a xlink:href="http://doc.shinnytech.com/diff/latest/"><rect x="0" y="120" width="760" height="40" rx="6" ry="6" fill="#f8cecc" stroke="#b85450"/><g transform="translate(352.5,133.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="54" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 55px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="https://github.com/shinnytech/diff">DIFF 协议</a></div></div></foreignObject><text x="27" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><path d="M 380 180 L 380 160" fill="none" stroke="#000000" stroke-miterlimit="10"/><a xlink:href="http://www.shinnytech.com/tianqin"><rect x="320" y="180" width="120" height="40" fill="#dae8fc" stroke="#6c8ebf"/><g transform="translate(355.5,193.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 49px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="http://www.tq18.cn">天勤终端</a></div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a><a xlink:href="https://github.com/shinnytech/tqsdk-python"><rect x="320" y="220" width="120" height="40" fill="#dae8fc" stroke="#6c8ebf"/><g transform="translate(362.5,233.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="34" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;"><a href="https://github.com/shinnytech/tqsdk-python">TqSdk</a><br /></div></div></foreignObject><text x="17" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></a></g></svg><p>如图所示, 整个系统结构包括这些关键组件:</p>
<ul class="simple">
<li><p>行情网关 (Open Md Gateway) 负责提供实时行情和历史数据</p></li>
<li><p>交易中继网关 (Open Trade Gateway) 负责连接到期货公司交易系统</p></li>
<li><p>上面两个网关统一以 Diff 协议对下方提供服务</p></li>
<li><p>天勤终端和TqSdk按照Diff协议连接到行情网关和交易中继网关, 实现行情和交易功能</p></li>
</ul>
<p>这样的结构可以给用户带来一些好处:</p>
<ul class="simple">
<li><p>TqSdk 很小, 安装也很方便, 只要简单 pip install tqsdk 即可</p></li>
<li><p>官方专门运维行情数据库, 用户可以直接使用, 不需要自己接收和存储数据</p></li>
<li><p>交易相关接口被大幅度简化, 不再需要处理CTP接口的复杂回调, 也不需要发起任何查询请求</p></li>
<li><p>任何语言只要支持websocket协议, 都可以用来进行策略开发</p></li>
</ul>
<p>也有一些不如直接使用CTP接口方便的地方:</p>
<ul class="simple">
<li><p>由于交易指令经交易网关转发, 用户无法直接指定CTP服务器地址. 用户如果需要连接到官方交易网关不支持的期货公司, 需要自行部署交易网关.</p></li>
</ul>
</section>
<section id="k">
<h4>K线数据与指标计算<a class="headerlink" href="#k" title="Permalink to this headline">¶</a></h4>
<p>Ctp接口不提供K线数据.</p>
<p>在TqSdk中, K线数据和其它行情数据一样是由行情网关生成并推送的:</p>
<ul class="simple">
<li><p>用户不再需要维护K线数据库. 用户电脑实时行情中断后, 也不再需要补历史数据</p></li>
<li><p>行情服务器生成K线时, 采用了按K线时间严格补全对齐的算法. 这与其它软件有明显区别, 详见 <a class="reference external" href="https://www.shinnytech.com/blog/why-our-kline-different/">https://www.shinnytech.com/blog/why-our-kline-different/</a></p></li>
<li><p>行情数据只在每次程序运行时通过网络获取, 不在用户硬盘保存. 如果策略研究工作需要大量静态历史数据, 我们推荐使用数据下载工具, 另行下载csv文件使用.</p></li>
</ul>
<p>TqSdk中的K线序列采用 pandas.DataFrame 格式. pandas 提供了 <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html">非常丰富的数据处理函数</a> , 使我们可以非常方便的进行数据处理, 例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ks</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>            <span class="c1"># &lt;- 最后一根K线</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>               <span class="c1"># &lt;- 收盘价序列</span>
<span class="n">ks</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="n">ks</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="c1"># &lt;- 每根K线最高价-前一根K线最高价, 形成一个新序列</span>
</pre></div>
</div>
<p>TqSdk 也通过 <code class="xref py py-mod docutils literal notranslate"><span class="pre">tqsdk.tafunc</span></code> 提供了一批行情分析中常用的计算函数, 例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">tafunc</span>
<span class="n">ks</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">ms</span> <span class="o">=</span> <span class="n">tafunc</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">open</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>           <span class="c1"># &lt;- 取每根K线开盘价和收盘价的高者构建一个新序列</span>
<span class="n">median3</span> <span class="o">=</span> <span class="n">tafunc</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>       <span class="c1"># &lt;- 求最近100根K线收盘价的中间值</span>
<span class="n">ss</span> <span class="o">=</span> <span class="n">tafunc</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>                 <span class="c1"># &lt;- 每5根K线的收盘价标准差</span>
</pre></div>
</div>
</section>
<section id="id3">
<h4>数据接收和更新<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>Ctp接口按照事件回调模型设计, 使用 CThostFtdcTraderSpi 的 OnXXX 回调函数进行行情数据和回单处理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>class MySpiHandler
  : public CThostFtdcTraderSpi
{
public:
  ///当客户端与交易后台建立起通信连接时（还未登录前），该方法被调用。
  virtual void OnFrontConnected();

  ///报单通知
  virtual void OnRtnOrder(CThostFtdcOrderField *pOrder);

  ///成交通知
  virtual void OnRtnTrade(CThostFtdcTradeField *pTrade);
}
</pre></div>
</div>
<p>TqSdk则不使用事件回调机制. <code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_update()</span></code> 函数设计用来获取任意数据更新, 像这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>       <span class="c1"># &lt;- 这个 wait_update 将尝试更新所有数据. 如果没有任何新信息, 程序会阻塞在这一句. 一旦有任意数据被更新, 程序会继续往下执行</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                <span class="c1"># &lt;- 显示委托单最新状态</span>
</pre></div>
</div>
<p>一次 wait_update 可能更新多个实体, 在这种情况下, <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_changing()</span></code> 被用来判断某个实体是否有变更:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">)</span>
<span class="n">ks</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_kline_serial</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SHFE.cu1901&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>      <span class="c1"># &lt;- 这个 wait_update 将尝试更新所有数据. 如果没有任何新信息, 程序会阻塞在这一句. 一旦有任意数据被更新, 程序会继续往下执行</span>
  <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">q</span><span class="p">):</span> <span class="c1"># &lt;- 这个 is_changing 用来判定这次更新是否影响到了q</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">api</span><span class="o">.</span><span class="n">is_changing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">):</span> <span class="c1"># &lt;- 这个 is_changing 用来判定这次更新是否影响到了报单的status字段</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>TqSdk针对行情数据和交易信息都采用相同的 wait_update/is_changing 方案. 用户需要记住的要点包括:</p>
<ul class="simple">
<li><p>get_quote, get_kline_serial, insert_order 等业务函数返回的是一个引用(refrence, not value), 它们的值总是在 wait_update 时更新.</p></li>
<li><p>用户程序除执行自己业务逻辑外, 需要反复调用 wait_update. 在两次 wait_update 间, 所有数据都不更新</p></li>
<li><p>用 insert_order 函数下单, 报单指令实际是在 insert_order 后调用 wait_update 时发出的.</p></li>
<li><p>用户程序中需要避免阻塞, 不要使用 sleep 暂停程序</p></li>
</ul>
<p>关于 wait_update 机制的详细说明, 请见 <a class="reference internal" href="index.html#framework"><span class="std std-ref">策略程序结构</span></a></p>
</section>
</section>
<span id="document-advanced/unanttended"></span><section id="unanttended">
<span id="id1"></span><h3>在无人监控环境下执行策略<a class="headerlink" href="#unanttended" title="Permalink to this headline">¶</a></h3>
<p>对于已经过充分测试, 十分成熟的策略程序, 也可以选择以无人值守方式运行.</p>
<section id="id2">
<h4>准备环境<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>TqSdk可以在windows/linux或macosx环境下运行. 无论您选择使用windows或linux系统, 请确保</p>
<ul class="simple">
<li><p>已经装有 Python 3.6+</p></li>
<li><p>安装 <a class="reference internal" href="index.html#tqsdk-install"><span class="std std-ref">TqSdk</span></a></p></li>
</ul>
<p>创建一个目录, 放置你所有的策略文件.</p>
</section>
<section id="id3">
<h4>在每个策略程序中设置实盘账号<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>将每个策略程序配置为独立直连实盘账号. 在创建 TqApi 时, 传入TqAccount实例. 注意期货公司名称需要与天勤中的名称一致:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqAccount</span><span class="p">(</span><span class="s2">&quot;H海通期货&quot;</span><span class="p">,</span> <span class="s2">&quot;022631&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="id4">
<h4>检查策略程序<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>将策略代码投入无人监控运行前, 除对策略代码进行全面测试外, 还应注意以下事项:</p>
<ul class="simple">
<li><p>使用 python 的 logging 模块输出日志信息到文件, 不要使用 print 打印日志信息</p></li>
<li><p>策略代码退出时记得调用 api.close() 函数, 或者用 with closing(api) 的格式确保退出时自动关闭</p></li>
<li><p>目前api在运行过程中抛出的异常, 默认处理都是整个策略进程直接退出. 如无特殊需求, 不要使用 expect: 的方式捕获异常并阻止程序退出, 这种情况如果没有正确处理, 可能产生难以预测的后果.</p></li>
</ul>
</section>
<section id="windows">
<h4>在 windows 环境下配置策略的定时启动/停止<a class="headerlink" href="#windows" title="Permalink to this headline">¶</a></h4>
<p>在 windows 下, 通常使用计划任务来管理策略的定时启动/停止, 下面的说明以 Windows 10 为例, 其它 windows 版本操作可能有少许差异.</p>
<p>打开 windows 任务计划管理器</p>
<img alt="_images/win10_start_scheduled_task.png" src="_images/win10_start_scheduled_task.png" />
<p>点击 创建基本任务</p>
<img alt="_images/win10_start_scheduled_task_create.png" src="_images/win10_start_scheduled_task_create.png" />
<p>为每个策略添加一个策略启动任务, [程序或脚本]处填 python.exe, [添加参数]处填策略代码py文件名和参数, [起始于]处填策略代码目录</p>
<img alt="_images/win10_start_scheduled_task_python.png" src="_images/win10_start_scheduled_task_python.png" />
<p>最后添加一个任务, 用来停止所有策略进程. [程序或脚本]处填 taskkill, [添加参数]处填 /IM python.exe</p>
<img alt="_images/win10_start_scheduled_task_taskkill.png" src="_images/win10_start_scheduled_task_taskkill.png" />
</section>
<section id="linux">
<h4>在 linux 环境下配置策略的定时启动/停止<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h4>
<p>在 linux 下, 通常使用 cron 服务来处理策略的定时启动/停止. 具体配置请参考您所使用linux发行版的相应文档.</p>
<section id="id5">
<h5>将一个策略应用于多个合约或多个账户<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<p>将一个策略应用于多个合约或多个账户是一个常见需求. 我们推荐使用 命令行参数 来传递合约或账户信息. 请看下面例子:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#  -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAccount</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqAccount</span><span class="p">(</span><span class="s2">&quot;H海通期货&quot;</span><span class="p">,</span> <span class="s2">&quot;0330203&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span><span class="p">),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 开仓两手并等待完成</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;SHFE.rb1901&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">4310</span><span class="p">,</span><span class="n">volume</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">while</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;已开仓&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>上面的代码中固定了账户及合约代码 SHFE.rb1901. 我们可以利用 python 的 argparse 模块为这个程序添加一些参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#  -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqSim</span><span class="p">,</span> <span class="n">TqAccount</span>

<span class="c1">#解析命令行参数</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--broker&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--user_name&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--password&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--symbol&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;策略参数为: &quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqAccount</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">broker</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">user_name</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">password</span><span class="p">),</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="c1"># 开仓两手并等待完成</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;OPEN&quot;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="mi">4310</span><span class="p">,</span><span class="n">volume</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">while</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;FINISHED&quot;</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;已开仓&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>要通过命令行运行此策略, 可以输入:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">args</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">broker</span><span class="o">=</span><span class="n">H海通期货</span> <span class="o">--</span><span class="n">user_name</span><span class="o">=</span><span class="mi">0330203</span> <span class="o">--</span><span class="n">password</span><span class="o">=</span><span class="mi">123456</span> <span class="o">--</span><span class="n">symbol</span><span class="o">=</span><span class="n">SHFE</span><span class="o">.</span><span class="n">cu1901</span>
</pre></div>
</div>
<p>要在 PyCharm 中同时执行此程序的多种参数版本, 可以通过 PyCharm 的 Run Configuration 实现.</p>
<p>先在 Edit Configuration 中, 为每组参数创建一个运行项</p>
<img alt="_images/pycharm_edit_configuration_entry.png" src="_images/pycharm_edit_configuration_entry.png" />
<img alt="_images/pycharm_edit_configuration.png" src="_images/pycharm_edit_configuration.png" />
<p>在 Edit Configuration 中配置好以后, 通过 Run... 菜单选择保存好的运行项, 即可实现带参数运行</p>
<img alt="_images/pycharm_run_configuration.png" src="_images/pycharm_run_configuration.png" />
</section>
</section>
</section>
<span id="document-advanced/targetpostask2"></span><section id="targetpostask">
<span id="targetpostask2"></span><h3>TargetPosTask 高级功能<a class="headerlink" href="#targetpostask" title="Permalink to this headline">¶</a></h3>
<p>本篇文档假设您已经了解 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 的用法，文档参考 <a class="reference internal" href="index.html#targetpostask"><span class="std std-ref">交易辅助工具</span></a>。</p>
<p>本篇文档主要介绍 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 的高级用法。如何使用<code class="xref py py-meth docutils literal notranslate"><span class="pre">cancel()</span></code> 和 <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_finished()</span></code> 方法。</p>
<section id="id1">
<h4>应用情景说明<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>任何时刻，每个账户下一个合约只能有一个 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 实例，并且其构造参数不能修改。</p>
<p>但是在某些情况下，用户会希望可以管理 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 实例。</p>
<p>比如说，用户使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 的 <strong>PASSIVE</strong> 模式进行下单，希望在收盘前取消所有挂单（包含 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 实例的未成委托单），并平仓。</p>
</section>
<section id="id2">
<h4>如何实现这样的功能<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 类提供了 <code class="xref py py-meth docutils literal notranslate"><span class="pre">cancel()</span></code> 和 <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_finished()</span></code> 方法。</p>
<ul class="simple">
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">cancel()</span></code> 方法会取消当前 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 实例，会将该实例已经发出但还未成交的委托单撤单此实例的 set_target_volume 函数不会再生效，并且此实例的 set_target_volume 函数不会再生效。</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">is_finished()</span></code> 方法可以获取当前 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 实例是否已经结束。已经结束实例的 set_target_volume 函数不会再接受参数，此实例不会再下单或者撤单。</p></li>
</ul>
<p>下面是一个例子:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TargetPosTask</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.rb2110&quot;</span><span class="p">)</span>
<span class="n">target_pos_passive</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb2110&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="s2">&quot;PASSIVE&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">time</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">50</span><span class="p">):</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># ... 策略代码 ...</span>

<span class="c1"># 取消 TargetPosTask 实例</span>
<span class="n">target_pos_passive</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

<span class="k">while</span> <span class="ow">not</span> <span class="n">target_pos_passive</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>  <span class="c1"># 此循环等待 target_pos_passive 处理 cancel 结束</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>  <span class="c1"># 调用wait_update()，会对已经发出但还是未成交的委托单撤单</span>

<span class="c1"># 创建新的 TargetPosTask 实例</span>
<span class="n">target_pos_active</span> <span class="o">=</span> <span class="n">TargetPosTask</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.rb2110&quot;</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="s2">&quot;ACTIVE&quot;</span><span class="p">)</span>
<span class="n">target_pos_active</span><span class="o">.</span><span class="n">set_target_volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 平所有仓位</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="c1"># ... 策略代码 ...</span>

<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<span id="document-advanced/scheduler"></span><section id="target-pos-scheduler">
<span id="id1"></span><h3>基于时间维度目标持仓策略<a class="headerlink" href="#target-pos-scheduler" title="Permalink to this headline">¶</a></h3>
<p>本篇文档假设您已经了解 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 的用法，文档参考 <a class="reference internal" href="index.html#targetpostask"><span class="std std-ref">交易辅助工具</span></a>。</p>
<p>简单来说，<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 会创建 task，负责将指定合约调整到目标头寸（默认为账户的该合约净持仓）。</p>
<p>对于简单的大单拆分功能，可以在 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 类中设置拆分手数的上下限，<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 实例在下单过程中就会将下单手数随机的拆分，以减少对市场冲击。</p>
<p>但是，对于比较复杂的下单策略，例如 twap（基于时间拆分手数），vwap（基于成交量拆分手数）等，使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 来构造策略不是很方便。</p>
<p>我们提供 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosScheduler</span></code> 类帮助用户完成复杂的下单策略，同时提供给用户极大的调整空间。</p>
<section id="time-table">
<h4>time_table 目标持仓任务列表<a class="headerlink" href="#time-table" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosScheduler</span></code> 使用 <code class="docutils literal notranslate"><span class="pre">time_table</span></code> 参数来描述具体的下单策略。</p>
<p><code class="docutils literal notranslate"><span class="pre">time_table</span></code> 为 <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code> 类型。每一行表示一项目标持仓任务，每项任务按照顺序一个个执行。其应该包含以下几列：</p>
<ul class="simple">
<li><dl class="simple">
<dt>interval: 当前这项任务的持续时间长度，单位为秒，经过这么多秒之后，此项任务应该退出，剩余未调整到的目标持仓，会留到下一项任务中</dt><dd><ul>
<li><p>注意1：对于最后一项任务，会按照当前项参数，调整到目标持仓后立即退出（时间参数不对最后一项任务起作用）</p></li>
<li><p>注意2：时间长度可以跨非交易时间段（可以跨小节等待），但是不可以跨交易日</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>target_pos: 当前这项任务的目标净持仓手数</p></li>
<li><dl class="simple">
<dt>price: 当前这项任务的下单价格模式，此列中非 None 的项，会作为创建 TargetPosTask 实例的 price 参数，支持以下几种参数：</dt><dd><ul>
<li><p>None: 不下单，表示暂停一段时间</p></li>
<li><p>&quot;PASSIVE&quot; : 排队价下单</p></li>
<li><p>&quot;ACTIVE&quot;: 对价下单</p></li>
<li><p>Callable (direction: str) -&gt; Union[float, int]: 传入函数作为价格参数，函数参数为下单方向，函数返回值是下单价格。如果返回 nan，程序会抛错。</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="targetposscheduler">
<h4>TargetPosScheduler 执行目标持仓任务列表<a class="headerlink" href="#targetposscheduler" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosScheduler</span></code> 类创建 target_pos_scheduler 实例，首先会将 <code class="docutils literal notranslate"><span class="pre">time_table</span></code> 中 <code class="docutils literal notranslate"><span class="pre">interval</span></code> 间隔时间列转为 <code class="docutils literal notranslate"><span class="pre">deadline</span></code>，即这项任务结束时间的纳秒数。</p>
<p>然后，依次为 <code class="docutils literal notranslate"><span class="pre">time_table</span></code> 中的每一项任务创建 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 实例，调整目标持仓，并在到达 <code class="docutils literal notranslate"><span class="pre">deadline</span></code> 时退出。每一项未完成的目标持仓都会留都下一项任务中。</p>
<p>需要注意的是，最后一项任务，是以手数达到目标的，会按照当前项参数，调整到目标持仓再退出。如果最后一项 <code class="docutils literal notranslate"><span class="pre">price</span></code> 参数为 <code class="docutils literal notranslate"><span class="pre">None</span></code> （表示不下单），由于无法调整持仓，那么会立即退出。</p>
</section>
<section id="id2">
<h4>简单示例<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>简单示例及说明如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">time_table</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;PASSIVE&quot;</span><span class="p">]</span>
    <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">]</span>
    <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;PASSIVE&quot;</span><span class="p">]</span>
    <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">]</span>
<span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="s1">&#39;target_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">])</span>

<span class="n">target_pos_scheduler</span> <span class="o">=</span> <span class="n">TargetPosScheduler</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;SHFE.cu2112&quot;</span><span class="p">,</span> <span class="n">time_table</span><span class="p">)</span>

<span class="c1"># 这个 time_table 表示的下单策略依次是：</span>
<span class="c1"># 1. 使用排队价下单，调整 &quot;SHFE.cu2112&quot; 到 10 手，到达 25s 时退出（无论目标手数是否达到，都不会继续下单）</span>
<span class="c1"># 2. 使用对价下单，调整 &quot;SHFE.cu2112&quot; 到 10 手，到达 5s 时退出</span>
<span class="c1">#    如果上一步结束时目标持仓已经达到 10 手，这一步什么都不会做，等待 5s 到下一步；</span>
<span class="c1">#    如果上一步结束时目标持仓没有达到 10 手，这一步会继续调整目标持仓到 10 手</span>
<span class="c1"># 3. 使用排队价下单，调整 &quot;SHFE.cu2112&quot; 到 18 手，到达 30s 时退出（无论目标手数是否达到，都不会继续下单）</span>
<span class="c1"># 4. 使用对价下单，调整 &quot;SHFE.cu2112&quot; 到 18 手</span>
<span class="c1">#    如果上一步结束时目标持仓已经达到 18 手，这一步什么都不会做，立即退出；</span>
<span class="c1">#    如果上一步结束时目标持仓没有达到 18 手，这一步会继续调整目标持仓到 18 手后退出</span>
</pre></div>
</div>
<p>到此为止，您可以根据您的具体策略构造出任意的 <code class="docutils literal notranslate"><span class="pre">time_table</span></code> 对象，然后调用 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosScheduler</span></code> 来执行。</p>
<p>为了方便用户使用，我们提供了 <code class="xref py py-meth docutils literal notranslate"><span class="pre">twap_table()</span></code> 来生成一个默认的符合 twap 策略的 <code class="docutils literal notranslate"><span class="pre">time_table</span></code> 实例。</p>
</section>
<section id="targetposscheduler-twap">
<h4>基于 TargetPosScheduler 的 twap 策略示例<a class="headerlink" href="#targetposscheduler-twap" title="Permalink to this headline">¶</a></h4>
<p>我们在 <a class="reference internal" href="index.html#tqsdk-algorithm"><span class="std std-ref">tqsdk.algorithm - 算法模块</span></a> 模块中提供了 <code class="xref py py-meth docutils literal notranslate"><span class="pre">twap_table()</span></code>，可方便的生成一个基于 twap 策略的 <code class="docutils literal notranslate"><span class="pre">time_table</span></code> 实例。</p>
<p>在执行算法之前，您还可以定制化的调整 <code class="docutils literal notranslate"><span class="pre">time_table</span></code> 中的具体任务项。</p>
<p>一个完整的 twap 策略示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TargetPosScheduler</span>
<span class="kn">from</span> <span class="nn">tqsdk.algorithm</span> <span class="kn">import</span> <span class="n">twap_table</span>

<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="s2">&quot;快期账户,用户密码&quot;</span><span class="p">)</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;CZCE.MA109&quot;</span><span class="p">)</span>

<span class="c1"># 设置 twap 任务参数，</span>
<span class="n">time_table</span> <span class="o">=</span> <span class="n">twap_table</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;CZCE.MA105&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 目标持仓 -100 手，600s 内完成</span>

<span class="c1"># 定制化调整 time_table，例如希望第一项任务延迟 10s 再开始下单</span>
<span class="c1"># 可以在 time_table 的头部加一行</span>
<span class="n">time_table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">DataFrame</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="s1">&#39;target_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;price&#39;</span><span class="p">]),</span>
    <span class="n">time_table</span>
<span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">target_pos_sch</span> <span class="o">=</span> <span class="n">TargetPosScheduler</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="s2">&quot;CZCE.MA105&quot;</span><span class="p">,</span> <span class="n">time_table</span><span class="p">)</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">target_pos_sch</span><span class="o">.</span><span class="n">is_finished</span><span class="p">():</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>

<span class="c1"># 获取 target_pos_sch 实例所有的成交列表</span>
<span class="nb">print</span><span class="p">(</span><span class="n">target_pos_sch</span><span class="o">.</span><span class="n">trades_df</span><span class="p">)</span>

<span class="c1"># 利用成交列表，您可以计算出策略的各种表现指标，例如：</span>
<span class="n">average_trade_price</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scheduler</span><span class="o">.</span><span class="n">trades_df</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">trades_df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scheduler</span><span class="o">.</span><span class="n">trades_df</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;成交均价:&quot;</span><span class="p">,</span> <span class="n">average_trade_price</span><span class="p">)</span>
<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<span id="document-advanced/tqsdk2ctptest"></span><section id="tqsdk-tqsdk2">
<span id="tqsdk2ctptest"></span><h3>在 TqSdk 中调用 TqSdk2 查询保证金<a class="headerlink" href="#tqsdk-tqsdk2" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 没有直接提供查询保证金的接口，但是你可以通过使用 TqSdk2 的直连功能来做到这个效果。tqsdk和tqsdk2可以在一个py文件中同时运行。</p>
<p>该方法仅支持 TqSdk2 中直连CTP 柜台时使用。受限制于 CTP 柜台的流控机制(每秒 1 笔), 短时间发送大量查询指令后, 后续查询指令将会排队等待。
为了避免盘中的查询等待时间, 建议盘前启动程序, 对标的合约提前进行查询:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqAccount</span>
<span class="kn">import</span> <span class="nn">tqsdk2</span>

<span class="n">account</span> <span class="o">=</span> <span class="n">tqsdk2</span><span class="o">.</span><span class="n">TqCtp</span><span class="p">(</span><span class="n">front_url</span><span class="p">,</span> <span class="n">front_broker</span><span class="p">,</span> <span class="n">app_id</span><span class="p">,</span> <span class="n">auth_code</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
<span class="n">api_margin</span> <span class="o">=</span> <span class="n">tqsdk2</span><span class="o">.</span><span class="n">TqApi</span><span class="p">(</span><span class="n">account</span> <span class="o">=</span> <span class="n">account</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">tqsdk2</span><span class="o">.</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">rate</span> <span class="o">=</span> <span class="n">api_margin</span><span class="o">.</span><span class="n">get_margin_rates</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2201&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">TqAccount</span><span class="p">(</span><span class="s2">&quot;期货公司&quot;</span><span class="p">,</span><span class="s2">&quot;账号&quot;</span><span class="p">,</span><span class="s2">&quot;密码&quot;</span><span class="p">),</span><span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SHFE.cu2201&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">quote</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
    <span class="c1"># 正常和tqsdk一样执行策略</span>
</pre></div>
</div>
<p>TqSdk2 的直连功能需要企业版权限，有关企业版的具体费用和功能，请参考 <a class="reference external" href="https://www.shinnytech.com/tqsdk_professional/">天勤官方网站</a>
如果想了解更多关于 TqSdk2 的直连功能TqCtp，请参考 <a class="reference external" href="https://doc.shinnytech.com/tqsdk2/latest/reference/tqsdk2.ctp.html?highlight=tqctp#tqsdk2.TqCtp/">tqsdk2官方文档</a></p>
</section>
</div>
</section>
<span id="document-dev/index"></span><section id="tqsdk">
<span id="dev"></span><h2>参与TqSdk开发<a class="headerlink" href="#tqsdk" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-dev/general"></span><section id="dev-general">
<span id="id1"></span><h3>原则与规范<a class="headerlink" href="#dev-general" title="Permalink to this headline">¶</a></h3>
<section id="tqsdk">
<h4>TqSdk设计原则<a class="headerlink" href="#tqsdk" title="Permalink to this headline">¶</a></h4>
<section id="id2">
<h5>不预设用户策略模型<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<p>我们深刻认识到, 量化交易是一个充满竞争与创新的领域,成功的用户总是在不断构思和尝试全新的理念与模型. 在这方面, 用户比我们知道得更多, 走得也更快. 因此, 我们在设计TqSdk时, 总是尽力避免对用户的模型结构做限定, 而是专注于为用户提供通用性的资源和能力.</p>
<p>我们的以下设计决策遵循了此原则:</p>
<ul class="simple">
<li><p>不提供策略类模板, 只以示例程序方式展示各类策略应用</p></li>
<li><p>一个策略程序中可以任意获取数据和发出指令</p></li>
<li><p>允许用户在一个程序中使用任意多个TqApi实例</p></li>
</ul>
</section>
<section id="id3">
<h5>保持用户代码简单<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<p>我们对TqSdk的一个设计目标是尽量让用户的代码与需求方案保持一致(顺序相同, 篇幅相当).</p>
<p>我们的以下设计决策遵循了此原则:</p>
<ul class="simple">
<li><p>不使用多线程, 避免用户处理线程同步问题</p></li>
<li><p>不使用回调模型, 避免用户维护状态机状态变量</p></li>
<li><p>提供专门的调仓工具</p></li>
<li><p>实盘/模拟/回测/复盘 几种不同运行模式切换, 只需要在代码中做单点修改</p></li>
</ul>
</section>
<section id="id4">
<h5>行为可验证<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<p>作为TqSdk库质量管控的关键措施, 我们要求 TqSdk 在运行时可以记录完整的输入信息, 以确保发生问题时可以稳定重现问题和定位原因. 我们做了这些决定:</p>
<ul class="simple">
<li><p>以数据流衔接库中的各组件</p></li>
<li><p>TqSdk 的日志文件完整记录收到的全部数据包</p></li>
<li><p>专门构建了一个单元测试框架, 可以直接用日志作为测试用例输入</p></li>
</ul>
</section>
</section>
<section id="id5">
<h4>相关知识与技能<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>TqSdk 的开发涉及以下知识点，您可能需要先学习它们，才能更好的理解和改进TqSdk的代码</p>
<ul>
<li><p>金融相关业务知识</p>
<blockquote>
<div><p>TqSdk是用于金融交易领域的专用软件包。我们假定用户和开发者都已经具备相应的基础知识，在TqSdk的文档中不再详加解释。</p>
</div></blockquote>
</li>
<li><p>python asyncio</p>
<blockquote>
<div><p>TqSdk 的代码大量依赖 python asyncio 机制. asyncio 的编程模型与传统 python 程序差异很大. 我们对于TqSdk的使用者尽量隐藏了 asyncio 相关概念, 允许用户在不了解 asyncio 的情况下实现绝大多数业务需求. 但是对于开发者, 若不了解 asyncio, 在理解 TqSdk 内部代码实现时会非常困难。</p>
</div></blockquote>
</li>
<li><p>Diff协议</p>
<blockquote>
<div><p>TqSdk 并不是一个 all-in-one 的包, 它的能力有赖于一系列后台服务的支持. DIFF协议是 TqSdk 与后台服务间通讯的主要协议, 开发者需对 DIFF 有所理解, 才能掌握 TqSdk 的内部实现</p>
</div></blockquote>
</li>
<li><p>Pandas/Numpy</p>
<blockquote>
<div><p>Pandas/Numpy 是非常优秀的 python 数值计算库. TqSdk 利用这些库完成K线序列数据的存储和操作.</p>
</div></blockquote>
</li>
</ul>
</section>
<section id="id6">
<h4>代码风格<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>TqSdk的代码风格遵循 PEP8 规范.</p>
</section>
<section id="id7">
<h4>日志规范<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>&#64;todo: 待写</p>
</section>
</section>
<span id="document-dev/framework"></span><section id="tqsdk">
<span id="dev-framework"></span><h3>TqSdk整体结构<a class="headerlink" href="#tqsdk" title="Permalink to this headline">¶</a></h3>
<section id="id1">
<h4>文件结构<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 39%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>File</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>api.py</p></td>
<td><p>TqApi 接口主文件</p></td>
</tr>
<tr class="row-odd"><td><p>tqhelper.py</p></td>
<td><p>TqApi 辅助代码</p></td>
</tr>
<tr class="row-even"><td><p>exception.py</p></td>
<td><p>异常类型定义</p></td>
</tr>
<tr class="row-odd"><td><p>objs.py</p></td>
<td><p>主要业务数据结构定义</p></td>
</tr>
<tr class="row-even"><td><p>sim.py</p></td>
<td><p>本地模拟交易</p></td>
</tr>
<tr class="row-odd"><td><p>backtest.py</p></td>
<td><p>回测支持</p></td>
</tr>
<tr class="row-even"><td><p>lib.py</p></td>
<td><p>交易辅助工具</p></td>
</tr>
<tr class="row-odd"><td><p>ta.py</p></td>
<td><p>技术指标</p></td>
</tr>
<tr class="row-even"><td><p>tafunc.py</p></td>
<td><p>技术分析函数</p></td>
</tr>
<tr class="row-odd"><td><p>ctpse/*</p></td>
<td><p>穿透式监管信息采集模块</p></td>
</tr>
<tr class="row-even"><td><p>test/*</p></td>
<td><p>单元测试用例</p></td>
</tr>
<tr class="row-odd"><td><p>demo/*</p></td>
<td><p>示例程序</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id2">
<h4>数据流<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>TqSdk中以数据流的方式连接各组件。TqChan(本质是一个asyncio.Queue)被用作两个组件间的单向数据流管道，一个组件向 TqChan 中放入数据包，另一个组件从 TqChan 中依次取出数据包。</p>
<p>实盘运行时，整个数据流结构如下图:</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="484px" viewBox="-0.5 -0.5 484 281" style="max-width:100%;max-height:281px;"><defs/><g><rect x="0" y="0" width="200" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(37.5,6.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="124" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 124px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Websocket Client<br />To OpenTradeGateway</div></div></foreignObject><text x="62" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Websocket Client&lt;br&gt;To OpenTradeGateway</text></switch></g><rect x="280" y="0" width="200" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(324.5,6.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="110" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 110px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Websocket Client<br />To OpenMdGateway</div></div></foreignObject><text x="55" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Websocket Client&lt;br&gt;To OpenMdGateway</text></switch></g><rect x="0" y="120" width="480" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(210.5,133.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="58" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 58px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">TqAccount</div></div></foreignObject><text x="29" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqAccount</text></switch></g><path d="M 115 160.5 L 125 160.5 L 125 220.5 L 135.5 220.5 L 120 239.5 L 104.5 220.5 L 115 220.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(79.5,183.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="78" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">api_recv_chan</div></div></foreignObject><text x="39" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api_recv_chan</text></switch></g><path d="M 365 239.5 L 355 239.5 L 355 179.5 L 344.5 179.5 L 360 160.5 L 375.5 179.5 L 365 179.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(321.5,205.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="81" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">api_send_chan</div></div></foreignObject><text x="41" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api_send_chan</text></switch></g><rect x="0" y="240" width="480" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(223.5,253.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="32" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">TqApi</div></div></foreignObject><text x="16" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqApi</text></switch></g><path d="M 35 40.5 L 45 40.5 L 45 100.5 L 55.5 100.5 L 40 119.5 L 24.5 100.5 L 35 100.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(2.5,63.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="72" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">td_recv_chan</div></div></foreignObject><text x="36" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">td_recv_chan</text></switch></g><path d="M 165 119.5 L 155 119.5 L 155 59.5 L 144.5 59.5 L 160 40.5 L 175.5 59.5 L 165 59.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(124.5,85.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="75" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">td_send_chan</div></div></foreignObject><text x="38" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">td_send_chan</text></switch></g><path d="M 314.5 40.5 L 324.5 40.5 L 324.5 100.5 L 335 100.5 L 319.5 119.5 L 304 100.5 L 314.5 100.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(278.5,63.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="79" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">md_recv_chan</div></div></foreignObject><text x="40" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">md_recv_chan</text></switch></g><path d="M 444.5 119.5 L 434.5 119.5 L 434.5 59.5 L 424 59.5 L 439.5 40.5 L 455 59.5 L 444.5 59.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(400.5,85.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="82" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">md_send_chan</div></div></foreignObject><text x="41" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">md_send_chan</text></switch></g></g></svg><p>数据包上行流程(以报单为例):</p>
<ol class="arabic simple">
<li><p>用户程序调用 TqApi 中的某些需要发出数据包的功能函数, 以 TqApi.insert_order 为例</p></li>
<li><p>TqApi.insert_order 函数生成一个需要发出的数据包, 将此数据包放入 api_send_chan</p></li>
<li><p>TqAccount 从 api_send_chan 中取出此数据包，根据 aid 字段，决定将此数据包放入 td_send_chan</p></li>
<li><p>连接到交易网关的 websocket client 从 td_send_chan 中取出此数据包，通过网络发出</p></li>
</ol>
<p>数据包下行流程(以接收行情为例):</p>
<ol class="arabic simple">
<li><p>连接到行情网关的 websocket client 从网络收到一个数据包，将其放入 md_recv_chan</p></li>
<li><p>TqAccount 从md_recv_chan中取出此数据包，将它放入 api_recv_chan</p></li>
<li><p>TqApi 从api_recv_chan中取出此数据包，将数据包中携带的行情数据合并到内存存储区中</p></li>
</ol>
<p>基于这样的数据流结构，可以通过简单更换部分组件的方式实现不同工作模式。例如模拟交易时，我们用 TqSim 替换 TqAccount:</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="484px" viewBox="-0.5 -0.5 484 281" style="max-width:100%;max-height:281px;"><defs/><g><rect x="280" y="0" width="200" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(324.5,6.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="110" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 110px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Websocket Client<br />To OpenMdGateway</div></div></foreignObject><text x="55" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Websocket Client&lt;br&gt;To OpenMdGateway</text></switch></g><rect x="0" y="120" width="480" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(222.5,133.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="34" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">TqSim</div></div></foreignObject><text x="17" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqSim</text></switch></g><path d="M 115 160.5 L 125 160.5 L 125 220.5 L 135.5 220.5 L 120 239.5 L 104.5 220.5 L 115 220.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(79.5,183.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="78" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">api_recv_chan</div></div></foreignObject><text x="39" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api_recv_chan</text></switch></g><path d="M 365 239.5 L 355 239.5 L 355 179.5 L 344.5 179.5 L 360 160.5 L 375.5 179.5 L 365 179.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(321.5,205.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="81" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">api_send_chan</div></div></foreignObject><text x="41" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api_send_chan</text></switch></g><rect x="0" y="240" width="480" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(223.5,253.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="32" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">TqApi</div></div></foreignObject><text x="16" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqApi</text></switch></g><path d="M 314.5 40.5 L 324.5 40.5 L 324.5 100.5 L 335 100.5 L 319.5 119.5 L 304 100.5 L 314.5 100.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(278.5,63.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="79" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">md_recv_chan</div></div></foreignObject><text x="40" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">md_recv_chan</text></switch></g><path d="M 444.5 119.5 L 434.5 119.5 L 434.5 59.5 L 424 59.5 L 439.5 40.5 L 455 59.5 L 444.5 59.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(400.5,85.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="82" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">md_send_chan</div></div></foreignObject><text x="41" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">md_send_chan</text></switch></g></g></svg><p>策略回测则是这样:</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="484px" viewBox="-0.5 -0.5 484 401" style="max-width:100%;max-height:401px;"><defs/><g><rect x="280" y="0" width="200" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(324.5,6.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="110" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 110px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">Websocket Client<br />To OpenMdGateway</div></div></foreignObject><text x="55" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Websocket Client&lt;br&gt;To OpenMdGateway</text></switch></g><rect x="0" y="240" width="480" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(222.5,253.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="34" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 36px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">TqSim</div></div></foreignObject><text x="17" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqSim</text></switch></g><path d="M 115 280.5 L 125 280.5 L 125 340.5 L 135.5 340.5 L 120 359.5 L 104.5 340.5 L 115 340.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(79.5,303.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="78" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">api_recv_chan</div></div></foreignObject><text x="39" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api_recv_chan</text></switch></g><path d="M 365 359.5 L 355 359.5 L 355 299.5 L 344.5 299.5 L 360 280.5 L 375.5 299.5 L 365 299.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(321.5,325.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="81" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">api_send_chan</div></div></foreignObject><text x="41" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api_send_chan</text></switch></g><rect x="0" y="360" width="480" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(223.5,373.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="32" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">TqApi</div></div></foreignObject><text x="16" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqApi</text></switch></g><path d="M 314.5 40.5 L 324.5 40.5 L 324.5 100.5 L 335 100.5 L 319.5 119.5 L 304 100.5 L 314.5 100.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(278.5,63.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="79" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">md_recv_chan</div></div></foreignObject><text x="40" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">md_recv_chan</text></switch></g><path d="M 444.5 119.5 L 434.5 119.5 L 434.5 59.5 L 424 59.5 L 439.5 40.5 L 455 59.5 L 444.5 59.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(400.5,85.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="82" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">md_send_chan</div></div></foreignObject><text x="41" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">md_send_chan</text></switch></g><rect x="0" y="120" width="480" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(209.5,133.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="60" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 62px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">TqBacktest</div></div></foreignObject><text x="30" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqBacktest</text></switch></g><path d="M 115 160.5 L 125 160.5 L 125 220.5 L 135.5 220.5 L 120 239.5 L 104.5 220.5 L 115 220.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(64.5,183.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="107" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">backtest_recv_chan</div></div></foreignObject><text x="54" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">backtest_recv_chan</text></switch></g><path d="M 365 239.5 L 355 239.5 L 355 179.5 L 344.5 179.5 L 360 160.5 L 375.5 179.5 L 365 179.5 Z" fill="none" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(307.5,205.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="110" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">backtest_send_chan</div></div></foreignObject><text x="55" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">backtest_send_chan</text></switch></g></g></svg></section>
<section id="id3">
<h4>内存数据存储与更新<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>按照 DIFF 协议推荐的客户端最佳实践，TqApi 使用单一变量(TqApi._data)存储所有业务数据, 它的结构如下:</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="581px" viewBox="-0.5 -0.5 581 882" style="max-width:100%;max-height:882px;"><defs/><g><path d="M 40 40 L 40 880" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="0" y="0" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(37.5,13.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="4" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 4px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">/</div></div></foreignObject><text x="2" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">/</text></switch></g><path d="M 100 100 L 40 100" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 140 120 L 140 160 L 200 160" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="100" y="80" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(121.5,93.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="36" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 38px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">quotes</div></div></foreignObject><text x="18" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">quotes</text></switch></g><path d="M 240 180 L 240 210 L 300 210" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="200" y="140" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(202.5,153.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="74" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 76px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">SHFE.cu1901</div></div></foreignObject><text x="37" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">SHFE.cu1901</text></switch></g><rect x="300" y="200" width="80" height="20" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(313.5,203.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="52" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 52px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">last_price</div></div></foreignObject><text x="26" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">last_price</text></switch></g><path d="M 300 250 L 240 250 L 240 180" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="300" y="240" width="80" height="20" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(320.5,243.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="38" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 40px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">volume</div></div></foreignObject><text x="19" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">volume</text></switch></g><path d="M 200 300 L 140 300 L 140 120" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="200" y="280" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(202.5,293.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="74" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 76px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">SHFE.cu1902</div></div></foreignObject><text x="37" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">SHFE.cu1902</text></switch></g><path d="M 100 380 L 40 380 L 40 40" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="100" y="360" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(124.5,373.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="30" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">klines</div></div></foreignObject><text x="15" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">klines</text></switch></g><path d="M 100 440 L 40 440 L 40 40" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="100" y="420" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(127.5,433.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="24" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 25px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">ticks</div></div></foreignObject><text x="12" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">ticks</text></switch></g><path d="M 100 500 L 40 500 L 40 40" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="100" y="480" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(125.5,493.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="28" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 28px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">trade</div></div></foreignObject><text x="14" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">trade</text></switch></g><path d="M 200 560 L 140 560 L 140 520" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="200" y="540" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(224.5,553.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="30" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 32px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">user1</div></div></foreignObject><text x="15" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">user1</text></switch></g><path d="M 300 620 L 240 620 L 240 580" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="300" y="600" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(315.5,613.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 48px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">positions</div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">positions</text></switch></g><path d="M 400 680 L 340 680 L 340 640" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="400" y="660" width="80" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(402.5,673.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="74" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 76px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">SHFE.cu1901</div></div></foreignObject><text x="37" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">SHFE.cu1901</text></switch></g><path d="M 500 730 L 440 730 L 440 700" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="500" y="720" width="80" height="20" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(515.5,723.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 50px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">pos_long</div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">pos_long</text></switch></g><path d="M 500 770 L 440 770 L 440 700" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="500" y="760" width="80" height="20" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(513.5,763.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="52" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 54px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">pos_short</div></div></foreignObject><text x="26" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">pos_short</text></switch></g></g></svg><p>在每次收到数据包时，TqApi都会将数据包内容合并到 TqApi._data 中. 具体的代码流程如下:</p>
<ol class="arabic">
<li><p>websocket client 收到数据包, 放入 TqApi._pending_diffs</p></li>
<li><p>wait_update 函数发现 TqApi._pending_diffs 有待处理数据包, 中止异步循环以处理此数据包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_timeout</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_diffs</span><span class="p">:</span>     <span class="c1"># 这里发现 self._pending_diffs 非空, 中止 while 循环</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_run_once</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>wait_update 调用 self._merge_diff 函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diffs</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_merge_diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prototype</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>TqApi._merge_diff 函数将收到的数据包并入本地存储.</p></li>
<li><p>对于k线之类的序列数据, 后续继续将更新的数据复制到 pandas dataframe 中</p></li>
</ol>
</section>
<section id="id4">
<h4>异步任务调度<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>TqApi 在 wait_update 函数中完成所有异步任务的调度执行. 每当用户程序执行 api.wait_update 函数时, 会调度所有 task 运行, 直到收到新数据包或超时 wait_update函数返回, 继续执行后续用户代码</p>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="401px" viewBox="-0.5 -0.5 401 601" style="max-width:100%;max-height:601px;"><defs/><g><path d="M 60 40 L 60 73.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 60 78.88 L 56.5 71.88 L 60 73.63 L 63.5 71.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="0" y="0" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(35.5,13.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 49px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">用户代码</div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">用户代码</text></switch></g><path d="M 60 120 L 60 153.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 60 158.88 L 56.5 151.88 L 60 153.63 L 63.5 151.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="0" y="80" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(17.5,93.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 86px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">api.wait_update</div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api.wait_update</text></switch></g><path d="M 60 200 L 60 233.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 60 238.88 L 56.5 231.88 L 60 233.63 L 63.5 231.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="0" y="160" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(35.5,173.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 49px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">用户代码</div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">用户代码</text></switch></g><path d="M 60 280 L 60 313.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 60 318.88 L 56.5 311.88 L 60 313.63 L 63.5 311.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="0" y="240" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(17.5,253.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 86px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">api.wait_update</div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api.wait_update</text></switch></g><rect x="280" y="180" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(295.5,186.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="88" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 90px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">websocket client<br />发送 task</div></div></foreignObject><text x="44" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">websocket client&lt;br&gt;发送 task</text></switch></g><rect x="280" y="220" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(295.5,226.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="88" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 90px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">websocket client<br />接收 task</div></div></foreignObject><text x="44" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">websocket client&lt;br&gt;接收 task</text></switch></g><rect x="280" y="300" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(286.5,313.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="106" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 108px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">用户创建的其它task</div></div></foreignObject><text x="53" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">用户创建的其它task</text></switch></g><rect x="280" y="260" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(289.5,273.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="100" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 100px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">TqSdk创建的tqsdk</div></div></foreignObject><text x="50" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">TqSdk创建的tqsdk</text></switch></g><path d="M 120 240 L 282.04 183" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 122.04 280 L 280 338" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 60 360 L 60 393.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 60 398.88 L 56.5 391.88 L 60 393.63 L 63.5 391.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="0" y="320" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(35.5,333.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 49px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">用户代码</div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">用户代码</text></switch></g><path d="M 60 440 L 60 473.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 60 478.88 L 56.5 471.88 L 60 473.63 L 63.5 471.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="0" y="400" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(17.5,413.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 86px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">api.wait_update</div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api.wait_update</text></switch></g><path d="M 60 520 L 60 553.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 60 558.88 L 56.5 551.88 L 60 553.63 L 63.5 551.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><rect x="0" y="480" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(35.5,493.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="48" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 49px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">用户代码</div></div></foreignObject><text x="24" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">用户代码</text></switch></g><rect x="0" y="560" width="120" height="40" fill="#ffffff" stroke="#000000" pointer-events="none"/><g transform="translate(17.5,573.5)"><switch><foreignObject style="overflow:visible;" pointer-events="none" width="84" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 86px; white-space: nowrap; overflow-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;white-space:normal;">api.wait_update</div></div></foreignObject><text x="42" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">api.wait_update</text></switch></g></g></svg></section>
</section>
<span id="document-dev/async_tool"></span><section id="dev-async-tool">
<span id="id1"></span><h3>异步工具<a class="headerlink" href="#dev-async-tool" title="Permalink to this headline">¶</a></h3>
<p>&#64;todo: 待写</p>
</section>
<span id="document-dev/gui"></span><section id="web-gui">
<span id="dev-gui"></span><h3>Web Gui<a class="headerlink" href="#web-gui" title="Permalink to this headline">¶</a></h3>
<p>&#64;todo: 待写</p>
</section>
<span id="document-dev/backtest"></span><section id="dev-backtest">
<span id="id1"></span><h3>策略回测框架<a class="headerlink" href="#dev-backtest" title="Permalink to this headline">¶</a></h3>
<p>&#64;todo: 待写</p>
</section>
<span id="document-dev/unittest"></span><section id="dev-unittest">
<span id="id1"></span><h3>单元测试<a class="headerlink" href="#dev-unittest" title="Permalink to this headline">¶</a></h3>
<p>&#64;todo: 待写</p>
</section>
</div>
</section>
<span id="document-profession"></span><section id="tqsdk">
<span id="profession"></span><h2>TqSdk 专业版<a class="headerlink" href="#tqsdk" title="Permalink to this headline">¶</a></h2>
<p>TqSdk 中大部分功能是供用户免费使用的, 同时我们也提供了专业版的增值功能供用户选择</p>
<p>如果想使用 TqSdk 专业版功能，可以登录 <a class="reference external" href="https://account.shinnytech.com/">个人中心</a> 申请15天试用或正式购买</p>
<section id="id2">
<h3>快期专业版产品使用权限<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>在当用户购买专业版的产品服务时，不仅仅是包含 TqSdk 专业版的功能，同时也包含一份对应时长的快期专业版使用权限</p>
<p><a class="reference external" href="https://www.shinnytech.com/qpro/">快期专业版</a> 是专门为专业用户开发的一套PC客户端，能支持用户多账户，多柜台(CTP,CTPMINI,易盛v10,v9,大连Xone,融航,杰宜斯)等柜台登录</p>
<p>此外还提供了丰富的交易手段与监控功能，帮助用户在程序化交易的同时能有一个PC端进行辅助监控与交易</p>
<p>其中的持仓账户监控功能，内置了一基于grafana实时的监控手段，每5s存储一次用户的账户和持仓数据在本地，供用户对这些数据进行可视化分析</p>
<p>例如回答用户今天的客户权益变动情况，和今天的最大权益和最小权益的发生时间等</p>
<figure class="align-default" id="id17">
<img alt="_images/how-grafana04.gif" src="_images/how-grafana04.gif" />
<figcaption>
<p><span class="caption-text"><a class="reference external" href="https://www.shinnytech.com/qpro/">快期专业版官网地址</a></span><a class="headerlink" href="#id17" title="Permalink to this image">¶</a></p>
<div class="legend">
<p><a class="reference external" href="https://publish2.shinnytech.com/doc/qpro/latest/quickstart.html/">快期专业版文档地址</a></p>
</div>
</figcaption>
</figure>
</section>
<section id="id6">
<h3>更稳定的行情服务器<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>在每次的行情服务器升级当中，我们会优先选择连接到免费版行情服务器中的百分之十左右的用户进行升级，然后在稳定后逐步扩大免费版的升级范围</p>
<p>专业版的行情服务器会在免费版全部升级成功且没有问题之后再进行升级，因此对于 TqSdk 的专业版用户来说，会有更稳定行情服务器连接</p>
</section>
<section id="id7">
<h3>更多的实盘交易账户数<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>对于 TqSdk 免费版，每个快期账户支持最多绑定一个实盘账户，而天勤量化专业版支持最多一个快期账户绑定3个实盘账户</p>
<p>快期账户会在用户使用实盘账户时自动进行绑定，直到该快期账户没有能绑定实盘账户的名额(自动绑定功能需要 TqSdk 版本&gt; 1.8.3)</p>
<p>如果需要注册快期账户或者修改您的快期账户绑定的实盘账户，请点击 <a class="reference external" href="https://account.shinnytech.com/">登录用户管理中心</a></p>
<p>登录成功后显示如下，在下方红框处,用户可以自行解绑/绑定实盘账户，其中解绑操作每天限定一次</p>
<figure class="align-default">
<img alt="_images/user_web_management.png" src="_images/user_web_management.png" />
</figure>
<p>如需一个快期账户支持更多的实盘账户，请联系工作人员进行批量购买 <a class="reference external" href="https://account.shinnytech.com/">个人中心</a></p>
</section>
<section id="id10">
<h3>策略回测功能<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="index.html#backtest"><span class="std std-ref">策略程序回测</span></a> 是 TqSdk 专业版中的功能，能让用户在不改变代码的情况下去回测自己的策略在历史行情的表现，并且提供对应的web界面来统计用户的回测表现</p>
<figure class="align-default">
<img alt="_images/web_gui_backtest.png" src="_images/web_gui_backtest.png" />
</figure>
<p>对于 TqSdk 免费版本的用户，每天可以进行3次回测，同时也可以申请模拟账户后模拟运行来检验策略 <a class="reference internal" href="index.html#sim-trading"><span class="std std-ref">模拟交易和论坛</span></a></p>
</section>
<section id="id11">
<h3>股票行情<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 免费版本提供全部的期货、商品/金融期权和上证50、沪深300和中证500的实时行情</p>
<p>购买或申请 TqSdk 专业版试用后可提供A股股票的实时和历史行情，TqSdk 中股票示例代码参考如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SSE</span><span class="mf">.600000</span> <span class="o">-</span> <span class="n">上交所浦发银行股票编码</span>
<span class="n">SZSE</span><span class="mf">.000001</span> <span class="o">-</span> <span class="n">深交所平安银行股票编码</span>
<span class="n">SSE</span><span class="mf">.000016</span> <span class="o">-</span> <span class="n">上证50指数</span>
<span class="n">SSE</span><span class="mf">.000300</span> <span class="o">-</span> <span class="n">沪深300指数</span>
<span class="n">SSE</span><span class="mf">.000905</span> <span class="o">-</span> <span class="n">中证500指数</span>
<span class="n">SSE</span><span class="mf">.510050</span> <span class="o">-</span> <span class="n">上交所上证50etf</span>
<span class="n">SSE</span><span class="mf">.510300</span> <span class="o">-</span> <span class="n">上交所沪深300etf</span>
<span class="n">SZSE</span><span class="mf">.159919</span> <span class="o">-</span> <span class="n">深交所沪深300etf</span>
<span class="n">SSE</span><span class="mf">.10002513</span> <span class="o">-</span> <span class="n">上交所上证50etf期权</span>
<span class="n">SSE</span><span class="mf">.10002504</span> <span class="o">-</span> <span class="n">上交所沪深300etf期权</span>
<span class="n">SZSE</span><span class="mf">.90000097</span> <span class="o">-</span> <span class="n">深交所沪深300etf期权</span>
</pre></div>
</div>
</section>
<section id="profession-tqkqstock">
<span id="id12"></span><h3>股票模拟交易<a class="headerlink" href="#profession-tqkqstock" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 提供了 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqKqStock</span></code> 方法供用户来进行股票的模拟交易</p>
<p>专业版用户可以长久的对同一账户进行模拟股票交易测试</p>
<p>需要注意股票模拟交易下，get_account，get_order，get_position 会返回对应股票交易模型下的 objs ，如 <code class="xref py py-class docutils literal notranslate"><span class="pre">SecurityAccount</span></code>， <code class="xref py py-class docutils literal notranslate"><span class="pre">SecurityOrder</span></code>，<code class="xref py py-class docutils literal notranslate"><span class="pre">SecurityPosition</span></code></p>
<p>参考代码如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqKqStock</span>

<span class="n">tq_kq_stock</span> <span class="o">=</span> <span class="n">TqKqStock</span><span class="p">()</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">account</span><span class="o">=</span><span class="n">tq_kq_stock</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span> <span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
<span class="n">quote</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_quote</span><span class="p">(</span><span class="s2">&quot;SSE.688529&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">quote</span><span class="p">)</span>
<span class="c1"># 下单限价单</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">insert_order</span><span class="p">(</span><span class="s2">&quot;SSE.688529&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;BUY&quot;</span><span class="p">,</span> <span class="n">limit_price</span><span class="o">=</span><span class="n">quote</span><span class="o">.</span><span class="n">ask_price1</span><span class="p">)</span>
<span class="k">while</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;ALIVE&#39;</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">wait_update</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>  <span class="c1"># 打印委托单信息</span>

<span class="nb">print</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">get_account</span><span class="p">())</span>  <span class="c1"># 打印快期股票模拟账户信息</span>

<span class="nb">print</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="s2">&quot;SSE.688529&quot;</span><span class="p">))</span>  <span class="c1"># 打印持仓信息</span>

<span class="k">for</span> <span class="n">trade</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">trade_records</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">trade</span><span class="p">)</span>  <span class="c1"># 打印委托单对应的成交信息</span>
<span class="n">api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id13">
<h3>下载数据功能<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>数据下载工具 <code class="xref py py-class docutils literal notranslate"><span class="pre">DataDownloader</span></code> 是 TqSdk 专业版中的功能</p>
<p>支持专业版用户下载目前 TqSdk 提供的全部期货、期权和股票类的历史数据，下载数据支持 tick 级别精度和任意 kline 周期</p>
</section>
<section id="id14">
<h3>其他相关函数<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">query_symbol_ranking()</span></code> 交易所每日成交持仓排名</p>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_data_series()</span></code> 以起始日期获取 Dataframe 格式的 kline 数据</p>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_trading_status()</span></code> 获取指定合约的交易状态，帮助用户实现开盘/跨小节抢单</p>
</div></blockquote>
</section>
<section id="id15">
<h3>期权交易 &amp; 交易所组合<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>TqSdk 中期权交易(商品期权、金融期权)和交易所官方组合也是 TqSdk 专业版中提供的功能</p>
<p>详细期权说明请点击 <a class="reference internal" href="index.html#option-trade"><span class="std std-ref">期权交易 &amp; 交易所官方组合</span></a></p>
<p>TqSdk 中期权和交易所组合合约代码参考如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DCE</span><span class="o">.</span><span class="n">m1807</span><span class="o">-</span><span class="n">C</span><span class="o">-</span><span class="mi">2450</span> <span class="o">-</span> <span class="n">大商所豆粕期权</span>
<span class="n">CZCE</span><span class="o">.</span><span class="n">CF003C11000</span> <span class="o">-</span> <span class="n">郑商所棉花期权</span>
<span class="n">SHFE</span><span class="o">.</span><span class="n">au2004C308</span> <span class="o">-</span> <span class="n">上期所黄金期权</span>
<span class="n">CFFEX</span><span class="o">.</span><span class="n">IO2002</span><span class="o">-</span><span class="n">C</span><span class="o">-</span><span class="mi">3550</span> <span class="o">-</span> <span class="n">中金所沪深300股指期权</span>
<span class="n">SSE</span><span class="mf">.10002513</span> <span class="o">-</span> <span class="n">上交所上证50etf期权</span>
<span class="n">SSE</span><span class="mf">.10002504</span> <span class="o">-</span> <span class="n">上交所沪深300etf期权</span>
<span class="n">SZSE</span><span class="mf">.90000097</span> <span class="o">-</span> <span class="n">深交所沪深300etf期权</span>
<span class="n">CZCE</span><span class="o">.</span><span class="n">SPD</span> <span class="n">SR901</span><span class="o">&amp;</span><span class="n">SR903</span> <span class="o">-</span> <span class="n">郑商所</span> <span class="n">SR901</span><span class="o">&amp;</span><span class="n">SR903</span> <span class="n">跨期合约</span>
<span class="n">DCE</span><span class="o">.</span><span class="n">SP</span> <span class="n">a1709</span><span class="o">&amp;</span><span class="n">a1801</span> <span class="o">-</span> <span class="n">大商所</span> <span class="n">a1709</span><span class="o">&amp;</span><span class="n">a1801</span> <span class="n">跨期合约</span>
</pre></div>
</div>
</section>
<section id="id16">
<h3>工作时间内的天勤客服支持<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<p>如果您是 TqSdk 专业版的年费用户，那么我们将会单独为您建立一个讨论组，里面会有 TqSdk 的专门技术支持人员在工作时间内优先回答您的问题</p>
</section>
</section>
<span id="document-enterprise"></span><section id="tqsdk2">
<span id="enterprise"></span><h2>TqSdk2 企业版<a class="headerlink" href="#tqsdk2" title="Permalink to this headline">¶</a></h2>
<p>除了 TqSdk 专业版以外，我们还提供 TqSdk2 企业版本来供用户使用，如果想了解专业版和企业版的区别，<a class="reference external" href="https://doc.shinnytech.com/tqsdk2/latest/advanced/for_tqsdk1_user.html#tqsdk2-tqsdk">可以点击查看 TqSdk2 文档</a></p>
<p>如果想使用 TqSdk2 企业版功能，可以点击 <a class="reference external" href="https://account.shinnytech.com/">个人中心</a> 申请15天试用或购买</p>
<p>企业版本提供专业版的全部功能 <a class="reference internal" href="index.html#profession"><span class="std std-ref">TqSdk 专业版</span></a> ，且 TqSdk 和 TqSdk2 专业版权限通用，此外还包含如下功能</p>
<section id="id3">
<h3>TqSdk2 直连功能<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>在 TqSdk2 中除了通过中继模式接入期货公司以外，还提供用户通过直连模式接入任意一家指定期货公司</p>
<p>除了接入指定期货公司的优点以外，直连模式还带来了一下好处:</p>
<ul class="simple">
<li><p>交易指令直达期货公司，省去中继服务器路径，交易延迟平均减少10ms左右</p></li>
<li><p>减少了交易服务器依赖，程序运行稳定性提升</p></li>
</ul>
</section>
<section id="tqjees">
<span id="id4"></span><h3>TqSdk2 连接资管平台功能<a class="headerlink" href="#tqjees" title="Permalink to this headline">¶</a></h3>
<p>TqSdk2 提供了资管平台的对接支持，支持用户连接到指定资管平台</p>
<p>以连接杰宜斯的模拟服务器为例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk2</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqJees</span>

<span class="n">acc</span> <span class="o">=</span> <span class="n">TqJees</span><span class="p">(</span><span class="n">td_url</span><span class="o">=</span><span class="s2">&quot;tcp://129.211.138.170:10001&quot;</span><span class="p">,</span> <span class="n">broker_id</span><span class="o">=</span><span class="s2">&quot;JeesDemo&quot;</span><span class="p">,</span> <span class="n">app_id</span><span class="o">=</span><span class="s2">&quot;shinny_tqsdk_01&quot;</span><span class="p">,</span> <span class="n">auth_code</span><span class="o">=</span> <span class="s2">&quot;0000000000000000&quot;</span><span class="p">,</span> <span class="n">user_name</span><span class="o">=</span><span class="s2">&quot;杰宜斯模拟账户&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;杰宜斯模拟账户密码&quot;</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span><span class="n">auth</span><span class="o">=</span> <span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span><span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>其中杰宜斯的 <strong>模拟账户</strong> 和 <strong>模拟账户密码</strong> 需要自行和杰宜斯联系获取，其他参数在杰宜斯模拟下为</p>
<p>td_url=&quot;<a class="reference external" href="tcp://39.101.174.218:40205">tcp://39.101.174.218:40205</a>&quot;</p>
<p>broker_id=&quot;JeesDemo&quot;</p>
<p>app_id=&quot;shinny_tqsdk_01&quot;</p>
<p>auth_code=&quot;0000000000000000&quot;</p>
<p>杰宜斯实盘情况下将对应信息换成实盘信息即可</p>
<p>资管平台连接模式的详细介绍，请点击 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqJees</span></code> .</p>
</section>
<section id="tqrohon">
<span id="id5"></span><h3>TqSdk2 连接资管平台功能<a class="headerlink" href="#tqrohon" title="Permalink to this headline">¶</a></h3>
<p>TqSdk2 提供了资管平台的对接支持，支持用户连接到指定资管平台</p>
<p>以连接融航的模拟服务器为例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqsdk2</span> <span class="kn">import</span> <span class="n">TqApi</span><span class="p">,</span> <span class="n">TqAuth</span><span class="p">,</span> <span class="n">TqRohon</span>

<span class="n">acc</span> <span class="o">=</span> <span class="n">TqRohon</span><span class="p">(</span><span class="n">td_url</span><span class="o">=</span><span class="s2">&quot;tcp://129.211.138.170:10001&quot;</span><span class="p">,</span> <span class="n">broker_id</span><span class="o">=</span><span class="s2">&quot;RohonDemo&quot;</span><span class="p">,</span> <span class="n">app_id</span><span class="o">=</span><span class="s2">&quot;shinny_tqsdk_01&quot;</span><span class="p">,</span> <span class="n">auth_code</span><span class="o">=</span> <span class="s2">&quot;qZWmA7iTXaEO2w40&quot;</span><span class="p">,</span> <span class="n">user_name</span><span class="o">=</span><span class="s2">&quot;融航模拟账户&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;融航模拟账户密码&quot;</span><span class="p">)</span>
<span class="n">api</span> <span class="o">=</span> <span class="n">TqApi</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span><span class="n">auth</span><span class="o">=</span> <span class="n">TqAuth</span><span class="p">(</span><span class="s2">&quot;快期账户&quot;</span><span class="p">,</span><span class="s2">&quot;账户密码&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>其中融航模拟的 <strong>模拟账户</strong> 和 <strong>模拟账户密码</strong> 需要自行和融航联系获取，其他参数在融航模拟下为</p>
<p>td_url=&quot;<a class="reference external" href="tcp://129.211.138.170:10001">tcp://129.211.138.170:10001</a>&quot;</p>
<p>broker_id=&quot;RohonDemo&quot;</p>
<p>app_id=&quot;shinny_tqsdk_01&quot;</p>
<p>auth_code=&quot;qZWmA7iTXaEO2w40&quot;</p>
<p>融航实盘情况下将对应信息换成实盘信息即可</p>
<p>资管平台连接模式的详细介绍，请点击 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqRohon</span></code> .</p>
</section>
</section>
<span id="document-qa"></span><section id="id1">
<h2>天勤用户论坛<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>在学习TqSdk的过程中可能会碰到一些疑惑，我们相信用户论坛能够帮助到你。</p>
<p>在用户论坛中你可以：</p>
<ul class="simple">
<li><p>根据关键词搜索已解决问题</p></li>
<li><p>查看热门问题及其解决方案</p></li>
<li><p>提出待解决的新问题</p></li>
<li><p>回答/讨论他人提出的问题</p></li>
</ul>
<p>点击进入 <a class="reference external" href="https://forum.shinnytech.com/">用户论坛</a> ，加入讨论.</p>
<figure class="align-default">
<img alt="_images/qa_pic.png" src="_images/qa_pic.png" />
</figure>
</section>
<span id="document-version"></span><section id="version">
<span id="id1"></span><h2>版本变更<a class="headerlink" href="#version" title="Permalink to this headline">¶</a></h2>
<p>3.4.10 (2023/09/22)</p>
<ul class="simple">
<li><p>修复：pandas 2.1.0 版本 fillna 、NumericBlock 会报 deprecated warning 的问题</p></li>
<li><p>优化：磁盘空间剩余小于10G，默认不写入日志</p></li>
</ul>
<p>3.4.9 (2023/09/15)</p>
<ul class="simple">
<li><p>修复：回测时 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqSim</span></code> 可能出现 volume_short_today 为负数的问题</p></li>
</ul>
<p>3.4.8 (2023/09/07)</p>
<ul class="simple">
<li><p>修复：修正多个 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqKq</span></code> 快期模拟和辅模拟账户 account_key 重复的问题</p></li>
</ul>
<p>3.4.7 (2023/08/29)</p>
<ul class="simple">
<li><p>修复：<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 及 <code class="xref py py-class docutils literal notranslate"><span class="pre">twap</span></code> 添加纯碱期货 2309 合约及 2310 合约暂不支持的提示</p></li>
<li><p>docs：完善 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqKq</span></code> 快期模拟辅模拟账户使用说明</p></li>
</ul>
<p>3.4.6 (2023/08/11)</p>
<ul class="simple">
<li><p>增加：支持同时使用多个快期模拟账户，<code class="xref py py-class docutils literal notranslate"><span class="pre">TqKq</span></code>、<code class="xref py py-class docutils literal notranslate"><span class="pre">TqKqStock</span></code> 加入多帐号支持</p></li>
<li><p>修复：回测后 trade_log 中持仓信息增加 pos_long、pos_short、pos 字段</p></li>
<li><p>优化：TqApi 初始化时账户相关参数的提示信息</p></li>
</ul>
<p>3.4.5 (2023/07/17)</p>
<ul class="simple">
<li><p>修复：<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 及 <code class="xref py py-class docutils literal notranslate"><span class="pre">twap</span></code> 支持红枣期货下单</p></li>
</ul>
<p>3.4.4 (2023/07/12)</p>
<ul class="simple">
<li><p>修复: 升级 numpy 后，tafunc.barlast 报错的问题</p></li>
</ul>
<p>3.4.3 (2023/07/06)</p>
<ul class="simple">
<li><p>增加: 支持获取 CSI 指数行情</p></li>
</ul>
<p>3.4.2 (2023/05/17)</p>
<ul class="simple">
<li><p>api：某些 pandas 版本下，web_gui 不更新绘制序列</p></li>
<li><p>docs：修改论坛地址，增加支持杰宜斯的说明</p></li>
</ul>
<p>3.4.1 (2023/04/24)</p>
<ul class="simple">
<li><p>修复: 回测时，部分情况下 expired 字段错误</p></li>
</ul>
<p>3.4.0 (2023/04/13)</p>
<ul class="simple">
<li><p>增加：支持国密连接，可以在 <code class="xref py py-meth docutils literal notranslate"><span class="pre">TqAccount()</span></code> 构造时指定 sm 参数为 True 来启用.
当启用国密时仅支持: win7 或以上, ubuntu 22.04 或以上, debian 12 或以上</p></li>
</ul>
<p>3.3.0 (2022/11/22)</p>
<ul class="simple">
<li><p>增加：支持广州期货交易所 GFEX，如果用户需要交易广期所合约需要升级到此版本以上</p></li>
</ul>
<p>3.2.12 (2022/10/20)</p>
<ul class="simple">
<li><p>优化: <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_all_level_finance_options()</span></code> 增加 ETF 期权标的，文档补充完整 ETF 基金名称</p></li>
<li><p>docs：修正文档，添加上交所和深交所中证1000ETF和深交所创业板ETF代码示例</p></li>
</ul>
<p>3.2.11 (2022/07/27)</p>
<ul class="simple">
<li><p>增加：下载数据时 csv_file_name 参数支持 str / asyncio.StreamWriter 两种类型</p></li>
<li><p>修复：vwap_table 手数计算错误的问题</p></li>
</ul>
<p>3.2.10 (2022/07/20)</p>
<ul class="simple">
<li><p>增加：增加中证 1000 指数，免费用户可获取该指数行情，参考文档 <a class="reference internal" href="index.html#mddatas"><span class="std std-ref">合约, 行情和历史数据</span></a></p></li>
<li><p>修复：回测中没有正常更新 quotes 下的 expire_rest_days 字段的问题</p></li>
<li><p>修复：回测 web_gui 图表没有显示成交标注、持仓线的问题</p></li>
</ul>
<p>3.2.9 (2022/07/07)</p>
<ul class="simple">
<li><p>增加：下载 tick 数据时增加 average 列</p></li>
<li><p>增加：<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tick_data_series()</span></code> 接口返回值中增加 average 列</p></li>
<li><p>优化：下载数据时优化 cpu 占用</p></li>
<li><p>优化：tqsdk 内部各个模块使用统一的时间处理函数</p></li>
<li><p>修复：<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 及 <code class="xref py py-class docutils literal notranslate"><span class="pre">twap</span></code> 增加添加普麦、早籼稻、粳稻及晚籼稻期货暂不支持的提示</p></li>
<li><p>修复：<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_symbol_ranking()</span></code> 接口某些情况可能报错的问题</p></li>
</ul>
<p>3.2.8 (2022/04/29)</p>
<ul class="simple">
<li><p>修复：下载多合约 klines 时数据可能未完全收全的问题</p></li>
<li><p>修复：支持多进程下使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_data_series()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tick_data_series()</span></code> 接口</p></li>
</ul>
<p>3.2.7 (2022/04/22)</p>
<ul class="simple">
<li><p>优化：对多线程用例，增加可能的错误提示</p></li>
<li><p>优化：TqApi 的 debug 默认值修改为 None，且 debug 为 None 情况下在磁盘剩余空间大于 3G 时才可能开启日志</p></li>
<li><p>docs：增加 ETF 期权本地计算卖方保证金示例 o74，完善 targetpostask 的示例文档，完善 Position 下 orders 定义，统一修正文档大小写、变量命名等</p></li>
</ul>
<p>3.2.6 (2022/03/09)</p>
<ul class="simple">
<li><p>修复：修正深交所 ETF 期权的昨结算（pre_settlement）字段未正确显示的问题</p></li>
</ul>
<p>3.2.5 (2022/03/09)</p>
<ul class="simple">
<li><p>修复：修正上交所 ETF 期权的昨结算（pre_settlement）字段未正确显示的问题</p></li>
<li><p>修复：<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 及 <code class="xref py py-class docutils literal notranslate"><span class="pre">twap</span></code> 添加强麦期货暂不支持的提示</p></li>
<li><p>修复：api.insert_order 没有检查 advanced 参数</p></li>
</ul>
<p>3.2.4 (2022/03/07)</p>
<ul class="simple">
<li><p>优化：某些情况下启用 web_gui 后网页卡顿的问题</p></li>
<li><p>修复：修正上交所 ETF 期权的昨结算（pre_settlement）字段</p></li>
<li><p>修复：<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 及 <code class="xref py py-class docutils literal notranslate"><span class="pre">twap</span></code> 添加动力煤期货暂不支持的提示</p></li>
<li><p>docs：修正文档，增加 tqkq() 的示例，增加 <a class="reference internal" href="index.html#tqsdk2ctptest"><span class="std std-ref">在 TqSdk 中调用 TqSdk2 查询保证金</span></a> 文档</p></li>
</ul>
<p>3.2.3 (2022/02/16)</p>
<ul class="simple">
<li><p>修复：query_all_level_options 接口查询 ETF 期权可能报错的问题</p></li>
<li><p>修复：提升程序在连续订阅 K 线时的运行速度</p></li>
<li><p>修复：使用快期模拟账户交易，在断线重连后程序可能报错的问题</p></li>
<li><p>docs：修正文档</p></li>
</ul>
<p>3.2.2 (2022/01/26)</p>
<ul class="simple">
<li><p>增加：支持在回测中使用本地风控模块</p></li>
<li><p>优化：规范化测试脚本，能尽早发现由于依赖库版本升级，而导致部分代码写法不兼容的错误</p></li>
<li><p>docs：修正文档字体显示格式，增加股票回测文档 <a class="reference internal" href="index.html#security-backtest"><span class="std std-ref">对股票合约进行回测</span></a></p></li>
</ul>
<p>3.2.1 (2022/01/11)</p>
<ul class="simple">
<li><p>优化：打印通知时，显示期货账户，改善多账户下用户使用体验</p></li>
<li><p>优化：<strong>免费用户</strong> 每日回测 3 次，支持其回测时交易股票；<strong>专业版用户</strong> 回测次数及交易品种不受限制，专业版购买网址：<a class="reference external" href="https://account.shinnytech.com">https://account.shinnytech.com</a>。</p></li>
<li><p>修复：linux 下使用多进程时，报单号可能重复的问题</p></li>
<li><p>docs：修改交易相关的 get 系列函数文档及示例代码</p></li>
<li><p><strong>TqSdk 计划在 20220601 之后放弃支持 Python 3.6 版本，请尽快升级 Python 版本。</strong> 建议升级到 3.8 及以上，以保证所有依赖库都可以使用最新版。</p></li>
</ul>
<p>3.2.0 (2021/12/31)</p>
<ul class="simple">
<li><p>新增：<code class="xref py py-class docutils literal notranslate"><span class="pre">TqSimStock</span></code> 类实现本地股票模拟交易，同时支持在实盘/回测模式下使用。
<strong>专业版用户</strong> 可用，专业版购买网址：<a class="reference external" href="https://account.shinnytech.com">https://account.shinnytech.com</a>。</p></li>
<li><p>web_gui：修复回测时不能正常显示结果报告的问题</p></li>
<li><p>修复：windows 下调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_data_series()</span></code> 时，可能出现缓存文件不允许重复重命的问题</p></li>
</ul>
<p>3.1.1 (2021/12/24)</p>
<ul class="simple">
<li><p>修复：穿管采集文件读取失败</p></li>
</ul>
<p>3.1.0 (2021/12/24)</p>
<ul>
<li><p>新增：为各种账户类型增加接口调用，支持 IDE 更好的提供代码提示。TqSdk 目前支持以下账户类型 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqAccount</span></code>、<code class="xref py py-class docutils literal notranslate"><span class="pre">TqKq</span></code>、
<code class="xref py py-class docutils literal notranslate"><span class="pre">TqKqStock</span></code>、<code class="xref py py-class docutils literal notranslate"><span class="pre">TqSim</span></code>，本次重构为以上账户类型分别添加了 <code class="docutils literal notranslate"><span class="pre">get_account</span></code>、<code class="docutils literal notranslate"><span class="pre">get_position</span></code>、<code class="docutils literal notranslate"><span class="pre">get_order</span></code>、<code class="docutils literal notranslate"><span class="pre">get_trade</span></code> 几个接口，明确了其返回值的类型。</p>
<p>例如：<code class="xref py py-class docutils literal notranslate"><span class="pre">TqKq</span></code> 实例调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_account()</span></code> ，返回 <code class="xref py py-class docutils literal notranslate"><span class="pre">Account</span></code> 类型实例；</p>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">TqKqStock</span></code> 实例调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_account()</span></code> ，返回 <code class="xref py py-class docutils literal notranslate"><span class="pre">SecurityAccount</span></code> 类型实例。</p>
</li>
<li><p>修复：<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 及 <code class="xref py py-class docutils literal notranslate"><span class="pre">twap</span></code> 增加添加红枣期货暂不支持的提示</p></li>
<li><p>docs：更新开盘抢单示例代码</p></li>
</ul>
<p>3.0.3 (2021/12/10)</p>
<ul class="simple">
<li><p>修复：从服务器更新节假日表，修复 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_trading_calendar()</span></code> 接口文档及报错信息</p></li>
</ul>
<p>3.0.2 (2021/12/07)</p>
<ul class="simple">
<li><p>修复：调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code> 接口获取股票前复权 Kline 时，复权计算结果可能出错的问题</p></li>
<li><p>新增：节假日表添加 2022 年节假日信息</p></li>
<li><p>新增：支持在 python 3.10 下使用 TqApi</p></li>
<li><p>web_gui：支持多账户下使用</p></li>
<li><p>docs：更新示例合约代码</p></li>
</ul>
<p>3.0.1 (2021/11/26)</p>
<ul class="simple">
<li><p>修复：调用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_symbol_info()</span></code>，当参数中包含主连/指数合约会报错的问题</p></li>
<li><p>修复：在某些情况下，回测时获取期权及标的合约的多合约 Kline 可能报错的问题</p></li>
<li><p>修复：回测时取主连合约，如果用 <code class="docutils literal notranslate"><span class="pre">quote.underlying_quote</span></code> 直接读取标的合约，在标的合约变更时，可能未重新订阅行情的问题</p></li>
<li><p>优化：取消网络连接关闭时屏幕输出，改为存入日志文件</p></li>
<li><p>docs：完善 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_account()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_position()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_order()</span></code>、
<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_trade()</span></code> 函数返回值类型文档说明，完善专业版 <a class="reference internal" href="index.html#profession-tqkqstock"><span class="std std-ref">股票模拟交易</span></a> 文档，完善 <a class="reference internal" href="index.html#tqrohon"><span class="std std-ref">TqSdk2 连接资管平台功能</span></a> 融航接入文档</p></li>
</ul>
<p>3.0.0 (2021/11/12)</p>
<ul class="simple">
<li><p>增加：<code class="xref py py-class docutils literal notranslate"><span class="pre">TqKqStock</span></code> <strong>快期股票模拟</strong> 账户类型，支持股票模拟交易。<strong>专业版用户</strong> 可用，专业版购买网址：<a class="reference external" href="https://account.shinnytech.com">https://account.shinnytech.com</a>。</p></li>
<li><p>增加：<code class="xref py py-class docutils literal notranslate"><span class="pre">TqRuleAccOpenVolumesLimit</span></code> 类，日内累计开仓手数限制</p></li>
<li><p>优化：使用 sgqlc 库生成合约服务的 graphql 查询</p></li>
</ul>
<p>2.9.4 (2021/11/04)</p>
<ul class="simple">
<li><p>增加：<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_symbol_info()</span></code> 接口返回值中增加 <code class="docutils literal notranslate"><span class="pre">upper_limit</span></code>, <code class="docutils literal notranslate"><span class="pre">lower_limit</span></code> 这两个字段</p></li>
<li><p>优化: 多账户模式支持回测模块</p></li>
<li><p>优化: query 系列函数，发送的查询请求中合约列表长度不能大于 8192</p></li>
<li><p>优化: 网络连接优化断线重连机制</p></li>
</ul>
<p>2.9.3 (2021/10/28)</p>
<ul class="simple">
<li><p>增加：<code class="xref py py-class docutils literal notranslate"><span class="pre">TqRuleOpenCountsLimit</span></code>、<code class="xref py py-class docutils literal notranslate"><span class="pre">TqRuleOpenVolumesLimit</span></code> 类，
以及 <code class="xref py py-meth docutils literal notranslate"><span class="pre">add_risk_rule()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">delete_risk_rule()</span></code> 接口，支持本地风控功能</p></li>
<li><p>增加：<code class="xref py py-class docutils literal notranslate"><span class="pre">TqRiskRuleError</span></code> 错误类型，可以捕获风控触发的错误</p></li>
</ul>
<p>2.9.2 (2021/10/20)</p>
<ul class="simple">
<li><p>修复：实盘账户无法使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_trading_status()</span></code> 接口的问题</p></li>
<li><p>docs：完善专业版文档</p></li>
</ul>
<p>2.9.1 (2021/10/19)</p>
<ul class="simple">
<li><p>增加：<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_trading_status()</span></code> 接口，支持开盘抢单功能</p></li>
<li><p>增加：<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_symbol_info()</span></code> 接口返回值中增加 <code class="docutils literal notranslate"><span class="pre">product_id</span></code>, <code class="docutils literal notranslate"><span class="pre">expire_rest_days</span></code>, <code class="docutils literal notranslate"><span class="pre">trading_time_day</span></code>, <code class="docutils literal notranslate"><span class="pre">trading_time_night</span></code> 几个字段</p></li>
<li><p>优化：TqSim 回测报告增加部分字段，和 web_gui 显示回测报告一致</p></li>
<li><p>优化：<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_data_series()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tick_data_series()</span></code> 接口报错</p></li>
</ul>
<p>2.9.0 (2021/09/29)</p>
<ul class="simple">
<li><p>增加：<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_symbol_info()</span></code> 接口返回值中增加 <code class="docutils literal notranslate"><span class="pre">pre_open_interest</span></code>, <code class="docutils literal notranslate"><span class="pre">pre_settlement</span></code>, <code class="docutils literal notranslate"><span class="pre">pre_close</span></code> 这三个字段</p></li>
<li><p>优化：重构网络连接，增加多账户测试用例</p></li>
<li><p>优化：简化回测结束后用户依然需要查看 web_gui 时的代码，详情参考 <a class="reference internal" href="index.html#backtest-with-web-gui"><span class="std std-ref">回测结束在浏览器中查看绘图结果</span></a></p></li>
<li><p>优化：网络连接失败时，优化对用户的提示信息</p></li>
<li><p>优化：实盘账户实盘不支持主连和指数交易，提前抛错提示用户</p></li>
<li><p>docs：更新文档，专业版承诺提供A股股票行情</p></li>
</ul>
<p>2.8.6 (2021/09/16)</p>
<ul class="simple">
<li><p>增加：TqApi 增加 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_his_cont_quotes()</span></code> 接口，可以获取过去 n 个交易日的历史主连信息</p></li>
<li><p>增加：通知模块 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqNotify</span></code>，帮助用户收集通知信息并做定制化处理</p></li>
<li><p>docs：完善风控文档，增加专业版权限函数说明</p></li>
</ul>
<p>2.8.5 (2021/09/06)</p>
<ul class="simple">
<li><p>增加：TqApi 增加 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_symbol_ranking()</span></code> 接口，支持查询合约成交排名/持仓排名。</p></li>
<li><p>增加：TqApi 增加 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_option_greeks()</span></code> 接口，返回指定期权的希腊指标。</p></li>
<li><p>修复：pyinstaller 工具由于缺少初始合约文件导致打包失败</p></li>
<li><p>优化：<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_delta()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_theta()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_rho()</span></code>、
<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_bs_price()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_impv()</span></code> 接口中 <code class="docutils literal notranslate"><span class="pre">option_class</span></code> 参数支持类型扩展为
<code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">或者</span> <span class="pre">pandas.Series</span></code>，详情见文档</p></li>
</ul>
<p>2.8.4 (2021/08/31)</p>
<ul class="simple">
<li><p>修复：由于缺少初始合约文件，TqApi 初始化可能失败的问题</p></li>
</ul>
<p>2.8.3 (2021/08/30)</p>
<ul class="simple">
<li><p>增加：is_changing 接口增加对于委托单 <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_dead()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">is_online()</span></code>、
<code class="xref py py-meth docutils literal notranslate"><span class="pre">is_error()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">trade_price()</span></code> 字段支持判断是否更新</p></li>
<li><p>修复：TqApi 初始化可能失败的问题</p></li>
<li><p>优化：将已知下市合约直接打包在代码中，缩短 TqApi 初始化时间</p></li>
<li><p>docs：完善主力切换规则说明，将阿里源替换为清华源</p></li>
</ul>
<p>2.8.2 (2021/08/17)</p>
<ul class="simple">
<li><p>增加：is_changing 接口增加对于合约 <code class="xref py py-meth docutils literal notranslate"><span class="pre">expire_rest_days()</span></code>，持仓 <code class="xref py py-meth docutils literal notranslate"><span class="pre">pos_long()</span></code>、
<code class="xref py py-meth docutils literal notranslate"><span class="pre">pos_short()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">pos()</span></code> 字段支持判断是否更新</p></li>
<li><p>修复：2.8.1 版本重构后，不支持多线程运行的问题</p></li>
<li><p>docs：更新合约字段示例说明</p></li>
</ul>
<p>2.8.1 (2021/08/12)</p>
<ul class="simple">
<li><p>增加：增强在协程中的支持，以下接口 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_quotes()</span></code>，<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_cont_quotes()</span></code>，
<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_options()</span></code>，<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_atm_options()</span></code>，
<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_symbol_info()</span></code>，<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_all_level_options()</span></code>，
<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_all_level_finance_options()</span></code>，支持协程中
<code class="docutils literal notranslate"><span class="pre">in_options,</span> <span class="pre">at_options,</span> <span class="pre">out_options</span> <span class="pre">=</span> <span class="pre">await</span> <span class="pre">api.query_all_level_finance_options(&quot;SSE.510300&quot;,</span> <span class="pre">4.60,</span> <span class="pre">&quot;CALL&quot;,</span> <span class="pre">nearbys</span> <span class="pre">=</span> <span class="pre">1)</span></code> 写法，参考文档：<a class="reference internal" href="index.html#multi-async-task"><span class="std std-ref">单线程创建多个异步任务</span></a></p></li>
<li><p>修复：target_pos_task 优化报错提示，已经结束的 TargetPosTask 实例再调用 set_target_volume 设置手数会报错。参考文档：<code class="xref py py-meth docutils literal notranslate"><span class="pre">cancel()</span></code></p></li>
<li><p>修复：下载历史数据时，某些数据未按照最小价格变动单位保留相应小数位数的问题</p></li>
<li><p>重构：优化 wait_update、is_changing 接口的实现，增强对协程的支持</p></li>
<li><p>docs：完善回测字段规则文档说明</p></li>
</ul>
<p>2.8.0 (2021/08/05)</p>
<ul class="simple">
<li><p>增加：<strong>支持免费用户每日回测 3 次</strong></p></li>
</ul>
<p>2.7.2 (2021/07/30)</p>
<ul class="simple">
<li><p>增加：<strong>支持在回测中使用 query 系列函数，查询结果为回测当天的合约信息</strong></p></li>
<li><p>增加：Quote 对象增加 underlying_quote 属性，值是一个 Quote 对象（为 underlying_symbol 属性对应的合约引用）或者是 None</p></li>
<li><p>web_gui：修复在 safari 和 firefox 无法正常显示的问题</p></li>
<li><p>docs：完善支持用户自助购买文档</p></li>
</ul>
<p>2.7.1 (2021/07/21)</p>
<ul class="simple">
<li><p>修复：query 系列查询看跌期权时，未返回指定的实值、平值、虚值序列的问题</p></li>
<li><p>docs：完善 position 文档说明</p></li>
<li><p>docs：补充期权示例</p></li>
</ul>
<p>2.7.0 (2021/07/15)</p>
<ul class="simple">
<li><p>增加：<strong>去除 Cython 编译，本地代码全部开源</strong></p></li>
<li><p>增加：<strong>支持 ARM 架构下 CPU 的安装使用</strong></p></li>
<li><p>增加：TqApi 增加 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_all_level_finance_options()</span></code> 接口，支持查询指定当月、下月、季月等到期月份的金融期权。</p></li>
<li><p>增加：支持上期能源下载 ticks 5 档行情</p></li>
<li><p>修复：某些参数可能造成 twap 无法执行的问题</p></li>
<li><p>修复：客户端发送的 variables 中变量值不支持空字符串、空列表或者列表中包括空字符串</p></li>
<li><p>删除：为期权持仓、成交、委托单对象添加部分期权合约信息的功能（2.6.5 增加功能）</p></li>
<li><p>doc：添加隔夜开盘抢单示例，不再建议用户自定义次席连接</p></li>
</ul>
<p>2.6.6 (2021/07/05)</p>
<ul class="simple">
<li><p>修复：支持 pandas 1.3.0 版本</p></li>
<li><p>修复：回测中某些有夜盘的合约，报夜盘时间不在可交易时间段的问题</p></li>
<li><p>web_gui：成交列表中成交价格默认显示4位小数</p></li>
<li><p>doc：完善钉钉推送文档</p></li>
</ul>
<p>2.6.5 (2021/06/30)</p>
<ul class="simple">
<li><p>增加：为期权持仓、成交、委托单对象添加部分期权合约信息，方便用户查看</p></li>
<li><p>增加：回测时，Quote 对象支持读取 expired 值</p></li>
<li><p>修复：TargetPosScheduler 最后一项等到目标持仓完成退出，最后一项设置的超时时间无效</p></li>
<li><p>修复：回测时如果先订阅日线，可能出现无法成交的问题</p></li>
<li><p>doc：完善期权文档、增加 <a class="reference internal" href="index.html#enterprise"><span class="std std-ref">TqSdk2 企业版</span></a> 文档说明</p></li>
</ul>
<p>2.6.4 (2021/06/23)</p>
<ul class="simple">
<li><p>增加：<code class="xref py py-class docutils literal notranslate"><span class="pre">Quote</span></code> 增加 <code class="xref py py-class docutils literal notranslate"><span class="pre">expire_rest_days</span></code> 属性，表示距离到期日天数</p></li>
<li><p>增加：TqApi 增加 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_symbol_info()</span></code> 接口，支持批量查询合约信息</p></li>
<li><p>增加：TqApi 增加 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_all_level_options()</span></code> 接口，返回标的对应的全部的实值、平值、虚值期权</p></li>
<li><p>增加：TqApi 中 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_atm_options()</span></code> 接口，扩大参数 price_level 支持范围</p></li>
<li><p>增加：sim.tqsdk_stat 增加总手续费字段</p></li>
<li><p>修复：回测中某些有夜盘的合约，报夜盘时间不在可交易时间段的问题</p></li>
<li><p>修复：回测报告中，在有期权交易时，每日收益值有错误</p></li>
<li><p>修复：回测中限制 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_quote_list()</span></code> 参数列表长度，最多支持 100 合约</p></li>
<li><p>web_gui：修复部分成交记录箭头标注位置不对的问题</p></li>
<li><p>web_gui：修复报告页面日期没有显示的问题</p></li>
<li><p>web_gui：支持代码运行中可以修改指标颜色</p></li>
<li><p>web_gui：成交列表中，部分成交价格没有按照最小变动价格保留小数位数的问题</p></li>
<li><p>doc：完善期权文档</p></li>
<li><p>doc：完善回测文档</p></li>
</ul>
<p>2.6.3 (2021/06/11)</p>
<ul class="simple">
<li><p>修复：twap 策略某些参数组合无法执行的问题，修改后生成随机手数可能最后一笔的下单手数小于设置的最小手数</p></li>
<li><p>修复：TqSim 模拟交易期权时，某些情况下标的行情不更新的问题</p></li>
<li><p>完善文档：增加指数、主连行情、期权使用文档说明</p></li>
<li><p>web_gui：增加回测报告图表页面（增加每日资金、每日盈亏、滚动夏普比率、滚动索提诺比率图表）</p></li>
<li><p>web_gui：指标线可以绘制虚线</p></li>
</ul>
<p>2.6.2 (2021/06/03)</p>
<ul class="simple">
<li><p>修复：在回测某些时间段时，指数无法交易的问题</p></li>
<li><p>重构：TqSim 回测统计函数重构，增加 sortino_ratio 索提诺比率指标</p></li>
<li><p>重构：算法模块中产生随机序列的方法</p></li>
<li><p>优化：target_pos_task 报错提示文字</p></li>
<li><p>优化：网络链接建立、断连时的报错提示文字</p></li>
<li><p>优化：单线程创建多个异步任务文档完善，参考文档：<a class="reference internal" href="index.html#multi-async-task"><span class="std std-ref">单线程创建多个异步任务</span></a></p></li>
<li><p>web_gui：修复成交量图在高分屏下高度错误的问题</p></li>
<li><p>web_gui：k线文字标注为开高低收</p></li>
<li><p>web_gui：图表不显示 BoardId</p></li>
</ul>
<p>2.6.1 (2021/05/27)</p>
<ul class="simple">
<li><p>增加：增强在协程中的支持，以下接口 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_quote()</span></code>，<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_quote_list()</span></code>，
<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code>，<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tick_serial()</span></code> 支持协程中
<code class="docutils literal notranslate"><span class="pre">quote</span> <span class="pre">=</span> <span class="pre">await</span> <span class="pre">api.get_quote('SHFE.cu2106')</span></code> 写法，参考文档：<a class="reference internal" href="index.html#multi-async-task"><span class="std std-ref">单线程创建多个异步任务</span></a></p></li>
<li><p>增加：<code class="xref py py-meth docutils literal notranslate"><span class="pre">vwap_table()</span></code> 的示例代码，参考链接 <a class="reference internal" href="index.html#demo-algorithm-vwap"><span class="std std-ref">vwap_table - 交易量平均加权算法</span></a></p></li>
<li><p>优化：<code class="xref py py-meth docutils literal notranslate"><span class="pre">twap_table()</span></code> 的示例代码，参考链接 <a class="reference internal" href="index.html#demo-algorithm-twap"><span class="std std-ref">twap_table - 时间平均加权算法</span></a></p></li>
<li><p>优化：在网络链接开始尝试重连时，增加通知和日志</p></li>
<li><p>修复：多次创建同合约 TargetPosTask 实例，可能抛错的问题</p></li>
<li><p>完善文档：补充期权示例文档</p></li>
</ul>
<p>2.6.0 (2021/05/20)</p>
<ul class="simple">
<li><p>增加：<code class="docutils literal notranslate"><span class="pre">tqsdk.algorithm</span></code> 模块提供 <code class="xref py py-meth docutils literal notranslate"><span class="pre">vwap_table()</span></code> 帮助用户完成 vwap 算法下单。</p></li>
<li><p>增加：<code class="xref py py-class docutils literal notranslate"><span class="pre">TqTimeoutError</span></code> 错误类型，方便用于捕获此错误</p></li>
<li><p>增加：<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 实例提供 <code class="xref py py-meth docutils literal notranslate"><span class="pre">cancel()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">is_finished()</span></code> 方法</p></li>
<li><p>修复：在异步代码中调用 get_quote 函数时，可能遇到 Task 未被引用而引发的错误</p></li>
<li><p>修复：Windows 中下载数据时，文件已经被占用而无法继续下载时，TqSdk 没有正常退出的错误</p></li>
<li><p>优化：针对初始化时的可能出现超时退出的问题，增加错误收集和提示</p></li>
</ul>
<p>2.5.1 (2021/05/13)</p>
<ul class="simple">
<li><p>增加：负责策略执行工具 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosScheduler</span></code>，帮助用户完成复杂的下单策略，同时提供给用户极大的调整空间。文档参考 <a class="reference internal" href="index.html#target-pos-scheduler"><span class="std std-ref">基于时间维度目标持仓策略</span></a></p></li>
<li><p>增加：TqSim 支持用户设置期权手续费</p></li>
<li><p>修复：协程中调用 get_quote 可能超时的问题</p></li>
<li><p>修复：首次登录期货账户可能会抛错的问题</p></li>
<li><p>优化：修改文档，增加测试脚本日志输出</p></li>
</ul>
<p>2.5.0 (2021/04/27)</p>
<ul class="simple">
<li><p>增加：<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_quote_list()</span></code> 接口，支持批量订阅合约。注意其参数和返回值都是 list 类型。</p></li>
<li><p>增加：版本通知功能，后续版本升级将在 TqSdk 版本大于等于 2.5.0 以上版本做通知</p></li>
<li><p>优化：TqApi 初始化逻辑，减少了一大半 TqApi 初始化时间</p></li>
</ul>
<p>2.4.1 (2021/04/16)</p>
<ul class="simple">
<li><p>增加：TqSim 支持 BEST / FIVELEVEL 市价单</p></li>
<li><p>修复：回测情况下可能遇到单个合约行情回退的问题</p></li>
<li><p>修复：get_position 获取持仓添加默认的 exchange_id, instrument_id</p></li>
<li><p>修复：回测时用到多合约 Kline 且其中某个合约在回测区间内下市，可能导致程序崩溃</p></li>
<li><p>重构：合约服务模块独立为一个模块，增加了查询合约服务等待时间，减少了api初始化创建失败的概率</p></li>
<li><p>完善文档</p></li>
</ul>
<p>2.4.0 (2021/03/30)</p>
<ul class="simple">
<li><p>增加：<code class="xref py py-class docutils literal notranslate"><span class="pre">twap</span></code> 增加 trades，average_trade_price 属性，用于获取成交记录和成交均价</p></li>
<li><p>增加：query_cont_quotes 接口增加 has_night 参数，详情参考 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_cont_quotes()</span></code></p></li>
<li><p>增加：<strong>支持用户回测中设置 TqSim 的保证金和手续费</strong>，详情参考 <code class="xref py py-meth docutils literal notranslate"><span class="pre">set_margin()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">set_commission()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_margin()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_commission()</span></code></p></li>
<li><p>增加：<strong>支持用户回测中使用 quote.underlying_symbol 获取主连对应的主力合约</strong>，详情参考 <a class="reference internal" href="index.html#backtest-underlying-symbol"><span class="std std-ref">回测时获取主连合约标的</span></a></p></li>
<li><p>修复：回测时大于日线周期的 K 线的收盘时间错误</p></li>
</ul>
<p>2.3.5 (2021/03/19)</p>
<ul class="simple">
<li><p>增加：<code class="xref py py-class docutils literal notranslate"><span class="pre">twap</span></code> 支持在多账户下使用</p></li>
<li><p>重构： TqSim 模拟交易模块，修复了 TqSim 模拟交易期权时部分字段计算错误的问题，增加测试用例覆盖，提高 TqSim 模块准确性</p></li>
<li><p>修复：<code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 能支持多账户下使用</p></li>
<li><p>修复：之前版本下载无任何成交的合约会显示在 0% 卡住或退出程序，修改为超时（30s）之后跳过该无成交合约下载后续合约</p></li>
<li><p>完善文档：增加 TargetPosTask 大单拆分模式用法示例，修改完善期权文档等</p></li>
<li><p>依赖库升级：pandas 版本要求为 &gt;= 1.1.0</p></li>
</ul>
<p>2.3.4 (2021/03/11)</p>
<ul class="simple">
<li><p>增加：<strong>TargetPosTask 增加 min_volume, max_volume 参数，支持大单拆分模式</strong>，详情参考 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code></p></li>
<li><p>重构：TqSim 模拟交易模块，修复了 TqSim 模拟交易时账户、持仓部分资金字段计算错误的 bug</p></li>
<li><p>修复：<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_options()</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_atm_options()</span></code> 接口中 <cite>has_A</cite> 参数不生效的 bug</p></li>
<li><p>修复：在使用 TargetPosTask 时，主动调用 api.close() 程序不能正常退出的错误的 bug</p></li>
<li><p>修复：回测时使用多合约 Kline 可能引起的 bug</p></li>
<li><p>修复：在节假日时回测，由于节假日当日无夜盘而导致部分夜盘品种的交易时间段错误</p></li>
<li><p>修复：web_gui 在切换合约/周期时未更新用户绘图数据的 bug</p></li>
<li><p>修复：web_gui 幅图数据默认保留两位小数显示</p></li>
</ul>
<p>2.3.3 (2021/02/19)</p>
<ul class="simple">
<li><p>修复获取交易日历接口在低版本 pandas 下结果可能出错的问题</p></li>
</ul>
<p>2.3.2 (2021/02/08)</p>
<ul class="simple">
<li><p>增加 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_trading_calendar()</span></code> 接口，支持用户获取交易日历</p></li>
<li><p>增加 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_atm_options()</span></code> 接口，支持用户获取指定档位期权</p></li>
<li><p>修复在回测时订阅当天上市的合约可能出现报错的情况</p></li>
<li><p>修复 web_gui 回测时某些情况下定位不准确的问题</p></li>
<li><p>优化 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_quotes()</span></code> , 支持用户查询交易所的全部主连或指数</p></li>
<li><p>优化 TqSim 交易失败的提示</p></li>
<li><p>优化客户端发送的数据包量，降低流量占用</p></li>
</ul>
<p>2.3.1 (2021/02/01)</p>
<ul class="simple">
<li><p>增加 t96.py macd 绘图示例，详情参考 <a class="reference internal" href="index.html#tutorial-t96"><span class="std std-ref">t96 - 附图中画MACD</span></a></p></li>
<li><p>修复获取大量合约的多合约Kline，有可能等待超时的问题</p></li>
<li><p>web 优化图表，回测时图表跳转到回测时间段</p></li>
<li><p>优化测试用例、文档</p></li>
</ul>
<p>2.3.0 (2021/01/20)</p>
<ul class="simple">
<li><p>股票实盘交易即将上线</p></li>
<li><p>回测增加支持获取多合约 Kline，现在可以在回测中使用期权相关函数</p></li>
<li><p>TqSim 增加属性 tqsdk_stat，提供给用户查看回测交易统计信息，详情参考 <a class="reference internal" href="index.html#backtest"><span class="std std-ref">策略程序回测</span></a></p></li>
<li><p>修复 twap 可能少下单的问题，增加针对 twap 的测试用例</p></li>
</ul>
<p>2.2.6 (2021/01/13)</p>
<ul class="simple">
<li><p>增加接口 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_data_series()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tick_data_series()</span></code>，支持 <strong>专业版用户</strong> 获取一段时间 K 线或 Tick 的用法</p></li>
<li><p>修复 web 需要拖拽才能更新 K 线的问题，支持自动更新 K 线</p></li>
<li><p>修复下载多合约 K 线，列名顺序错误的问题</p></li>
<li><p>修复 web 盘口总手数可能显示错误的问题</p></li>
<li><p>修复 draw_text 设置颜色无效的问题</p></li>
</ul>
<p>2.2.5 (2020/12/29)</p>
<ul class="simple">
<li><p>复权统一命名规范 &quot;F&quot; 表示前复权，&quot;B&quot; 表示后复权，请检查您的代码是否符合规范</p></li>
<li><p>修复下载复权数据时，由于下载时间段无复权信息，可能导致失败的问题</p></li>
<li><p>修复复盘时，下单可能会报错的问题</p></li>
<li><p>修复在 get_kline_serial / get_tick_serial 在 pandas=1.2.0 版本下用法不兼容的问题</p></li>
<li><p>完善期权相关文档</p></li>
</ul>
<p>2.2.4 (2020/12/23)</p>
<ul class="simple">
<li><p>修复新用户第一次安装 TqSdk 可能遇到依赖库 pyJWT 版本不兼容的错误</p></li>
<li><p>修复 web_gui 拖拽不能缩小图表的问题</p></li>
</ul>
<p>2.2.3 (2020/12/22)</p>
<ul class="simple">
<li><p>修复 twap 在退出时由于未等待撤单完成，可能造成重复下单的问题</p></li>
<li><p>修复 twap 未按时间随机，成交后立即退出的问题</p></li>
<li><p>修复在复盘模式下 TqSim 设置初始资金无效</p></li>
<li><p>修复 web 绘制线型无法设置颜色的问题</p></li>
<li><p>修复回测模式下连接老版行情服务器无法运行问题</p></li>
</ul>
<p>2.2.2 (2020/12/17)</p>
<ul class="simple">
<li><p><strong>支持获取复权后 klines/ticks</strong>，详情请参考文档 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tick_serial()</span></code></p></li>
<li><p><strong>支持下载复权后 klines/ticks</strong>，详情请参考文档 <code class="xref py py-class docutils literal notranslate"><span class="pre">DataDownloader</span></code></p></li>
<li><p>Quote 对象增加除权表(stock_dividend_ratio)，除息表(cash_dividend_ratio) 两个字段，详情请参考文档 <code class="xref py py-class docutils literal notranslate"><span class="pre">Quote</span></code></p></li>
<li><p>修复 twap 算法在手数已经成交时状态没有变为已结束的 bug</p></li>
<li><p>修复文档中 reference/tqsdk.ta 页面内不能跳转连接</p></li>
</ul>
<p>2.2.1 (2020/12/14)</p>
<ul class="simple">
<li><p>修复用户使用 pyinstaller 打包文件，不会自动添加穿管认证文件和 web 资源文件的问题</p></li>
</ul>
<p>2.2.0 (2020/12/08)</p>
<ul class="simple">
<li><p><strong>更换 web_gui 绘图引擎，极大改善 web_gui 交互性能</strong></p></li>
<li><p><strong>由于后续行情服务器升级等原因，建议用户 2020/12/31 号前将 tqsdk 升级至 2.0 以上版本</strong></p></li>
<li><p>修复发布包中缺失 demo 文件夹的问题</p></li>
<li><p>修改 lib 示例文档</p></li>
</ul>
<p>2.1.4 (2020/11/26)</p>
<ul class="simple">
<li><p>增加计算波动率曲面函数，详情参考 <code class="xref py py-meth docutils literal notranslate"><span class="pre">VOLATILITY_CURVE()</span></code></p></li>
<li><p><strong>TargetPosTask 支持 price 参数为函数类型</strong>，详情参考 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code></p></li>
<li><p>优化下载数据体验，已下市无数据合约提前退出</p></li>
<li><p>修复在复盘情况下会持续重复发送订阅合约请求的问题，可以改善复盘连接成功率</p></li>
<li><p>修改优化文档</p></li>
</ul>
<p>2.1.3 (2020/11/20)</p>
<ul class="simple">
<li><p>修复 twap 在某些边界条件下无法下单的 bug</p></li>
<li><p>修复 linux 平台下 web_gui 可能因为端口占用无法启动网页</p></li>
<li><p>DataDownloader.get_data_series() 函数使用可能导致内存泄漏，暂时下线修复</p></li>
</ul>
<p>2.1.2 (2020/11/19)</p>
<ul class="simple">
<li><p>下载数据工具支持默认下载 ticks 五档行情</p></li>
<li><p>下载数据工具增加 get_data_series 接口，可以获取 dataframe 格式数据，详情请参考 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_data_series()</span></code></p></li>
<li><p>优化下载数据体验，无数据合约提前退出</p></li>
<li><p>修复 twap 算法可能无法持续下单的 bug</p></li>
<li><p>web_gui 替换新版 logo</p></li>
<li><p>web_gui 支持 K 线图放大显示</p></li>
</ul>
<p>2.1.1 (2020/11/18)</p>
<ul class="simple">
<li><p>增加 psutil 依赖包</p></li>
</ul>
<p>2.1.0 (2020/11/17)</p>
<ul class="simple">
<li><p><strong>增加多账户功能</strong>，详情请参考 <code class="xref py py-class docutils literal notranslate"><span class="pre">multiaccount</span></code></p></li>
<li><p>优化日志模块，明确区分屏幕输出、日志文件中的日志格式，并在 TqApi 中提供参数 <cite>disable_print</cite>，可以禁止 TqApi 在屏幕输出内容，详情请参考 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqApi</span></code></p></li>
<li><p>修复复盘时 web_gui 时间显示错误</p></li>
<li><p>优化测试用例执行流程，支持并行运行测试</p></li>
<li><p>修改、优化优化文档</p></li>
<li><p>Python &gt;=3.6.4, 3.7, 3.8, 3.9 才能支持 TqSdk 2.1.0 及以上版本</p></li>
</ul>
<p>2.0.5 (2020/11/03)</p>
<ul class="simple">
<li><p>优化：Quote 对象增加若干字段：instrument_name、 exercise_year、exercise_month、last_exercise_datetime、exercise_type、public_float_share_quantity，详情请参考文档 <code class="xref py py-class docutils literal notranslate"><span class="pre">Quote</span></code></p></li>
<li><p>修改：query_options 接口参数名调整，兼容之前的用法</p></li>
<li><p>修复：CFFEX.IO 指数回测可能报错的bug</p></li>
<li><p>修复：快期模拟在 web_gui 中优化用户名显示</p></li>
<li><p>修复：未设置过 ETF 期权风控规则的账户首次设置风控规则时可能报错</p></li>
<li><p>优化文档：增加 query 系列函数返回数据类型的注释</p></li>
</ul>
<p>2.0.4 (2020/10/13)</p>
<ul class="simple">
<li><p>增加 Python 支持版本说明(3.6/3.7/3.8)</p></li>
<li><p>修复指数不能正常回测问题</p></li>
<li><p>修复 2020/08/03-2020/09/15 时间内下市合约查询失败的问题</p></li>
</ul>
<p>2.0.3 (2020/09/23)</p>
<ul class="simple">
<li><p>修复 api 对不存在合约名称的错误处理</p></li>
<li><p>增加下载委托单和成交记录的示例 <a class="reference internal" href="index.html#tutorial-downloader-orders"><span class="std std-ref">downloader_orders - 下载委托单和成交记录</span></a></p></li>
<li><p>增加 algorithm 算法模块，增加 <code class="xref py py-class docutils literal notranslate"><span class="pre">twap</span></code> 算法以及对应的 demo 示例 <a class="reference internal" href="index.html#demo-algorithm-twap"><span class="std std-ref">twap_table - 时间平均加权算法</span></a></p></li>
</ul>
<p>2.0.2 (2020/09/18)</p>
<ul class="simple">
<li><p>2020/10/01 以后，免费版用户不再支持回测，下载数据等功能，<a class="reference external" href="https://www.shinnytech.com/tqsdk_professional/">点击了解专业版和免费版区别</a></p></li>
<li><p>修改中证 500 的合约名称为 SSE.000905</p></li>
<li><p>修改 TqAccount 检查参数类型并提示用户</p></li>
</ul>
<p>2.0.1 (2020/09/17)</p>
<ul class="simple">
<li><p>股票行情正式上线，点击查看详情 <a class="reference internal" href="index.html#mddatas"><span class="std std-ref">合约, 行情和历史数据</span></a></p></li>
<li><p>发布 TqSdk 专业版，点击查看详情 <a class="reference internal" href="index.html#profession"><span class="std std-ref">TqSdk 专业版</span></a></p></li>
<li><p>支持 ETF 期权交易，支持的期货公司名单参见 <a class="reference external" href="https://www.shinnytech.com/blog/tq-support-broker/">点击查看详细说明</a></p></li>
<li><p>提供新版合约接口服务 <code class="xref py py-meth docutils literal notranslate"><span class="pre">query_quotes()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_cont_quotes()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">query_options()</span></code>，替代原有 _data 用法，建议尽早换用</p></li>
<li><p>增加设置、读取 ETF 期权风控规则的接口，<code class="xref py py-meth docutils literal notranslate"><span class="pre">set_risk_management_rule()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">get_risk_management_rule()</span></code></p></li>
<li><p>增加 TqAuth 用户认证类，使用 TqApi 时 auth 为必填参数，<code class="xref py py-class docutils literal notranslate"><span class="pre">TqAuth</span></code>，兼容原有 auth 用法。</p></li>
<li><p>增加权限校验，提示用户限制信息</p></li>
<li><p>修改为默认不开启 debug 记录日志</p></li>
<li><p>修复 TqKq 登录失败的问题</p></li>
<li><p>修改、优化文档及测试用例</p></li>
</ul>
<p>1.8.3 (2020/07/29)</p>
<ul class="simple">
<li><p>修复：pandas 的 consolidate 函数调用可能会造成 K 线数据不更新</p></li>
<li><p>修复：api.insert_order 没有检查大商所期权不支持市价单</p></li>
<li><p>优化用户 import pandas 遇到 ImportError 时问题提示</p></li>
<li><p>更新优化文档，增加股票相关示例，更新示例中的期货合约，标注文档中 objs 对象类型说明</p></li>
</ul>
<p>1.8.2 (2020/07/07)</p>
<ul class="simple">
<li><p>增加提供高级委托指令 FAK、FOK，并增加相关文档说明 <a class="reference internal" href="index.html#advanced-order"><span class="std std-ref">高级委托指令</span></a>、示例代码</p></li>
<li><p>本地模拟交易 sim 支持 FAK、FOK 交易指令，快期模拟暂不支持</p></li>
<li><p>优化登录请求流程</p></li>
<li><p>优化测试用例代码，增加关于交易指令的测试用例</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.8.1 (2020/06/19)</p>
<ul class="simple">
<li><p>增加 <code class="xref py py-class docutils literal notranslate"><span class="pre">TqKq</span></code> 账户类型，可以使用统一的快期模拟账户登录，详情点击 <a class="reference internal" href="index.html#sim-trading"><span class="std std-ref">模拟交易和论坛</span></a></p></li>
<li><p>增加支持指数回测</p></li>
<li><p>支持 <cite>with TqApi() as api</cite> 写法</p></li>
<li><p>quote 对象增加 exchange_id 字段，表示交易所代码</p></li>
<li><p>重构 sim 模块代码，便于接入新版行情服务器</p></li>
<li><p>修复 settargetpos 回测时，在一个交易时段内最后一根 K 线下单无法成交的 bug</p></li>
<li><p>修复回测时某些品种夜盘无法交易的 bug</p></li>
<li><p>修复 ticksinfo 函数在 pandas 版本低于 1.0.0 无法正常使用的 bug</p></li>
<li><p>优化日志输出，实盘下默认启用日志</p></li>
<li><p>更新 logo，整理优化文档，增加股票行情、主连获取主力等文档说明，优化示例代码目录结构</p></li>
<li><p>修改、优化测试用例及 CI 流程</p></li>
</ul>
<p>1.8.0 (2020/05/12)</p>
<ul class="simple">
<li><p>股票行情测试版发布，<strong>_stock 参数设置为 True 可以连接测试行情服务器，提供股票数据</strong> <a class="reference external" href="https://www.shinnytech.com/blog/%e5%a4%a9%e5%8b%a4%e9%87%8f%e5%8c%961-8-0_beta%ef%bc%8c%e6%94%af%e6%8c%81%e8%82%a1%e7%a5%a8%e8%a1%8c%e6%83%85%e8%8e%b7%e5%8f%96%ef%bc%81/">详细说明请点击查看</a></p></li>
<li><p>增加计算 ticks 开平方向函数(详见: <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_ticks_info()</span></code> )</p></li>
<li><p>修复 sim 撤单未检查单号是否可撤</p></li>
<li><p>重构代码，优化模块划分</p></li>
<li><p>修改测试脚本和测试用例，提高持续集成效率</p></li>
</ul>
<p>1.7.0 (2020/04/16)</p>
<ul class="simple">
<li><p><strong>支持期权模拟交易，支持期权回测</strong></p></li>
<li><p>增加期权指标的计算公式 (希腊值、隐含波动率、理论价等)</p></li>
<li><p>增加TqSim模拟交易成交时间判断 (非交易时间段下的委托单将被判定为错单，以减小模拟帐号与实盘的差距)</p></li>
<li><p>增加账户、持仓中的市值字段 (如果交易了期权，则模拟帐号的账户、持仓字段的定义有一些改变(详见: <code class="xref py py-class docutils literal notranslate"><span class="pre">tqsdk.objs.Account</span></code> ))</p></li>
<li><p>修复一个可能导致复盘连接失败的问题</p></li>
<li><p>优化示例代码</p></li>
<li><p>优化文档 (增加 <a class="reference internal" href="index.html#option-trade"><span class="std std-ref">期权交易 &amp; 交易所官方组合</span></a> 文档内容、增加在 <a class="reference internal" href="index.html#unanttended"><span class="std std-ref">在无人监控环境下执行策略</span></a> 教程内容、优化文档其他细节）</p></li>
</ul>
<p>1.6.3 (2020/03/16)</p>
<ul class="simple">
<li><p>修复vscode 插件中不能登录交易的bug</p></li>
<li><p>增加免责声明</p></li>
<li><p>增加、完善测试用例</p></li>
<li><p>修改文档</p></li>
</ul>
<p>1.6.2 (2020/02/18)</p>
<ul class="simple">
<li><p>修改 web_gui 默认显示的 ip 地址为 127.0.0.1</p></li>
<li><p>修复 web_gui 不显示成交记录箭头的问题</p></li>
<li><p>策略结束后 api 将关闭所有 web 链接</p></li>
<li><p>优化对 vscode 的支持</p></li>
<li><p>增加 Quote 的 option_class (期权方向)和 product_id (品种代码)字段</p></li>
<li><p>优化文档</p></li>
</ul>
<p>1.6.1 (2020/02/12)</p>
<ul class="simple">
<li><p>修复 web_gui 不显示成交记录的问题</p></li>
<li><p>修复 python3.8 下设置 web_gui 参数无效的问题</p></li>
</ul>
<p>1.6.0 (2020/02/11)</p>
<ul class="simple">
<li><p>交易网关升级, <strong>所有用户需升级至 1.6.0 版本以上</strong></p></li>
<li><p>修复参数搜索时由于 TargetPosTask 单实例造成的内存泄漏</p></li>
<li><p>web_gui 参数格式改成 [ip]:port, 允许公网访问</p></li>
<li><p>改进 web 界面，增加分时图，优化盘口显示内容，修复相关问题</p></li>
<li><p>修改 barlast() 的返回值为 pandas.Series 类型序列</p></li>
<li><p>优化回测的成交时间准确性</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.5.1 (2020/01/13)</p>
<ul class="simple">
<li><p>优化 TqApi 参数 web_gui, 允许指定网页地址和端口(详见: <a class="reference internal" href="index.html#web-gui"><span class="std std-ref">策略程序图形化界面</span></a> )</p></li>
<li><p>更新优化 vscode 插件以及web 页面</p></li>
<li><p>简化画图函数color的参数</p></li>
<li><p>增加 barlast 功能函数(详见: <code class="xref py py-meth docutils literal notranslate"><span class="pre">barlast()</span></code> )</p></li>
<li><p>优化多合约k线报错提示及示例</p></li>
<li><p>修复 TargetPosTask 进行参数搜索时无法正确执行的bug</p></li>
<li><p>修复可能触发的回测结果计算报错的问题</p></li>
<li><p>增加测试用例</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.5.0 (2020/01/06)</p>
<ul class="simple">
<li><p>支持股票上线准备，增加天勤用户认证</p></li>
<li><p>TqSim 的 trade_log 改为公开变量</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.4.0 (2019/12/25)</p>
<ul class="simple">
<li><p>在 TqSdk 中直接支持复盘功能(详见: <a class="reference internal" href="index.html#replay"><span class="std std-ref">策略程序复盘</span></a> )</p></li>
<li><p>增加回测报告内容(胜率、每手盈亏额比例)</p></li>
<li><p>从当前版本开始，不再支持天勤终端合约代码图形显示</p></li>
<li><p>修复 web_gui 功能中的部分已知问题</p></li>
<li><p>修复在一些情况无法输出回测报告的问题</p></li>
<li><p>修复使用 slave/master 多线程模式时的报错问题</p></li>
<li><p>修复回测结束前最后一条行情未更新的bug</p></li>
<li><p>从 logger 中分离从服务器返回的通知信息(以便单独处理或屏蔽)</p></li>
<li><p>修复使用 TargetPoseTask 实例时可能引发的报错</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.3.2 (2019/12/19)</p>
<ul class="simple">
<li><p>修复在填写了画图的 color 参数时引起的报错</p></li>
<li><p>修复在 vscode 插件和天勤终端中不能运行策略的bug</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.3.1 (2019/12/18)</p>
<ul class="simple">
<li><p>支持通过 <code class="xref py py-class docutils literal notranslate"><span class="pre">tqsdk.TqApi</span></code> 内 <strong>设置 web_gui=True 参数以实现实盘/回测的图像化支持</strong> , (详见: <a class="reference internal" href="index.html#web-gui"><span class="std std-ref">策略程序图形化界面</span></a> )</p></li>
<li><p>增加支持 Python3.8</p></li>
<li><p>完善 TqSdk 各公开函数的参数类型标注及函数返回值类型标注</p></li>
<li><p>将 api 中除业务数据以外的所有变量私有化</p></li>
<li><p>完善测试用例</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.2.1 (2019/12/04)</p>
<ul class="simple">
<li><p>完善 insert_order() 函数返回的 order 的初始化字段：增加 limit_price、price_type、volume_condition、time_condition 字段</p></li>
<li><p>增加 quote 行情数据中的 trading_time、expire_datetime、delivery_month、delivery_year、ins_class 字段</p></li>
<li><p>删除 quote 行情数据中的 change、change_percent 字段</p></li>
<li><p>修复重复发送K线订阅指令给服务器的bug</p></li>
<li><p>修复未订阅行情时回测不能立即结束的bug</p></li>
<li><p>完善测试用例</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.2.0 (2019/11/21)</p>
<ul class="simple">
<li><p>支持同时获取对齐的多合约 K 线 (详见 <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_kline_serial()</span></code> )</p></li>
<li><p>修复回测时未将非 TqSim 账号转换为 TqSim 的 bug</p></li>
<li><p>修复 wait_update() 填写 deadline 参数并等待超时后向服务器发送大量消息</p></li>
<li><p>完善测试用例</p></li>
<li><p>完善示例程序</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.1.0 (2019/10/15)</p>
<ul class="simple">
<li><p>增加时间类型转换的功能函数 (详见 <code class="xref py py-meth docutils literal notranslate"><span class="pre">tafunc()</span></code> )</p></li>
<li><p>修复与天勤连接时的一些bug</p></li>
<li><p>完善测试用例及测试环境配置</p></li>
<li><p>修改回测log内容,去除回测时log中的当前本地时间</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>1.0.0 (2019/09/19)</p>
<ul class="simple">
<li><p>修复: 各id生成方式</p></li>
<li><p>修复: 重复输出日志</p></li>
<li><p>修复: 命令行运行策略文件时,复盘模式下的参数返回值</p></li>
<li><p>添加持续集成功能</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>0.9.18 (2019/09/11)</p>
<ul class="simple">
<li><p>修复: 断线重连时触发的一系列bug</p></li>
<li><p>修复: register_update_notify 以 klines 作为参数输入时报错的bug</p></li>
<li><p>修复: 因不能删除业务数据导致的内存泄漏bug</p></li>
<li><p>部分修复: diff中的数据不是dict类型导致的bug</p></li>
<li><p>增加gui相关示例程序及文档</p></li>
<li><p>增加单元测试用例</p></li>
<li><p>完善文档内容</p></li>
</ul>
<p>0.9.17 (2019/08/27)</p>
<ul class="simple">
<li><p>修复: TqApi.copy()创建slave实例时工作不正常的bug</p></li>
<li><p>改进行情订阅信息同步到天勤的机制</p></li>
<li><p>改进TqSdk运行错误传递给天勤的机制</p></li>
<li><p>将TqApi的私有成员名字前加前缀下划线</p></li>
<li><p>增加各公开函数的返回值类型标注</p></li>
<li><p>支持使用email地址作为模拟交易账号</p></li>
<li><p>增强TargetPosTask及指标函数等内容的说明文档</p></li>
</ul>
<p>0.9.15 (2019/08/14)</p>
<ul class="simple">
<li><p>调整tqsdk与天勤的连接机制</p></li>
<li><p>去除get_order()及get_position()等函数的返回值中与业务无关的&quot;_path&quot;, &quot;_listener&quot; 数据, 使其只返回业务数据</p></li>
<li><p>添加对公开函数输入值类型及范围的检查</p></li>
</ul>
<p>0.9.9 (2019/07/22)</p>
<ul class="simple">
<li><p>持仓对象 <code class="xref py py-class docutils literal notranslate"><span class="pre">Position</span></code> 增加了实时持仓手数属性 pos_long_his, pos_long_today, pos_short_his, pos_short_today ，这些属性在成交时与成交记录同步更新</p></li>
<li><p>修正 <code class="xref py py-class docutils literal notranslate"><span class="pre">TargetPosTask</span></code> 因为持仓手数更新不同步导致下单手数错误的bug</p></li>
<li><p>取消交易单元机制</p></li>
</ul>
<p>0.9.8 (2019/06/17):</p>
<ul class="simple">
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">TqApi</span></code> 增加 copy 函数，支持在一个进程中用master/slave模式创建多个TqApi实例</p></li>
</ul>
<p>0.9.7 (2019/06/03):</p>
<ul class="simple">
<li><p>修正持仓数据不能 copy() 的问题</p></li>
</ul>
<p>0.9.6 (2019/05/30):</p>
<ul class="simple">
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Quote</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">Account</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">Position</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">Order</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">Trade</span></code> 的成员变量名在IDE中支持自动补全(Pycharm测试可用)</p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Order</span></code> 增加了 <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_dead()</span></code> 属性 - 用于判定委托单是否确定已死亡（以后一定不会再产生成交）</p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Order</span></code> 增加了 <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_online()</span></code> 属性 - 用于判定这个委托单是否确定已报入交易所（即下单成功，无论是否成交）</p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Order</span></code> 增加了 <code class="xref py py-meth docutils literal notranslate"><span class="pre">is_error()</span></code> 属性 - 用于判定这个委托单是否确定是错单（即下单失败，一定不会有成交）</p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Order</span></code> 增加了 <code class="xref py py-meth docutils literal notranslate"><span class="pre">trade_price()</span></code> 属性 - 委托单的平均成交价</p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Order</span></code> 增加了 <code class="xref py py-meth docutils literal notranslate"><span class="pre">trade_records()</span></code> 属性 - 委托单的成交记录</p></li>
<li><p>文档细节修正</p></li>
</ul>
<p>0.9.5 (2019/05/24):</p>
<ul class="simple">
<li><p>加入期货公司次席支持, 创建 TqAccount 时可以通过 front_broker 和 front_url 参数指定次席服务器</p></li>
</ul>
<p>0.9.4 (2019/05/22):</p>
<ul class="simple">
<li><p>修正穿透式监管采集信息编码问题</p></li>
</ul>
<p>0.9.3 (2019/05/22):</p>
<ul class="simple">
<li><p>(BREAKING) 模拟交易默认资金调整为一千万</p></li>
<li><p>加入穿透式监管支持. 用户只需升级 TqSdk 到此版本, 无需向期货公司申请AppId, 即可满足穿透式监管信息采集规范要求.</p></li>
</ul>
<p>0.9.2 (2019/05/07):</p>
<ul class="simple">
<li><p>修正画图相关函数</p></li>
</ul>
<p>0.9.1 (2019/04/15):</p>
<ul class="simple">
<li><p>(BREAKING) TqApi.get_quote, get_kline_serial, get_account 等函数, 现在调用时会等待初始数据到位后才返回</p></li>
<li><p>(BREAKING) k线序列和tick序列格式改用pandas.DataFrame</p></li>
<li><p>支持上期所五档行情</p></li>
<li><p>增加 数十个技术指标 和 序列计算函数, 使用纯python实现. 加入ta和ta_func库</p></li>
<li><p>加入策略单元支持. 在一个账户下运行多个策略时, 可以实现仓位, 报单的相互隔离</p></li>
<li><p>加强与天勤终端的协作，支持策略程序在天勤中画图, 支持回测结果图形化显示与分析, 支持策略运行监控和手工下单干预</p></li>
<li><p>示例程序增加随机森林(random_forest)策略</p></li>
<li><p>示例程序增加菲阿里四价策略</p></li>
</ul>
<p>0.8.9 (2019/01/21):</p>
<ul class="simple">
<li><p>加入双均线策略</p></li>
<li><p>加入网格交易策略</p></li>
<li><p>数据下载器支持按交易日下载数据</p></li>
<li><p>修正模拟交易数据不正确的问题</p></li>
<li><p>修正回测时出现“平仓手数不足&quot;的问题</p></li>
</ul>
<p>2018/12/12:</p>
<ul class="simple">
<li><p>加入直连行情交易服务器模式</p></li>
<li><p>模拟交易结束后输出交易报告</p></li>
<li><p>修正回测时账户资金计算错误的问题</p></li>
</ul>
<p>2018/11/16:</p>
<ul class="simple">
<li><p>加入策略回测功能</p></li>
</ul>
<p>2018/10/25:</p>
<ul class="simple">
<li><p>加入海龟策略</p></li>
</ul>
<p>2018/10/17:</p>
<ul class="simple">
<li><p>加入 dual thrust 策略</p></li>
<li><p>加入 r-breaker 策略</p></li>
</ul>
<p>2018/08/30:</p>
<ul class="simple">
<li><p>目标持仓模型(TargetPosTask)支持上期所的平今平昨和中金所禁止平今</p></li>
<li><p>K线/Tick序列加入 to_dataframe 函数将数据转为 pandas.DataFrame</p></li>
<li><p>加入 close 函数用于退出时清理各种资源</p></li>
<li><p>wait_update 由设定超时秒数改为设定截止时间, 并返回是否超时</p></li>
<li><p>加入调试模式，将调试信息写入指定的文件中</p></li>
<li><p>修正和某些开发环境不兼容的问题</p></li>
<li><p>规范了各业务数据的类型</p></li>
<li><p>register_update_notify 支持监控特定的业务数据</p></li>
</ul>
<p>2018/08/10:</p>
<ul class="simple">
<li><p>目标持仓Task自动处理上期所平今/平昨</p></li>
<li><p>主力合约加入 underlying_symbol 字段用来获取标的合约</p></li>
<li><p>更新文档</p></li>
</ul>
</section>
</div>
</section>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2023, TianQin
      
        <span class="commit">
          Revision <code>596dada7</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/stable/">stable</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//tqsdk-python.readthedocs.io/_/downloads/en/latest/pdf/">pdf</a></dd>
        
          <dd><a href="//tqsdk-python.readthedocs.io/_/downloads/en/latest/htmlzip/">html</a></dd>
        
          <dd><a href="//tqsdk-python.readthedocs.io/_/downloads/en/latest/epub/">epub</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/tqsdk-python/?fromdocs=tqsdk-python">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/tqsdk-python/?fromdocs=tqsdk-python">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>